


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unit test a contract in Rust &#8212; Concordium  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/tippy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script loading_method="defer" src="https://unpkg.com/@popperjs/core@2"></script>
    <script loading_method="defer" src="https://unpkg.com/tippy.js@6"></script>
    <script loading_method="defer" src="../../_static/tippy/smart-contracts/guides/unit-test-contract.7d8726e2-6450-46fb-9fdc-a2c271bf7440.js"></script>
    <link rel="shortcut icon" href="../../_static/concordium-logo-no-text.svg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" />

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    <style>
.navbar-brand img {
    max-height: 200px;
    width: auto;
}
</style>

<div>
    <a href="https://developer.concordium.software/">
        <img class="logo" src="../../_static/concordium-logo-dark.svg" />
    </a>
</div>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class=" collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <style>
body {margin:0;}

.navbar-menu {
  position: relative;
  margin-left: 190px;
  background: none;
}

.navbar-light {
    background: #ededed!important;
    box-shadow: none;
}

.navbar-menu a {
  float: left;
  display: inline;
  text-align: center;
  color: var(--font-color);
  font-size: 15px;
}

/* Dropdown Button */
.dropbtn {
  background: none;
  color: black;
  font-size: 16px;
  font-weight: 600;
  padding-left: 20px;
  padding-right: 20px;
  border: none;
  font-family: inherit; /* Important for vertical align on mobile phones */
  margin: 0; /* Important for vertical align on mobile phones */
}

/* The dropdown container */
.dropdown {
    float: left;
  }

  /* Dropdown content (hidden by default) */
  .dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
  }

  /* Links inside the dropdown */
  .dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  /* Show the dropdown menu on hover */
  .dropdown:hover .dropdown-content {
    display: block;
  }

/* Large devices (laptops/desktops, 992px to 768px ) */
@media only screen and (max-width: 1178px) {
  .navbar-menu {
    display: none;}

}
</style>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/Concordium" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="mailto:support@concordium.software" rel="noopener" target="_blank" title="Support"><span><i class="fas fa-envelope"></i></span>
            <label class="sr-only">Support</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://developer.concordium.software/en/mainnet/net/guides/developer-page.html#block-explorers" rel="noopener" target="_blank" title="Monitor"><span><i class="fas fa-chart-line"></i></span>
            <label class="sr-only">Monitor</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://support.concordium.software/latest" rel="noopener" target="_blank" title="Discourse"><span><i class="fab fa-discourse"></i></span>
            <label class="sr-only">Discourse</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://www.youtube.com/channel/UCPZc2CuB2jGbZjD_5zX7-1A" rel="noopener" target="_blank" title="YouTube"><span><i class="fab fa-youtube"></i></span>
            <label class="sr-only">YouTube</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://medium.com/concordium" rel="noopener" target="_blank" title="Medium"><span><i class="fab fa-medium"></i></span>
            <label class="sr-only">Medium</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://academy.concordium.software/ccd-academy/getting-started" rel="noopener" target="_blank" title="Academy"><span><i class="fas fa-graduation-cap"></i></span>
            <label class="sr-only">Academy</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-tests-in-wasm">
   Running tests in Wasm
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-unit-tests">
   Writing unit tests
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-contract-invocations-with-mocks">
   Testing contract invocations with mocks
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reentrancy">
     Reentrancy
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-with-state-rollbacks">
   Testing with state rollbacks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-transfers">
   Testing transfers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-property-based-tests">
   Writing property-based tests
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example">
     Example
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/Concordium/concordium.github.io/edit/main/source/mainnet/smart-contracts/guides/unit-test-contract.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="unit-test-a-contract-in-rust">
<span id="unit-test-contract"></span><h1>Unit test a contract in Rust<a class="headerlink" href="#unit-test-a-contract-in-rust" title="Permalink to this headline">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Unit testing your contracts with the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> has been deprecated in favor of <a class="reference external" href="https://docs.rs/concordium-std-derive/latest/concordium_smart-contract-testing"><code class="docutils literal notranslate"><span class="pre">concordium-smart-contract-testing</span></code></a>.
To migrate your contracts and tests see <a class="reference internal" href="migrate-contracts.html#migrate-contracts-for-std-8-1"><span class="std std-ref">Migrate contracts for concordium-std 8.1</span></a> and <a class="reference internal" href="integration-test-contract.html#integration-test-contract"><span class="std std-ref">Integration test a contract in Rust</span></a>.</p>
<p>If you are not ready to migrate your contracts, you can still use the guide below.
Just make sure to add an <code class="docutils literal notranslate"><span class="pre">#[allow(deprecated)]</span></code> attribute above your test module to avoid warnings:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[allow(deprecated)]</span>
<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>This guide describes how to write unit tests for a smart contract written in
Rust.
For information about how to test a smart contract Wasm module, see <a class="reference internal" href="local-simulate.html#local-simulate"><span class="std std-ref">Locally simulate contract functions</span></a>.</p>
<p>A smart contract in Rust is written as a library and you can unit test it like a
library by annotating functions with a <code class="docutils literal notranslate"><span class="pre">#[test]</span></code> attribute.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// contract code</span>
<span class="o">..</span><span class="p">.</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">another_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">cargo</span></code> to run the test:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>By default, this command compiles the contract and tests to machine code for
your local target (most likely <code class="docutils literal notranslate"><span class="pre">x86_64</span></code>), and runs them.
This kind of testing can be useful in initial development and for testing
functional correctness.
For comprehensive testing, it is important to involve the target platform, i.e.,
<cite>Wasm32</cite>.</p>
<div class="section" id="running-tests-in-wasm">
<span id="tests-in-wasm"></span><h2>Running tests in Wasm<a class="headerlink" href="#running-tests-in-wasm" title="Permalink to this headline">#</a></h2>
<p>Compiling the tests to native machine code is sufficient for most cases, but it
is also possible to compile the tests to Wasm and run them using the exact
interpreter that is used by the nodes.
This makes the test environment closer to the run environment on-chain and could,
in some cases, catch more bugs.
One notable difference between different environments is regarding the size of
pointers, where <cite>Wasm32</cite> uses four bytes as opposed to eight, which is common
for most platforms.</p>
<p>The development tool <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code> includes a test runner for Wasm, which
uses the same Wasm-interpreter as the one shipped in the Concordium nodes.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For instructions about how to install <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>, see <a class="reference internal" href="setup-tools.html#setup-tools"><span class="std std-ref">Install tools for development</span></a>.</p>
</div>
<p>The unit test has to be annotated with <code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">#[test]</span></code>, and <code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code> is used instead of <code class="docutils literal notranslate"><span class="pre">#[cfg(test)]</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// contract code</span>
<span class="o">..</span><span class="p">.</span>

<span class="cp">#[concordium_cfg_test]</span>
<span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cp">#[concordium_test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[concordium_test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">another_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code> macro sets up your tests to be run in Wasm when
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> is compiled with the <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> feature. Otherwise, it
falls back to behave just like <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>, meaning it is still possible to run
unit tests targeting native code using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>.</p>
<p>Similarly, the macro <code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code> includes your module when build
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> with <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> otherwise behaves like <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>,
allowing you to control when to include tests in the build.</p>
<p>Tests can now be built and run using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>This command compiles the tests for Wasm with the <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> feature enabled
for <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> and uses the test runner from <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Error messages from <code class="docutils literal notranslate"><span class="pre">panic!</span></code>, and therefore also the different variations
of <code class="docutils literal notranslate"><span class="pre">assert!</span></code>, are <em>not</em> shown when compiling to Wasm.</p>
<p>Instead, use <code class="docutils literal notranslate"><span class="pre">fail!</span></code> and the <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants to do assertions when
testing, as these reports back the error messages to the test runner <em>before</em>
failing the test.
Both are part of <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code>.</p>
<p>The remainder of this guide will use the <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants for assertions.</p>
</div>
</div>
<div class="section" id="writing-unit-tests">
<h2>Writing unit tests<a class="headerlink" href="#writing-unit-tests" title="Permalink to this headline">#</a></h2>
<p>Unit tests typically follow a three-part structure in which you: set up some
state, run some unit of code, and make assertions about the state and output of
the code.</p>
<p>If the contract functions are written using <code class="docutils literal notranslate"><span class="pre">#[init(..)]</span></code> or
<code class="docutils literal notranslate"><span class="pre">#[receive(..)]</span></code>, you can test these functions directly in the unit test.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="o">*</span><span class="p">;</span>

<span class="cp">#[init(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">)]</span>
<span class="k">fn</span> <span class="nf">contract_init</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">   </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasInitContext</span><span class="p">,</span>
<span class="w">   </span><span class="n">state_builder</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">StateBuilder</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">InitResult</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;my_receive&quot;</span><span class="cp">)]</span>
<span class="k">fn</span> <span class="nf">contract_receive</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">   </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">   </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">MyReturnValue</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_init_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create a test context.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestInitContext</span>::<span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Set the fields that your init method accesses.</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_init_origin</span><span class="p">(</span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]));</span>
<span class="w">        </span><span class="c1">// Create a test state builder.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestStateBuilder</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Call the init method.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contract_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state_builder</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert properties.</span>
<span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">State</span>::<span class="n">new</span><span class="p">()));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_receive_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create a test context.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span>::<span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Set the fields that your receive method accesses.</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_address</span><span class="p">(</span><span class="n">ContractAddress</span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">subindex</span>: <span class="mi">0</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="c1">// Create a test host with state.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span>::<span class="n">new</span><span class="p">(</span><span class="n">State</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span>::<span class="n">new</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// Call the receive method.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contract_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">host</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Make assertions.</span>
<span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">MyReturnValue</span>::<span class="n">new</span><span class="p">()));</span>
<span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">get_transfers</span><span class="p">(),</span><span class="w"> </span><span class="p">[]);</span><span class="w"> </span><span class="c1">// No transfers occured.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The submodule <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> of <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std"><code class="docutils literal notranslate"><span class="pre">concordium_std</span></code></a> contains a number of
test stubs, including the ones shown in the example, e.g., <code class="docutils literal notranslate"><span class="pre">TestHost</span></code> and <code class="docutils literal notranslate"><span class="pre">TestInitContext</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more information and examples, see the crate documentation of
<a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std"><code class="docutils literal notranslate"><span class="pre">concordium_std</span></code></a>.</p>
</div>
</div>
<div class="section" id="testing-contract-invocations-with-mocks">
<span id="testing-contract-invocations"></span><h2>Testing contract invocations with mocks<a class="headerlink" href="#testing-contract-invocations-with-mocks" title="Permalink to this headline">#</a></h2>
<p>To test receive methods that invoke contracts with
<code class="docutils literal notranslate"><span class="pre">host.invoke_contract(...)</span></code>, you should set up mocking functions that act as
the invoked contract. The <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> has a number of helpers for
mocking contracts.</p>
<p>To set up a mock entrypoint, use the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.setup_mock_entrypoint"><code class="docutils literal notranslate"><span class="pre">setup_mock_entrypoint</span></code></a> method from <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html"><code class="docutils literal notranslate"><span class="pre">TestHost</span></code></a>.
It expects a <code class="docutils literal notranslate"><span class="pre">ContractAddress</span></code> and an <code class="docutils literal notranslate"><span class="pre">OwnedEntrypointName</span></code> to specify which
entrypoint on which contract you are mocking.
It also expects a <code class="docutils literal notranslate"><span class="pre">MockFn</span></code>, which you can create in several different ways.</p>
<p>The simplest way to create a <code class="docutils literal notranslate"><span class="pre">MockFn</span></code> is with <code class="docutils literal notranslate"><span class="pre">returning_ok</span></code>, which creates
a mock function that returns the same <code class="docutils literal notranslate"><span class="pre">Ok(..)</span></code> value every time:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// Contract code + general test setup</span>

<span class="cp">#[test]</span>
<span class="k">fn</span> <span class="nf">mock_test_return_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span>::<span class="n">new</span><span class="p">(</span><span class="n">State</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span>::<span class="n">new</span><span class="p">());</span>

<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span>:    <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span>::<span class="n">returning_ok</span><span class="p">(</span><span class="mi">42</span><span class="k">u8</span><span class="p">),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For returning the same error every time, use the <code class="docutils literal notranslate"><span class="pre">returning_err</span></code>.
Use this to test missing contracts or entrypoints, as invoking
entrypoints for which no mock has been set up results in a runtime error:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span>:    <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span>::<span class="n">returning_err</span>::<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallContractError</span>::<span class="n">MissingContract</span><span class="p">),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">returning_err</span></code> method is generic because
<code class="docutils literal notranslate"><span class="pre">CallContractError&lt;ReturnValueType&gt;</span></code> is generic and can return a value
with its logic error:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span>:    <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span>::<span class="n">returning_err</span>::<span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallContractError</span>::<span class="n">LogicReject</span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">reason</span>: <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">return_value</span>: <span class="s">&quot;Something went wrong!&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()}),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
</div>
<p>For more advanced types of mocks, use the functions <code class="docutils literal notranslate"><span class="pre">MockFn::new_v1</span></code>, <code class="docutils literal notranslate"><span class="pre">MockFn::new_v0</span></code>, or
<code class="docutils literal notranslate"><span class="pre">MockFn::new</span></code>.
Each of these functions takes a closure that has access to the parameter and amount
used in <code class="docutils literal notranslate"><span class="pre">invoke_contract(parameter,</span> <span class="pre">amount,</span> <span class="pre">..)</span></code>, but also the balance and
state of the contract you are testing.
The methods differ in what the closure should return.
V0 contracts do not have a return value, whereas V1 contracts always do.</p>
<p>Here is an example of a mocked entrypoint that only uses the parameter
and amount. For simplicity, it just traps if the input is not as expected:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span>::<span class="n">new</span><span class="p">(</span><span class="n">State</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span>::<span class="n">new</span><span class="p">());</span>

<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span>:    <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span>::<span class="n">new_v1</span><span class="p">(</span><span class="o">|</span><span class="n">parameter</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">_balance</span><span class="p">,</span><span class="w"> </span><span class="n">_state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">from_bytes</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                 </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">n</span><span class="p">,</span>
</span><span class="hll"><span class="w">                 </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">CallContractError</span>::<span class="n">Trap</span><span class="p">),</span>
</span><span class="hll"><span class="w">            </span><span class="p">};</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">amount</span><span class="p">.</span><span class="n">micro_ccd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">CallContractError</span>::<span class="n">Trap</span><span class="p">),</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">state_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mock did not modify the state.</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="nb">Ok</span><span class="p">((</span><span class="n">state_modified</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
</span><span class="hll"><span class="w">        </span><span class="p">}),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<p>To test a contract that invokes itself, either directly or indirectly (e.g., <code class="docutils literal notranslate"><span class="pre">A</span></code> calls
<code class="docutils literal notranslate"><span class="pre">B</span></code> which then calls <code class="docutils literal notranslate"><span class="pre">A</span></code>, or with even more indirections), use the
state and balance fields:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span>::<span class="n">empty</span><span class="p">();</span>
</span><span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">self_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">index</span>:    <span class="mi">0</span><span class="p">,</span>
</span><span class="hll"><span class="w">        </span><span class="n">subindex</span>: <span class="mi">0</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="p">};</span>
</span><span class="hll"><span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_address</span><span class="p">(</span><span class="n">self_address</span><span class="p">);</span>
</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span>::<span class="n">new</span><span class="p">(</span><span class="n">State</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span>::<span class="n">new</span><span class="p">());</span>

<span class="hll"><span class="w">    </span><span class="c1">// Meant to mock calls to the contract itself, where amounts sent</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// don&#39;t leave the contract and each call increments a counter.</span>
</span><span class="hll"><span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
</span><span class="hll"><span class="w">        </span><span class="n">self_address</span><span class="p">,</span>
</span><span class="hll"><span class="w">        </span><span class="n">OwnedEntrypointName</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;self_receive&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
</span><span class="hll"><span class="w">        </span><span class="n">MockFn</span>::<span class="n">new_v1</span><span class="p">(</span><span class="o">|</span><span class="n">_parameter</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="o">*</span><span class="n">balance</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="n">counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">state_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mock _did_ modify the state.</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="nb">Ok</span><span class="p">((</span><span class="n">state_modified</span><span class="p">,</span><span class="w"> </span><span class="p">()))</span>
</span><span class="hll"><span class="w">        </span><span class="p">}),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<div class="section" id="reentrancy">
<span id="reentracny-unit-testing"></span><h3>Reentrancy<a class="headerlink" href="#reentrancy" title="Permalink to this headline">#</a></h3>
<p>When invoking another smart contract, you give away control to that contract in the middle of execution.
The external contract can, for example, call back entrypoints of your contract.
This behavior is called <em>reentrancy</em> and is well-known from concurrency: a procedure can be interrupted in the middle of its execution, called again, and then resume execution.
See the details about handling external calls and ways of protecting against reentrancy-related issues in the <a class="reference internal" href="../best-practices/development.html#best-practices-external-calls"><span class="std std-ref">development best practices</span></a>.</p>
<p>The state of your contract might not be the same before and after <code class="docutils literal notranslate"><span class="pre">invoke_contract</span></code>, since the contract you call can invoke any entrypoint of your own contract.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">state_copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">();</span>
<span class="n">host</span><span class="p">.</span><span class="n">invoke_contract</span><span class="p">(</span><span class="o">..</span><span class="p">.);</span>

<span class="c1">// *host.state() and state_copy might not be equal any more due to reentrancy.</span>
<span class="n">do_something_with</span><span class="p">(</span><span class="n">state_copy</span><span class="p">);</span>
</pre></div>
</div>
<p>Consider a concrete example of reentrancy when the state is <em>not</em> updated properly before making an external call.
This can lead to reentrant calls that pass some validation that is based on the current state, even though these calls should fail.
The classic example of such a security issue is <a class="reference external" href="https://en.wikipedia.org/wiki/The_DAO_(organization)">the DAO</a> Ethereum smart contract that was drained of funds due to the reentrancy vulnerability.
Below is a code snippet that implements a small part similar to the DAO contract that stores balances for arbitrary addresses in a map <code class="docutils literal notranslate"><span class="pre">StateMap&lt;Address,</span> <span class="pre">Amount,</span> <span class="pre">S&gt;</span></code>.
The users can request their funds back; if a user is a smart contract, the funds are sent to a specified entrypoint.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(</span>
<span class="cp">    contract = </span><span class="s">&quot;reentrancy&quot;</span><span class="cp">,</span>
<span class="cp">    name = </span><span class="s">&quot;withdraw_reentrancy&quot;</span><span class="cp">,</span>
<span class="cp">    parameter = </span><span class="s">&quot;OwnedEntrypointName&quot;</span><span class="cp">,</span>
<span class="cp">    error = </span><span class="s">&quot;Error&quot;</span><span class="cp">,</span>
<span class="cp">    mutable</span>
<span class="cp">)]</span>
<span class="k">fn</span> <span class="nf">withdraw_reentrancy</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sender</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Get balance for the sender, or reject if the sender is not found or the</span>
<span class="w">    </span><span class="c1">// balance is zero.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">().</span><span class="n">balances</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">bal</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">bal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">zero</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">bal</span><span class="p">,</span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">WithdrawWithoutFunds</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">invoke_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">sender_balance</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="n">Address</span>::<span class="n">Contract</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">entrypoint</span>: <span class="nc">OwnedEntrypointName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">parameter_cursor</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// At this point we are handing out the control out to an unknown</span>
<span class="w">            </span><span class="c1">// smart contract. This contract can call this entry point</span>
<span class="w">            </span><span class="c1">// again multiple times before the rest of the code is reached.</span>
<span class="w">            </span><span class="n">host</span><span class="p">.</span><span class="n">invoke_contract</span><span class="p">(</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">Parameter</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]),</span>
<span class="w">                </span><span class="n">entrypoint</span><span class="p">.</span><span class="n">as_entrypoint_name</span><span class="p">(),</span>
<span class="w">                </span><span class="n">sender_balance</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Reset the sender&#39;s balance to zero.</span>
<span class="w">    </span><span class="c1">// This code is reached only after transfering CCD back/calling an</span>
<span class="w">    </span><span class="c1">// external contract.</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">().</span><span class="n">balances</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">zero</span><span class="p">();</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The problem in the code above is that resetting the sender’s balance to zero happens <em>after</em> the call to an external contract is completed.
The sender’s balance in the <em>contract state</em> is used to determine how much funds should be transferred to the sender.
Since it is not updated, the external contract can make a call back to <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> and pass the balance validation.
Testing this behavior with mocks require some insights.
In particular, the example below mimics the original <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> code in the mock entrypoint.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[concordium_test]</span>
<span class="k">fn</span> <span class="nf">test_withdraw_reentrancy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>

<span class="w">    </span><span class="c1">// Assume that `CONTRACT_ADDRESS` has 1 micro CCD</span>
<span class="w">    </span><span class="c1">// Set the contract balance to 2 micro CCD</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">Amount</span>::<span class="n">from_micro_ccd</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Set up a mock entrypoint that calls back to our contract.</span>
<span class="w">    </span><span class="c1">// The mock emulates the `withdraw_reentrancy` logic to model</span>
<span class="w">    </span><span class="c1">// a reentrancy attack that will withdraw the sender&#39;s balance twice.</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">CONTRACT_ADDRESS</span><span class="p">,</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;withdraw_reentrancy&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">        </span><span class="n">MockFn</span>::<span class="n">new_v1</span><span class="p">(</span><span class="o">|</span><span class="n">_parameter</span><span class="p">,</span><span class="w"> </span><span class="n">_amount</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// `invoke_contract` cannot be called inside this mock, but</span>
<span class="w">            </span><span class="c1">// `balance` gives access to the balance of the contract making</span>
<span class="w">            </span><span class="c1">// this invocation. The `withdraw_reentrancy` invocation can be</span>
<span class="w">            </span><span class="c1">// simulated by subtracting the sender&#39;s amount stored in the</span>
<span class="w">            </span><span class="c1">// contract state from `balance`.</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Address</span>::<span class="n">Contract</span><span class="p">(</span><span class="n">CONTRACT_ADDRESS</span><span class="p">));</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sender_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">bal</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">bal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">zero</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bal</span><span class="p">,</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">fail</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Insufficent funds&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="c1">// Emulate withdraw by subtracting the sender&#39;s balance.</span>
<span class="w">            </span><span class="o">*</span><span class="n">balance</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="o">*</span><span class="n">sender_balance</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Reset the sender&#39;s balance to zero.</span>
<span class="w">            </span><span class="o">*</span><span class="n">sender_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">zero</span><span class="p">();</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">state_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">((</span><span class="n">state_modified</span><span class="p">,</span><span class="w"> </span><span class="p">()))</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Withdraw 1 micro CCD</span>
<span class="w">    </span><span class="n">withdraw_reentrancy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="p">).</span><span class="n">expect_report</span><span class="p">(</span><span class="s">&quot;Withdraw call failed&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">resulting_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">self_balance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">expected_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">resulting_balance</span><span class="p">,</span>
<span class="w">        </span><span class="n">expected_balance</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Balance is not updated correctly: expected {:?}, found: {:?}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">expected_balance</span><span class="p">,</span>
<span class="w">        </span><span class="n">resulting_balance</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The test fails with the following message:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Incorrect balance: expected Amount { micro_ccd: 1 }, found: Amount { micro_ccd: 0 }
</pre></div>
</div>
<p>That means that the contract called has stolen funds through a reentrant call.
A simple fix to this behavior is to place the highlighted line in <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> <em>before</em> making a call to an external contract.
In this case, the <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> call will fail because the non-zero balance condition is no longer satisfied in the mock entrypoint.</p>
</div>
</div>
<div class="section" id="testing-with-state-rollbacks">
<h2>Testing with state rollbacks<a class="headerlink" href="#testing-with-state-rollbacks" title="Permalink to this headline">#</a></h2>
<p>Invocations of smart contracts on the chain are transactional. This means that
if a contract changes its state and then fails, the state is rolled back to how
it was before the invocation.</p>
<p>If you want the same behavior when testing, it is necessary to use a helper
method on the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html"><code class="docutils literal notranslate"><span class="pre">TestHost</span></code></a>, namely <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.with_rollback"><code class="docutils literal notranslate"><span class="pre">with_rollback</span></code></a>.
To illustrate, here is an example in which the receive function increments the
state and then immediately fails:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>

<span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;increment&quot;</span><span class="cp">, mutable)]</span>
<span class="k">fn</span> <span class="nf">receive</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">_ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state_mut</span><span class="p">()</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mutate state.</span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">Reject</span>::<span class="n">default</span><span class="p">())</span><span class="w">  </span><span class="c1">// Then fail.</span>
<span class="p">}</span>

<span class="cp">#[concordium_cfg_test]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_without_rollback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span>::<span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span>::<span class="n">new</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">StateBuilder</span>::<span class="n">new</span><span class="p">());</span>

<span class="hll"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
</span>
<span class="hll"><span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// FAILS! State wasn&#39;t rolled back.</span>
</span><span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_with_rollback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span>::<span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span>::<span class="n">new</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">StateBuilder</span>::<span class="n">new</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// Use the `with_rollback` method.</span>
<span class="hll"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">with_rollback</span><span class="p">(</span><span class="o">|</span><span class="n">host</span><span class="o">|</span><span class="w"> </span><span class="n">receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">));</span>
</span>
<span class="hll"><span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Success!</span>
</span><span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.with_rollback"><code class="docutils literal notranslate"><span class="pre">with_rollback</span></code></a> works by creating a clone of the <code class="docutils literal notranslate"><span class="pre">State</span></code>, invoking the
receive function and, if it failed, rolling back the state.
This means that <code class="docutils literal notranslate"><span class="pre">State</span></code> must implement the trait <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a>, which
fortunately is implemented for all <a class="reference external" href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="docutils literal notranslate"><span class="pre">Clone</span></code></a> types.
However, it is not possible to implement <a class="reference external" href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="docutils literal notranslate"><span class="pre">Clone</span></code></a> correctly for your state if it
includes one of the special state types.</p>
<p>This is how to handle the two scenarios:</p>
<ul class="simple">
<li><p>Derive <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a> for your state (see example below) if it has one or more fields comprised
of <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.StateBox.html"><code class="docutils literal notranslate"><span class="pre">StateBox</span></code></a>, <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.StateSet.html"><code class="docutils literal notranslate"><span class="pre">StateSet</span></code></a>, or <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.StateMap.html"><code class="docutils literal notranslate"><span class="pre">StateMap</span></code></a>.</p></li>
<li><p>Otherwise, derive <a class="reference external" href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="docutils literal notranslate"><span class="pre">Clone</span></code></a> for your <code class="docutils literal notranslate"><span class="pre">State</span></code>.</p></li>
</ul>
<p>Here is an example of how to derive <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(StateClone)]</span>
<span class="cp">#[concordium(state_parameter = </span><span class="s">&quot;S&quot;</span><span class="cp">)]</span>
<span class="k">struct</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">my_state_map</span>: <span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="p">,</span><span class="w"> </span><span class="n">SomeOtherType</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can read more about deriving <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a> on <a class="reference external" href="https://docs.rs/concordium-std-derive/latest/concordium_std_derive/derive.StateClone.html">docs.rs</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The state also needs to be rolled back on errors occuring in mock
entrypoints as described in
<a class="reference internal" href="#testing-contract-invocations"><span class="std std-ref">Testing contract invocations with mocks</span></a>, but that is handled by the test
framework itself. This means that mock entrypoints are handled
transactionally, even without the use of <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.with_rollback"><code class="docutils literal notranslate"><span class="pre">with_rollback</span></code></a>.</p>
</div>
</div>
<div class="section" id="testing-transfers">
<h2>Testing transfers<a class="headerlink" href="#testing-transfers" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html"><code class="docutils literal notranslate"><span class="pre">TestHost</span></code></a> has three helper methods that are useful when testing that the correct <code class="docutils literal notranslate"><span class="pre">invoke_transfer</span></code> s have occurred.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">transfer_occurred</span></code> to check for specific transfers:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// Contract code + general test setup</span>

<span class="cp">#[test]</span>
<span class="k">fn</span> <span class="nf">test_transfer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="hll"><span class="w">    </span><span class="n">claim</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">transfer_occurred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">));</span>
</span><span class="p">}</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">get_transfers</span></code> to get a sorted list of all transfers that occurred:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">1</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="hll"><span class="w">     </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">get_transfers</span><span class="p">(),</span><span class="w"> </span><span class="p">[(</span><span class="n">receiver0</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">receiver1</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)]);</span>
</span></pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">get_transfers_to</span></code> to get a sorted list of all transfers to a specific
account:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">amount0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">amount1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_ccd</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="hll"><span class="w">     </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">get_transfers_to</span><span class="p">(</span><span class="n">receiver0</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">amount0</span><span class="p">,</span><span class="w"> </span><span class="n">amount1</span><span class="p">]);</span>
</span></pre></div>
</div>
</div>
<div class="section" id="writing-property-based-tests">
<span id="id1"></span><h2>Writing property-based tests<a class="headerlink" href="#writing-property-based-tests" title="Permalink to this headline">#</a></h2>
<p>The property-based testing technique allows for testing statements about your code that are expected to be true for any input parameters, possibly satisfying some precondition.
You can think of a precondition and a property as functions returning a boolean.
That is, for a function <code class="docutils literal notranslate"><span class="pre">fun</span></code>, a property looks as the following: “for any input <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code>, such that <code class="docutils literal notranslate"><span class="pre">precondition(x,</span> <span class="pre">y,</span> <span class="pre">z)</span> <span class="pre">=</span> <span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">property(x,</span> <span class="pre">y,</span> <span class="pre">z,</span> <span class="pre">fun(x,y,z))</span> <span class="pre">=</span> <span class="pre">true</span></code>”.
The input to such tests is generated randomly.
An example of a property is “for any integers <code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">m</span></code>, such that <code class="docutils literal notranslate"><span class="pre">even(n)</span> <span class="pre">=</span> <span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">even(m)</span> <span class="pre">=</span> <span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">even(n</span> <span class="pre">+</span> <span class="pre">m)</span> <span class="pre">=</span> <span class="pre">true</span></code>”.</p>
<p>Property-based testing is supported using the <a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck"><code class="docutils literal notranslate"><span class="pre">QuickCheck</span></code></a> crate.
The tests should be placed in the same module as regular unit tests and annotated with the <code class="docutils literal notranslate"><span class="pre">#[concordium_quickcheck]</span></code> macro.
The return value of the function should be a boolean corresponding to whether the property holds.</p>
<p>To get started, add the <code class="docutils literal notranslate"><span class="pre">concordium-quickcheck</span></code> feature to <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> as a <code class="docutils literal notranslate"><span class="pre">dev</span></code>-dependency in <code class="docutils literal notranslate"><span class="pre">Cargo.toml</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="o">..</span><span class="p">.</span>

<span class="p">[</span><span class="n">dev</span><span class="o">-</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">concordium</span><span class="o">-</span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;5.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;concordium-quickcheck&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">concordium_quickcheck</span></code> macro takes the <code class="docutils literal notranslate"><span class="pre">num_tests</span></code> attribute for specifying the number of random tests to run.
In the code snippet below, the parameters <code class="docutils literal notranslate"><span class="pre">address</span></code> and <code class="docutils literal notranslate"><span class="pre">amount</span></code> are generated randomly.
The process of generating random input and running the test is repeated 500 times because you set <code class="docutils literal notranslate"><span class="pre">num_tests</span> <span class="pre">=</span> <span class="pre">500</span></code>.
If you omit the <code class="docutils literal notranslate"><span class="pre">num_tests</span></code> attribute, it defaults to a 100 tests.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[concordium_cfg_test]</span>
<span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span>

<span class="w">   </span><span class="cp">#[concordium_quickcheck(num_tests = 500)]</span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">some_property_test</span><span class="p">(</span><span class="n">address</span>: <span class="nc">Address</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>: <span class="nc">Amount</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="c1">// Instantiate custom struct with random parameters, if necessary.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyParameters</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sender</span>: <span class="nc">address</span><span class="p">,</span><span class="w"> </span><span class="n">payment</span>: <span class="nc">amount</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The types <code class="docutils literal notranslate"><span class="pre">Address</span></code> and <code class="docutils literal notranslate"><span class="pre">Amount</span></code> in the example have <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> trait implementations, which are used to obtain random values.
Read more about available <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> instances for Concordium-specific types in <a class="reference external" href="https://docs.rs/concordium-contracts-common/latest/concordium_contracts_common"><code class="docutils literal notranslate"><span class="pre">concordium_contracts_common</span></code></a> documentation.
<a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck"><code class="docutils literal notranslate"><span class="pre">QuickCheck</span></code></a> defines <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> instances for standard data types, like numbers and collections (<code class="docutils literal notranslate"><span class="pre">Vec</span></code>, <code class="docutils literal notranslate"><span class="pre">BTreeMap</span></code>, etc.).
These instances are available by default when writing tests.
Custom user data type instances, like <code class="docutils literal notranslate"><span class="pre">MyParameters</span></code> above, can be created directly in tests using the random input parameters or by defining <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> instances.
See more details on QuickCheck’s <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> <a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck/trait.Arbitrary.html">here</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The fact that many random tests passed successfully does not automatically mean that the property holds for <strong>all</strong> inputs.
Often the input space is quite large to be covered fully.
In this case, it is important to think carefully about what an implementation of the <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> trait is doing to generate random input for your specific data.
In order to cover corner cases, you can bias the generated data to produce values that are deemed as potentially problematic.</p>
</div>
<p>The same command is used for running Wasm QuickCheck tests as in <a class="reference internal" href="#tests-in-wasm"><span class="std std-ref">Running tests in Wasm</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>When a test fails, it reports the random seed used to produce the input values.
The random numbers are generated using a deterministic pseudo-random number generator from this seed.
After making the required fixes to the code, you can use the same seed to see whether the previously failed tests work on the same generated values.
The seed is a <code class="docutils literal notranslate"><span class="pre">u64</span></code> number, which can be provided along with the test command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--seed<span class="w"> </span><span class="m">1234567890</span>
</pre></div>
</div>
<p>Concordium QuickCheck tests can also be run with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>By default, this command compiles the contract, unit tests, and QuickCheck tests to machine code for your local target (most likely x86_64) and runs them.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Printing and supplying a seed is only possible using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span></code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Avoid using <code class="docutils literal notranslate"><span class="pre">fail!</span></code> and <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants in <code class="docutils literal notranslate"><span class="pre">#[concordium_quickcheck]</span></code> tests.
In Wasm unit tests (see <a class="reference internal" href="#tests-in-wasm"><span class="std std-ref">Running tests in Wasm</span></a>) these commands report an error.
However, using them in QuickCheck tests makes the tests fail without providing a counterexample when running with <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span></code>.
Also avoid using <code class="docutils literal notranslate"><span class="pre">assert_eq!</span></code>, <code class="docutils literal notranslate"><span class="pre">panic!</span></code>, or any other command that panics.
Return a boolean value instead.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">#</a></h3>
<p>Consider a counter with a threshold: if the count is less than the threshold, it gets incremented; otherwise, it stays unchanged.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="o">*</span><span class="p">;</span>

<span class="w"> </span><span class="cp">#[derive(Serialize)]</span>
<span class="w"> </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">threshold</span>: <span class="kt">u16</span><span class="p">,</span>
<span class="w">     </span><span class="n">count</span>:     <span class="kt">u16</span><span class="p">,</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">threshold</span>: <span class="kt">u16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">count</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">             </span><span class="n">threshold</span><span class="p">,</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="c1">// Increment only if the current count is below the threshold.</span>
<span class="w">     </span><span class="k">fn</span> <span class="nf">increment</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">         </span><span class="c1">// Can you see a problem here?</span>
</span><span class="hll"><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">threshold</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">             </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span class="hll"><span class="w">         </span><span class="p">}</span>
</span><span class="w">     </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="cp">#[init(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">)]</span>
<span class="w"> </span><span class="k">fn</span> <span class="nf">contract_init</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">     </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasInitContext</span><span class="p">,</span>
<span class="w">     </span><span class="n">state_builder</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">StateBuilder</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">InitResult</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;my_receive&quot;</span><span class="cp">, mutable)]</span>
<span class="w"> </span><span class="k">fn</span> <span class="nf">contract_update_counter</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">     </span><span class="n">_ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">     </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="cp">#[concordium_cfg_test]</span>
<span class="w"> </span><span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">     </span><span class="c1">// Property: counter stays below the threshold for any number of calls `n`.</span>
<span class="w">     </span><span class="c1">// Run 500 tests with random `n` and `threshold` values.</span>
<span class="w">     </span><span class="cp">#[concordium_quickcheck(num_tests = 500)]</span>
<span class="w">     </span><span class="k">fn</span> <span class="nf">prop_counter_always_below_threshold</span><span class="p">(</span><span class="n">threshold</span>: <span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>: <span class="kt">u16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="n">new</span><span class="p">(</span><span class="n">threshold</span><span class="p">);</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">state</span><span class="p">.</span><span class="n">increment</span><span class="p">()</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="n">state</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span>
<span class="w">     </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>The test fails with a counterexample, i.e., an input that breaks the property:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">TestResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span>: <span class="nc">Fail</span><span class="p">,</span>
<span class="w">    </span><span class="n">arguments</span>: <span class="p">[</span>
<span class="w">        </span><span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="n">err</span>: <span class="nb">None</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">arguments</span></code> part shows the values that caused the test to fail.
In this case, if the threshold is <code class="docutils literal notranslate"><span class="pre">0</span></code> and the number of calls is <code class="docutils literal notranslate"><span class="pre">1</span></code>, then the counter becomes <code class="docutils literal notranslate"><span class="pre">1</span></code> after calling <code class="docutils literal notranslate"><span class="pre">state.increment()</span></code>, breaking the property.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck"><code class="docutils literal notranslate"><span class="pre">QuickCheck</span></code></a> implements a special mechanism called “shrinking” to find the simplest counterexample.
For the example above, <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">1</span></code> is the simplest input on which the test failed.</p>
</div>
<p>The issue is the comparison operator.
It should be <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> instead of <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>.
If you change the highlighted lines in the code above to:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">threshold</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>then all <code class="docutils literal notranslate"><span class="pre">500</span></code> tests pass successfully.</p>
</div>
</div>
</div>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>

  <!-- Script to change the highlighting of the active menu path and put the sidenav into hamburger for mobile-->
<script>
    const currentMenu = $('.bd-sidenav.current');
    currentMenu.parent().addClass('selected');

    let $togglerIcon = $('.navbar-toggler-icon');
    let $bdSidebar = $('.bd-sidebar');

    $togglerIcon.on( "click", function() {
        let $togglerAttr = $('.navbar-toggler').attr('aria-expanded');
        if ($togglerAttr == 'true') {
            $bdSidebar.parent().removeClass('show');
        } else {
            $bdSidebar.parent().addClass('show');
        }
    } );
</script>
  <style>
    .cc {
      position: relative;
      bottom: 0%;
      left: 0%;
    }

    .cc a {
      display: inline-block;
      text-align: left;
      padding: 16px;
      color: black;
      font-size: 8px;
    }
</style>

<div class="cc">
  <a href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img src="../../_static/cc-sa-by.png" />  Copyright 2021 - 2024, Concordium Software ApS
  </a>
  <a href="../../net/guides/legal.html">
    Legal information
  </a>
</div>
  <div id="cookie-consent" class="consent">
    <p>This website only aggregates and analyzes the actions you take here if you allow cookies. If you do not allow cookies, it protects your privacy, but also prevents the owner from learning from your actions and creating a better experience for you and other users.</p><p>Note that if you opt in and you clear your cookies, delete the opt-in cookie, or if you change computers or Web browsers, you will need to perform the opt-in procedure again.</p>
    <button onclick="consentGranted()">Allow</button>
    <button onclick="consentDenied()">Decline</button>
    <a href="https://concordium.com/privacy-policy/">Privacy policy</a>
</div>

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];

// Save the choice in a cookie
function storeChoice(granted) {
  document.cookie = "cookie-consent=" + granted
}

// Look for a cookie storing the previous choice of the user.
// Returns undefined if no choice was stored, otherwise a boolean for whether the
// user gave consent.
function loadChoice() {
  if (!document.cookie.includes("cookie-consent=")) {
      return undefined;
  }
  return document.cookie.includes("cookie-consent=true")
}

// Removes the cookie consent banner
function removeCookieConsentBanner() {
  document.getElementById("cookie-consent").remove()
}

// Called by the cookie consent banner if granted permission
function consentGranted() {
  storeChoice(true)
  _paq.push(['setCookieConsentGiven']);
  removeCookieConsentBanner()
}

// Called by the cookie consent banner if denied permission
function consentDenied() {
  storeChoice(true)
  removeCookieConsentBanner()
}

const stored = loadChoice();
if (stored) {
 consentGranted()
}

_paq.push(['requireCookieConsent']);
/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
_paq.push(['trackPageView']);
_paq.push(['enableLinkTracking']);

(function() {
    var u="https://concordium.matomo.cloud/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '2']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src='//cdn.matomo.cloud/concordium.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
  })();

  // remember tracking consent was given for all subsequent page views and visits
_paq.push(['rememberCookieConsentGiven']);

</script>


<!-- Start of HubSpot Embed Code -->
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/4771748.js"></script>
<!-- End of HubSpot Embed Code -->

  </body>
</html>
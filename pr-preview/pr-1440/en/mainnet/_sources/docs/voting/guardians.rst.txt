.. _guardians:
.. include:: ../../variables.rst

=========
Guardians
=========

The :term:`guardian` participates (via the guardian application) in all three phases of the election: the setup phase before the election, the :term:`election phase` during which they may cast votes, and the :term:`tally phase` at the end of the election.

In the setup phase, a distributed encryption key is generated. This ensures the secrecy of ballots. A number of guardians, as defined by the election parameters in the smart contract, register their public keys in the smart contract to say that they will :term:`tally` election votes. After the election closes, the guardians :term:`decrypt their share of the votes<decryption share>` and send the decrypted tally back to the smart contract. In this way, no one party tallies the votes for the election, ensuring privacy of the votes. Correctness of the result follows from the zero-knowledge proofs generated by the guardians and voters to prove that they performed their parts correctly.

.. note::

    Guardians need to use the |bw| or the |cryptox| as these wallets have the ability to export account keys.

Pre-setup
=========

The guardians must give their account addresses to the organizer of the election. If you need to know how to find your account address, see :ref:`share-address-mw`.

Guardians must download and install the Guardian desktop application that is created by the election coordinator.

Setup
=====

Before the election opens, the guardians must use the Guardian app to create their key pairs, register encrypted shares, and generate their secret key share to be used to decrypt the tally after the election.

Connect to election contract
----------------------------

When the election contract has been initialized, the guardians must connect to the election contract using the Guardian app. This is done in the following sequence of steps:

#. Open the Guardian app.

#. Specify the election target, consisting of a Concordium network ("mainnet" or "testnet" from the dropdown) and contract index, which is a positive whole number specified in the input field.

    .. image:: ../images/voting/guardian-connect.png
        :alt: connect to election contract dialog
        :width: 100%

#. Click **Connect** to connect to the election contract.

Connect your account
--------------------

The guardian app will sign the guardian transactions and submit them to the chain. For this, it needs the signing key of the account that is registered as a guardian in the smart contract.

#. To connect your account to the Guardian app, you must add your export file for your private account keys. For information about how to generate an export file, see :ref:`Export a private key<export-key>`.

    .. image:: ../images/voting/guardian-await-key.png
        :alt: screen showing drag-drop or browse to export file
        :width: 100%

#. Once you have added the export file, enter a password.

    .. image:: ../images/voting/guardian-set-pw.png
        :alt: password dialog
        :width: 100%

Generate guardian keys
----------------------

Before the election opens, the guardians must use the Guardian app to generate a pre-key.

#. Click **Generate guardian key** to create your secret key and register your public key in the election smart contract.

    .. image:: ../images/voting/guardian-generate-keys.png
        :alt: generate key pair dialog
        :width: 100%

   The progress dialog shows the status. Click **Send key registration** to complete the process.

    .. image:: ../images/voting/guardian-send-key-reg.png
        :alt: key pair generation progress dialog
        :width: 100%

Once you have generated your pre-key you must wait until the other guardians have done the same.

.. image:: ../images/voting/guardian-waiting.png
    :alt: dialog shown when awaiting other guardians
    :width: 100%

Generate and register encrypted shares
--------------------------------------

Once all guardians have generated their keys as described above, each guardian must go through the steps below to generate encrypted shares of their secret key for the other guardians.

#. Click **Generate encrypted shares**.

    .. image:: ../images/voting/guardian-generate-encrypted-shares.png
        :alt: generate encrypted shares dialog
        :width: 100%

#. Click **Register encrypted shares** to register the encrypted shares information to the election smart contract.

    .. image:: ../images/voting/guardian-reg-encrypted-shares.png
        :alt: register encrypted shares progress dialog
        :width: 100%

Once you have generated and registered your encrypted shares you must wait until the other guardians have done the same.

.. image:: ../images/voting/guardian-await-shares.png
    :alt: dialog shown when awaiting other guardians
    :width: 100%

Generate secret key share
-------------------------

The final step is to generate your secret key share. This creates your share of the decryption key using your secret key along with the encrypted shares of the secret keys of the other guardians.

#. Click **Generate secret key share**.

    .. image:: ../images/voting/guardian-generate-secret-key-share.png
        :alt: generate secret key share dialog
        :width: 100%

#. Click **Register validation OK**.

Once you have generated your secret key share you must wait until the other guardians have done the same.

.. image:: ../images/voting/guardian-await-key-share.png
    :alt: dialog shown when awaiting other guardians
    :width: 100%

After all guardians have complete the process, a screen shows that election setup is complete and a countdown to the election start.

.. image:: ../images/voting/guardian-election-setup-complete.png
    :alt: dialog shown when election setup is completed by all guardians
    :width: 100%

If corruption is detected the guardian should register a complaint in the contract.

After the election
==================

The app retrieves the encrypted tally from the contract automatically.

Generate your decrypted share
-----------------------------

#. Open the Guardian app.

#. Click **Generate decryption share**.

    .. image:: ../images/voting/guardian-generate-decryption-share.png
        :alt: generate decryption share dialog
        :width: 100%

#. Click **Send share registration**.

    .. image:: ../images/voting/guardian-register-decryption-share.png
        :alt: register decryption share dialog
        :width: 100%

Once you have registered your decryption share you must wait until the other guardians have done the same.

.. image:: ../images/voting/guardian-await-decryption.png
    :alt: dialog shown when awaiting other guardians
    :width: 100%

Register the decrypted share in the contract
--------------------------------------------

The final step creates a proof that can be checked by others to determine that the election has been fair.

#. Click **Generate decryption proof**.

    .. image:: ../images/voting/guardian-generate-decryption-proof.png
        :alt: generate decryption proof dialog
        :width: 100%

#. Click **Send proof registration**.

    .. image:: ../images/voting/guardian-register-decryption-proof.png
        :alt: generate decryption proof dialog
        :width: 100%

Once you have registered your decryption proof you must wait until the other guardians have done the same.

.. image:: ../images/voting/guardian-await-decryption-proof.png
    :alt: dialog shown when awaiting other guardians
    :width: 100%

After all guardians have registered decryption proofs, the decryption is shown as complete.

.. image:: ../images/voting/guardian-decryption-complete.png
    :alt: dialog shown when awaiting other guardians
    :width: 100%

Reconfigure the app
===================

In the case of a reset of the election, the guardian app must be reconfigured. This can be done through the **Settings** menu.

The simplest way to reconfigure the app to target the new election is to click **Set Election Target** and update the network and contract index.

    .. image:: ../images/voting/guardian-reconfigure.png
        :alt: reconfigure guardian app menu
        :width: 100%

.. note::

    On Windows/Linux, it might be required to press **Alt** on your keyboard to bring up the application menu where the "Settings" menu is available.

Uninstall the app
=================

Once the election is final, guardians should uninstall the app. The instructions below describe how to uninstall the app for each platform.

Windows
-------

Uninstall the app as you uninstall all apps on Microsoft.

Delete the folder ``C:\Users\<user>\AppData\com.concordium.guardian`` to remove all guardian keys.

macOS
-----

Uninstall the app as you uninstall all apps on macOS.

Delete the folder ``~/Library/Application Support/com.concordium.guardian`` where ``~`` represents either ``$HOME`` or ``/Users/<username>`` to remove all guardian keys.

Linux
-----

On linux, the application data is stored in one of two places depending on your system:

- ``$XDG_DATA_HOME/com.concordium.guardian``
- ``$HOME/.local/share/com.concordium.guardian``

Delete this folder to remove all guardian keys.

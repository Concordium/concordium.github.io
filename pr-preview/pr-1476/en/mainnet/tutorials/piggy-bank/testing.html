


<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="auto">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Testing the piggy bank smart contract &#8212; Concordium  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "auto";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "auto";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=19c83c19" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/tippy.css?v=124524c4" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=716d1818"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script defer="defer" src="https://unpkg.com/@popperjs/core@2"></script>
    <script defer="defer" src="https://unpkg.com/tippy.js@6"></script>
    <script defer="defer" src="../../_static/tippy/tutorials/piggy-bank/testing.f3f9ec9f-1cc5-45c2-810d-07c1d75bae4d.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/piggy-bank/testing';</script>
    <link rel="canonical" href="https://docs.concordium.com/en/mainnet/tutorials/piggy-bank/testing.html" />
    <link rel="icon" href="../../_static/concordium-logo-no-text.svg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Deploying the piggy bank smart contract" href="deploying.html" />
    <link rel="prev" title="Writing the piggy bank smart contract" href="writing.html" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" />

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="auto">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">Learn how to build with Protocol Level Tokens (PLTs). Read more about PLTs on the <a href="https://www.concordium.com/article/smart-money-starts-here-concordiums-protocol-level-tokens" target="_blank">Concordium website</a> or dive into our <a href="https://docs.concordium.com/en/mainnet/docs/plt/index.html">developer documentation</a>.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item"><style>
.navbar-brand img {
    max-height: 200px;
    width: auto;
}
</style>

<div>
    <a href="https://developer.concordium.software/">
        <img class="logo light-logo" src="../../_static/concordium-logo-dark.svg" />
        <img class="logo dark-logo" src="../../_static/concordium-logo.svg" />
    </a>
</div></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/index.html">
    Docs
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tools/index.html">
    Tools
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../community/index.html">
    Community
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://github.com/Concordium" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="mailto:support@concordium.software" title="Support" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Support</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://developer.concordium.software/en/mainnet/net/guides/developer-page.html#block-explorers" title="Monitor" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-chart-line fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Monitor</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://support.concordium.software/latest" title="Discourse" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://discord.com/invite/GpKGE2hCFx" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/channel/UCPZc2CuB2jGbZjD_5zX7-1A" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://medium.com/@concordium" title="Medium" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-medium fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Medium</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../docs/index.html">
    Docs
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tools/index.html">
    Tools
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../community/index.html">
    Community
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://github.com/Concordium" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="mailto:support@concordium.software" title="Support" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Support</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://developer.concordium.software/en/mainnet/net/guides/developer-page.html#block-explorers" title="Monitor" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-chart-line fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Monitor</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://support.concordium.software/latest" title="Discourse" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://discord.com/invite/GpKGE2hCFx" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/channel/UCPZc2CuB2jGbZjD_5zX7-1A" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://medium.com/@concordium" title="Medium" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-medium fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Medium</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../setup-env.html">Set up the development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hello-world/hello-world.html">Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="../counter/counter-contract.html">Counter</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">PiggyBank</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="writing.html">Writing the piggy bank smart contract</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Testing the piggy bank smart contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploying.html">Deploying the piggy bank smart contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html">Setting up a frontend</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../using-ID-in-dApps/index.html">Using ID in dApps</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../using-ID-in-dApps/wallet-connectors-tutorial.html">Implementing Wallet Connectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-ID-in-dApps/zk-proofs-tutorial.html">ZK proof generation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../onReceivingCIS2/on-receivingCIS2.html">Using the onReceivingCIS2 hook</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../wCCD/index.html">wCCD</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../wCCD/wCCD-introduction.html">Understanding the wCCD token protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wCCD/wCCD-interacting.html">Interacting with the wCCD token protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wCCD/wCCD-frontend-set-up.html">Setting up the frontend</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../voting/index.html">The Voting dApp</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../voting/voting-sc.html">Writing a voting smart contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../voting/voting-dapp.html">Setting up the frontend</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../nft-minting/index.html">Mint an NFT</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../nft-minting/upload-nft.html">Upload the NFT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nft-minting/build-smart-contract.html">Initialize, build, and deploy the smart contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nft-minting/mint-xfer.html">Mint and transfer the NFT</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../sft-minting/index.html">Mint a semi-fungible token</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../sft-minting/build-smart-contract.html">Smart contract modifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sft-minting/mint-xfer.html">Mint and transfer semi-fungible token</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../fungible-tokens/index.html">Mint fungible tokens</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../fungible-tokens/smart-contract.html">Smart contract implementation for fungible tokens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fungible-tokens/mint-xfer.html">Mint, transfer, and burn fungible tokens</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../low-code-nft-marketplace/introduction.html">Concordium low-code NFT framework</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../low-code-nft-marketplace/marketplace.html">Low code NFT marketplace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../low-code-nft-marketplace/minting-tool.html">Low-code NFT minting tool</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../eSealing/index.html">eSealing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../eSealing/eSealing_dapp.html">Exploring the eSealing dapp</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../sponsoredTransactions/index.html">Sponsored Transactions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../sponsoredTransactions/sponsoredTransactionsSmartContract.html">Exploring the sponsored Transactions Smart Contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sponsoredTransactions/sponsoredTransactionsFrontendAndBackend.html">Exploring the sponsored Transactions dApp</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../smartContractUpgrade/index.html">Smart Contract Upgrade</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../smartContractUpgrade/smartContractUpgrade.html">Native upgradability</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Ressources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../daap-examples/dapp-examples.html"> dApp examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../company-identity/company-identities.html"> How to create a company identity</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none"></div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="testing-the-piggy-bank-smart-contract">
<span id="piggy-bank-testing"></span><h1>Testing the piggy bank smart contract<a class="headerlink" href="#testing-the-piggy-bank-smart-contract" title="Link to this heading">#</a></h1>
<p>This is the second <a class="reference internal" href="index.html#piggy-bank"><span class="std std-ref">part of a tutorial</span></a> on smart contract
development.
So far you have written a piggy bank smart contract in the <a class="reference external" href="https://www.rust-lang.org/">Rust</a> programming
language.
This part will focus on how you can write integration-tests for your piggy bank smart
contract using the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/"><code class="docutils literal notranslate"><span class="pre">concordium-smart-contract-testing</span></code></a> library.
The library simulates part of a blockchain <em>locally</em> to allow you to create one or more contracts and interact with them in the tests.</p>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Link to this heading">#</a></h2>
<p>Before you start, make sure to have the necessary tooling to build Rust
contracts. The guide <a class="reference internal" href="../setup-env.html#setup-env"><span class="std std-ref">Set up the development environment</span></a> shows you how to do this.</p>
<p>Since you are going to extend the smart contract code written in the <a class="reference internal" href="writing.html#piggy-bank-writing"><span class="std std-ref">previous
part</span></a>, either follow the previous part or copy the complete
example code for part 1 from <a class="reference external" href="https://github.com/Concordium/concordium-rust-smart-contracts/blob/main/examples/piggy-bank/part1/src/lib.rs">GitHub</a>.</p>
<p>You are now ready to write tests for your smart contract!</p>
</section>
<section id="adding-the-testing-library">
<h2>Adding the testing library<a class="headerlink" href="#adding-the-testing-library" title="Link to this heading">#</a></h2>
<p>Start by adding the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/"><code class="docutils literal notranslate"><span class="pre">concordium-smart-contract-testing</span></code></a> library to the <code class="docutils literal notranslate"><span class="pre">Cargo.toml</span></code> located in the project root.
Then, add the <a class="reference external" href="https://docs.rs/concordium-std-derive/latest/concordium_std_derive/"><code class="docutils literal notranslate"><span class="pre">concordium-std-derive</span></code></a> library as well, which contains useful macros for testing.
You should add them under the section <code class="docutils literal notranslate"><span class="pre">[dev-dependencies]</span></code>, which are dependencies only needed during development, as it is only needed during testing.
The libraries require the Rust edition <code class="docutils literal notranslate"><span class="pre">2021</span></code> or greater, which you must also set:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[package]</span>
<span class="c1"># ...</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2021&quot;</span>

<span class="k">[dev-dependencies]</span>
<span class="n">concordium-smart-contract-testing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;3.0&quot;</span>
<span class="n">concordium-std-derive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;6.0&quot;</span>
</pre></div>
</div>
</section>
<section id="add-a-test-module">
<h2>Add a test module<a class="headerlink" href="#add-a-test-module" title="Link to this heading">#</a></h2>
<p>Since a smart contract module is a regular Rust library, you can test it as
one would test any library and add integration tests in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder.</p>
<p>Create the folder <code class="docutils literal notranslate"><span class="pre">tests</span></code> in the root of your project and add the file <code class="docutils literal notranslate"><span class="pre">tests.rs</span></code> inside it.</p>
<p>Import the testing libraries and your contract at the top of the file.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">concordium_smart_contract_testing</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">concordium_std_derive</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">piggy_bank_part2</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
</pre></div>
</div>
<p>Now you can start adding tests to this module.</p>
</section>
<section id="testing-instantiation-of-a-piggy-bank">
<h2>Testing instantiation of a piggy bank<a class="headerlink" href="#testing-instantiation-of-a-piggy-bank" title="Link to this heading">#</a></h2>
<p>The first test is to verify that the piggy bank contract can be initialized correctly.
Writing it also teaches you the basics of using the testing library.</p>
<p>Start by creating three constants that you will use in most of the upcoming test cases.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports omitted for brevity</span>

<span class="k">const</span><span class="w"> </span><span class="n">ACC_ADDR_OWNER</span><span class="p">:</span><span class="w"> </span><span class="nc">AccountAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account_address</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;&lt;your_cryptoX_wallet_address&gt;&quot;</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">ACC_ADDR_OTHER</span><span class="p">:</span><span class="w"> </span><span class="nc">AccountAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account_address</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;2xdTv8awN1BjgYEw8W1BVXVtiEwG2b29U8KoZQqJrDuEqddseE&quot;</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">ACC_INITIAL_BALANCE</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</pre></div>
</div>
<p>The first two are account addresses and the last one is the initial balance that both accounts will have.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The account addresses are represented as a base58check encoded string.</p>
</div>
<p>Next, create the init test:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Tests in Rust are regular functions, and the <code class="docutils literal notranslate"><span class="pre">#[test]</span></code> attribute tells the test runner to include the function when running <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code> or <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span></code>.</p>
<p>The primary construct used for testing is the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html"><code class="docutils literal notranslate"><span class="pre">Chain</span></code></a> type, which you should only create one of per test.
It represents the blockchain and has methods for creating accounts and deploying and working with contracts.</p>
<p>Use the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.new"><code class="docutils literal notranslate"><span class="pre">Chain::new</span></code></a> method for creating a chain with default settings and save it to the <em>mutable</em> variable <code class="docutils literal notranslate"><span class="pre">chain</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Chain</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The next step is to create two <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Account.html"><code class="docutils literal notranslate"><span class="pre">Account</span></code></a> entities and add them to the <code class="docutils literal notranslate"><span class="pre">chain</span></code>.
The simplest way to create an account is with <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Account.html#method.new"><code class="docutils literal notranslate"><span class="pre">Account::new</span></code></a>, which takes an <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.AccountAddress.html"><code class="docutils literal notranslate"><span class="pre">AccountAddress</span></code></a> and a total balance of the account.
Once constructed, use the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.create_account"><code class="docutils literal notranslate"><span class="pre">create_account</span></code></a> method to add it to the chain.
This step is important, as simply constructing an <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Account.html"><code class="docutils literal notranslate"><span class="pre">Account</span></code></a> does not make the chain aware of it.</p>
<p>Use the addresses and initial balance defined as constants:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Chain</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Account</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_INITIAL_BALANCE</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Account</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ACC_ADDR_OTHER</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_INITIAL_BALANCE</span><span class="p">);</span>
<span class="w">    </span><span class="n">chain</span><span class="p">.</span><span class="n">create_account</span><span class="p">(</span><span class="n">account_owner</span><span class="p">);</span>
<span class="w">    </span><span class="n">chain</span><span class="p">.</span><span class="n">create_account</span><span class="p">(</span><span class="n">account_other</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The balances of the accounts matter when using the testing library, as the cost of transactions, for example deploying a smart contract, will be deducted from the balance of the account sending the transaction.</p>
<p>With the accounts created, you are ready to load and deploy the smart contract module.
In <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/"><code class="docutils literal notranslate"><span class="pre">concordium-smart-contract-testing</span></code></a> you test the compiled smart contract module, which is the exact same module that can be deployed on the blockchain.
Use <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span></code>, which you installed in preparation for this tutorial, to compile the piggy bank to <a class="reference external" href="https://webassembly.org/">WebAssembly (Wasm)</a>.</p>
<p>Open a terminal and use <code class="docutils literal notranslate"><span class="pre">cd</span></code>, short for <em>change directory</em>, to go into the root of your piggy bank project.
Then compile your contract with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span>build<span class="w"> </span>--out<span class="w"> </span>piggy_bank_part2.wasm.v1
</pre></div>
</div>
<p>This produces the Wasm module <code class="docutils literal notranslate"><span class="pre">piggy_bank_part2.wasm.v1</span></code> in the root of your project, unless you have any typos or bugs in your code.
If that is the case, try to fix them using the helpful error messages from the compiler or go back to the end of part 1 and copy the full contract code again.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the tests run against the compiled Wasm module, there is a risk of accidentally using an outdated Wasm module.
To circumvent this, cargo concordium’s test command both builds and tests you contract, which ensures that you always test the newest version of your code.
By default it places the compiled Wasm module in the <code class="docutils literal notranslate"><span class="pre">target/</span></code> folder, but you can specify where you want it placed, so the location is easy to specify in your tests.
To do so, use the <code class="docutils literal notranslate"><span class="pre">--out</span></code> parameter when testing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--out<span class="w"> </span>piggy_bank_part2.wasm.v1
</pre></div>
</div>
<p>Please note that the test command only builds your module in cargo concordium version 2.9.0+.
Also note that for the highest assurance of correctness, you should <em>deploy the exact module</em> that you also tested.</p>
</div>
<p>Going back to your test case, use the function <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/fn.module_load_v1.html"><code class="docutils literal notranslate"><span class="pre">module_load_v1</span></code></a> to load the module.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// .. lines omitted for brevity.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module_load_v1</span><span class="p">(</span><span class="s">&quot;piggy_bank_part2.wasm.v1&quot;</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Module is valid and exists&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/fn.module_load_v1.html"><code class="docutils literal notranslate"><span class="pre">module_load_v1</span></code></a> attempts to load a module from disk, which might be missing or invalid, and it thus returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code> type.
You can use <code class="docutils literal notranslate"><span class="pre">unwrap</span></code>, or <code class="docutils literal notranslate"><span class="pre">expect</span></code>, to extract the actual module from the <code class="docutils literal notranslate"><span class="pre">Result</span></code>.
Both methods will panic if the <code class="docutils literal notranslate"><span class="pre">Result</span></code> actually contains the <code class="docutils literal notranslate"><span class="pre">Err</span></code> variant, which in turn will make the test case fail.
The remainder of this tutorial uses <code class="docutils literal notranslate"><span class="pre">expect</span></code> as it allows you to provide a contextual message that is shown on panics.</p>
<p>The next step is to deploy the module to our test chain (<code class="docutils literal notranslate"><span class="pre">chain</span></code>) with the method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.module_deploy_v1"><code class="docutils literal notranslate"><span class="pre">module_deploy_v1</span></code></a>.</p>
<p>Since this is a transaction, you must provide an account address of the <code class="docutils literal notranslate"><span class="pre">sender</span></code>, which will pay for the cost of the transaction.
You must also provide a <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Signer.html"><code class="docutils literal notranslate"><span class="pre">Signer</span></code></a> with a number of keys.
This mimics the behavior on the real chain, where one or more keys must sign a transaction.
The only observable difference between using one or more keys is the cost of the transaction, where each extra key increases the cost slightly.
In this tutorial, you will always use a <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Signer.html"><code class="docutils literal notranslate"><span class="pre">Signer</span></code></a> with one key as that is the most common scenario.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Chain</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// .. lines omitted for brevity.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module_load_v1</span><span class="p">(</span><span class="s">&quot;piggy_bank_part2.wasm.v1&quot;</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Module is valid and exists&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">deployment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">module_deploy_v1</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">module</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Deploying valid module should succeed&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Since deployment can fail, for example if the account doesn’t have sufficient CCD to cover the cost, the method returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code>, which is unwrapped with <code class="docutils literal notranslate"><span class="pre">expect</span></code>.
The returned struct has information about the energy used, transaction fee, and a <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/type.ModuleReference.html"><code class="docutils literal notranslate"><span class="pre">ModuleReference</span></code></a> that you use for initializing contracts.</p>
<p>With the module deployed, you are ready to initialize a contract with the chain method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_init"><code class="docutils literal notranslate"><span class="pre">contract_init</span></code></a>.
The method has the following parameters:</p>
<ul class="simple">
<li><p>A <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Signer.html"><code class="docutils literal notranslate"><span class="pre">Signer</span></code></a> to sign the transaction.</p></li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.AccountAddress.html"><code class="docutils literal notranslate"><span class="pre">AccountAddress</span></code></a>, which pays for the transaction.</p></li>
<li><p>A maximum <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Energy.html"><code class="docutils literal notranslate"><span class="pre">Energy</span></code></a> that the contract initialization can use.</p></li>
<li><p>A <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/type.ModuleReference.html"><code class="docutils literal notranslate"><span class="pre">ModuleReference</span></code></a>, which you got from the deployment above.</p></li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedContractName.html"><code class="docutils literal notranslate"><span class="pre">OwnedContractName</span></code></a>, that specifies which contract in the module you want to initialize.
Contract names are prefixed with <code class="docutils literal notranslate"><span class="pre">init_</span></code> on the chain to distinguish them from receive functions (entrypoints).
You constuct it with either <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedContractName.html#method.new"><code class="docutils literal notranslate"><span class="pre">OwnedContractName::new</span></code></a>, which checks the validity and returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code>, or <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedContractName.html#method.new_unchecked"><code class="docutils literal notranslate"><span class="pre">OwnedContractName::new_unchecked</span></code></a>, which performs no checking.</p></li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedParameter.html"><code class="docutils literal notranslate"><span class="pre">OwnedParameter</span></code></a>, which is a wrapper over a byte array that you construct with one of the following methods:</p>
<ul>
<li><p><a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedParameter.html#method.from_serial"><code class="docutils literal notranslate"><span class="pre">OwnedParameter::from_serial</span></code></a>, which serializes the input and checks that the parameter size is valid,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TryFrom::&lt;Vec&lt;u8&gt;&gt;::try_from(..)</span></code>, which also checks the parameter size,</p></li>
<li><p>or <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedParameter.html#method.empty"><code class="docutils literal notranslate"><span class="pre">OwnedParameter::empty</span></code></a>, which always succeeds.</p></li>
</ul>
</li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Amount.html"><code class="docutils literal notranslate"><span class="pre">Amount</span></code></a> to send to the contract.</p></li>
</ul>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// .. lines omitted for brevity.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_init</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">InitContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">mod_ref</span><span class="p">:</span><span class="w"> </span><span class="nc">deployment</span><span class="p">.</span><span class="n">module_reference</span><span class="p">,</span>
<span class="w">                </span><span class="n">init_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedContractName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;init_PiggyBank&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">param</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Initialization should always succeed&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Initialization can fail for several different reasons, and thus returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code>, which is unwrapped with <code class="docutils literal notranslate"><span class="pre">expect</span></code>.
The returned struct contains information about the energy used, transaction fee, contract events (logs) produced, and a <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractAddress.html"><code class="docutils literal notranslate"><span class="pre">ContractAddress</span></code></a> that you use for updating and interacting with the contract.</p>
<p>While the deployment and initialization in themselves act as a test, you can also check that the balance starts out as zero.
Use the method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_balance"><code class="docutils literal notranslate"><span class="pre">contract_balance</span></code></a> with the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractAddress.html"><code class="docutils literal notranslate"><span class="pre">ContractAddress</span></code></a> from the <code class="docutils literal notranslate"><span class="pre">initialization</span></code> struct to do so:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports and constants omitted for brevity</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// .. lines omitted for brevity.</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="n">contract_balance</span><span class="p">(</span><span class="n">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">()),</span>
<span class="w">        </span><span class="s">&quot;Piggy bank is not initialized with balance of zero&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_balance"><code class="docutils literal notranslate"><span class="pre">contract_balance</span></code></a> returns an <code class="docutils literal notranslate"><span class="pre">Option&lt;Amount&gt;</span></code>, as the contract queried might not exist.</p>
<p>The remaining test cases will call methods on an initialized contract.
To avoid duplicating code across the test cases, you will <em>refactor</em> nearly all of <code class="docutils literal notranslate"><span class="pre">test_init</span></code> into a separate helper function, <code class="docutils literal notranslate"><span class="pre">setup_chain_and_contract</span></code>, which you will use in the tests.</p>
<p>After the refactoring, you end up with the following test for initializing a piggy bank:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">concordium_smart_contract_testing</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">ACC_ADDR_OWNER</span><span class="p">:</span><span class="w"> </span><span class="nc">AccountAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span>
<span class="k">const</span><span class="w"> </span><span class="n">ACC_ADDR_OTHER</span><span class="p">:</span><span class="w"> </span><span class="nc">AccountAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span>
<span class="k">const</span><span class="w"> </span><span class="n">ACC_INITIAL_BALANCE</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">setup_chain_and_contract</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span><span class="w"> </span><span class="n">ContractInitSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Chain</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="n">chain</span><span class="p">.</span><span class="n">create_account</span><span class="p">(</span><span class="n">Account</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_INITIAL_BALANCE</span><span class="p">));</span>
<span class="w">    </span><span class="n">chain</span><span class="p">.</span><span class="n">create_account</span><span class="p">(</span><span class="n">Account</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ACC_ADDR_OTHER</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_INITIAL_BALANCE</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Chain</span><span class="p">::</span><span class="n">module_load_v1</span><span class="p">(</span><span class="s">&quot;piggy_bank_part2.wasm.v1&quot;</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Module is valid and exists&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">deployment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">module_deploy_v1</span><span class="p">(</span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span><span class="w"> </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Deploying valid module should succeed&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_init</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">InitContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">mod_ref</span><span class="p">:</span><span class="w"> </span><span class="nc">deployment</span><span class="p">.</span><span class="n">module_reference</span><span class="p">,</span>
<span class="w">                </span><span class="n">init_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedContractName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;init_PiggyBank&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">param</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Initialization should always succeed&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="p">(</span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="n">contract_balance</span><span class="p">(</span><span class="n">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">()),</span>
<span class="w">        </span><span class="s">&quot;Piggy bank is not initialized with balance of zero&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run the test to check that it compiles and succeeds.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--out<span class="w"> </span>piggy_bank_part2.wasm.v1
</pre></div>
</div>
<p>Note that the command recompiles the Wasm module and replaces the old module in the same location due to the <code class="docutils literal notranslate"><span class="pre">--out</span></code> parameter.</p>
</section>
<section id="test-inserting-ccd-into-a-piggy-bank">
<h2>Test inserting CCD into a piggy bank<a class="headerlink" href="#test-inserting-ccd-into-a-piggy-bank" title="Link to this heading">#</a></h2>
<p>Next, you should test the different functions for interacting with a piggy bank.
You will start by testing the <code class="docutils literal notranslate"><span class="pre">insert</span></code> entrypoint on an intact piggy bank contract.</p>
<p>Create a new test case named <code class="docutils literal notranslate"><span class="pre">test_insert_intact</span></code>, and use the helper method <code class="docutils literal notranslate"><span class="pre">create_chain_and_contract</span></code> from the previous section to get a chain with two accounts and an initialized piggy bank contract.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that you must mark the <code class="docutils literal notranslate"><span class="pre">chain</span></code> variable as mutable, since contract updates mutate it.</p>
<p>Now, you are ready to update the contract with the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_update"><code class="docutils literal notranslate"><span class="pre">contract_update</span></code></a> method, which has parameters similar to <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_init"><code class="docutils literal notranslate"><span class="pre">contract_init</span></code></a>:</p>
<ul class="simple">
<li><p>A <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Signer.html"><code class="docutils literal notranslate"><span class="pre">Signer</span></code></a> to sign the transaction.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">invoker</span></code> of type <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.AccountAddress.html"><code class="docutils literal notranslate"><span class="pre">AccountAddress</span></code></a>, which pays for the transaction.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">sender</span></code> of type <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/enum.Address.html"><code class="docutils literal notranslate"><span class="pre">Address</span></code></a>, which can either be an <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.AccountAddress.html"><code class="docutils literal notranslate"><span class="pre">AccountAddress</span></code></a> or a <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractAddress.html"><code class="docutils literal notranslate"><span class="pre">ContractAddress</span></code></a>.</p>
<ul>
<li><p>The main utility of the parameter is that it allows you to test internal calls in your contracts directly.</p></li>
<li><p>For example, if you have a more complex scenario where an account calls contract <code class="docutils literal notranslate"><span class="pre">A</span></code> which internally calls contract <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p>
<ul>
<li><p>In this case you can test the complete integration by calling <code class="docutils literal notranslate"><span class="pre">A</span></code>.</p></li>
<li><p>But you can also test <code class="docutils literal notranslate"><span class="pre">B</span></code> as its own unit by calling it directly and specifying <code class="docutils literal notranslate"><span class="pre">A</span></code> as the <code class="docutils literal notranslate"><span class="pre">sender</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>A maximum <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Energy.html"><code class="docutils literal notranslate"><span class="pre">Energy</span></code></a> that the contract update can use.</p></li>
<li><p>A <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractAddress.html"><code class="docutils literal notranslate"><span class="pre">ContractAddress</span></code></a>, which you get from the initialization variable.</p></li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedReceiveName.html"><code class="docutils literal notranslate"><span class="pre">OwnedReceiveName</span></code></a>, that specifies which receive name in the module you want to initialize.</p>
<ul>
<li><p>A “receive name” is the contract name concatenated with the entrypoint name and a dot in between.</p></li>
<li><p>In this example, the contract <code class="docutils literal notranslate"><span class="pre">my_contract</span></code> and the entrypoint <code class="docutils literal notranslate"><span class="pre">my_entrypoint</span></code> combine to the receive name <code class="docutils literal notranslate"><span class="pre">my_contract.my_entrypoint</span></code>.</p></li>
<li><p>You construct it with either <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedReceiveName.html#method.new"><code class="docutils literal notranslate"><span class="pre">OwnedReceiveName::new</span></code></a>, which checks the format and returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code>, or <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedReceiveName.html#method.new_unchecked"><code class="docutils literal notranslate"><span class="pre">OwnedReceiveName::new_unchecked</span></code></a>, which performs no checks.</p></li>
</ul>
</li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedParameter.html"><code class="docutils literal notranslate"><span class="pre">OwnedParameter</span></code></a>, which is a wrapper over a byte array that you construct with one of the following methods:</p>
<ul>
<li><p><a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedParameter.html#method.from_serial"><code class="docutils literal notranslate"><span class="pre">OwnedParameter::from_serial</span></code></a>, which serializes the input and checks that the parameter size is valid,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TryFrom::&lt;Vec&lt;u8&gt;&gt;::try_from(..)</span></code>, which also checks the parameter size,</p></li>
<li><p>or <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.OwnedParameter.html#method.empty"><code class="docutils literal notranslate"><span class="pre">OwnedParameter::empty</span></code></a>, which always succeeds.</p></li>
</ul>
</li>
<li><p>An <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Amount.html"><code class="docutils literal notranslate"><span class="pre">Amount</span></code></a> to send to the contract.</p></li>
</ul>
<p>Define the variable <code class="docutils literal notranslate"><span class="pre">insert_amount</span></code> with the amount of CCD you want to send to the contract.
Then update the contract with the <code class="docutils literal notranslate"><span class="pre">insert</span></code> receive function and pass in <code class="docutils literal notranslate"><span class="pre">insert_amount</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">insert_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_update</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">insert_amount</span><span class="p">,</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.insert&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can then verify the success of the update and the contract balance:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>

<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">update</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Inserting into intact piggy bank failed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="n">contract_balance</span><span class="p">(</span><span class="n">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">insert_amount</span><span class="p">),</span>
<span class="w">        </span><span class="s">&quot;Piggy bank balance does not match amount inserted&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>One test that is tempting to add is to check that the piggy bank remains intact
after inserting CCD into it.
However, there is no way for the immutable receive method <code class="docutils literal notranslate"><span class="pre">piggy_insert</span></code> to
mutate the state.
Trying to do so would result in an error from the Rust compiler.
By using immutable receive functions, it is possible to rule out certain error
cases at compile time, which means that you do not need tests for these
scenarios.
Along with performance, those are the two primary reasons for not making your
receive methods <a class="reference external" href="https://docs.rs/concordium-std-derive/latest/concordium_std_derive/attr.receive.html#mutable-function-can-mutate-the-state"><code class="docutils literal notranslate"><span class="pre">mutable</span></code></a> unless strictly necessary.</p>
<p>The second test becomes:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">insert_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_update</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">insert_amount</span><span class="p">,</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.insert&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">update</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Inserting into intact piggy bank failed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="n">contract_balance</span><span class="p">(</span><span class="n">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">insert_amount</span><span class="p">),</span>
<span class="w">        </span><span class="s">&quot;Piggy bank balance does not match amount inserted&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Again, verify that everything compiles and the tests succeed using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span> <span class="pre">--out</span> <span class="pre">piggy_bank_part2.wasm.v1</span></code>.</p>
</section>
<section id="test-smashing-a-piggy-bank">
<h2>Test smashing a piggy bank<a class="headerlink" href="#test-smashing-a-piggy-bank" title="Link to this heading">#</a></h2>
<p>Testing <code class="docutils literal notranslate"><span class="pre">smash</span></code> will follow the same pattern, but this time you will also use the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_invoke"><code class="docutils literal notranslate"><span class="pre">contract_invoke</span></code></a> method to invoke the <code class="docutils literal notranslate"><span class="pre">view</span></code> receive function and check whether the state is smashed.</p>
<p>Start by creating a new test case, <code class="docutils literal notranslate"><span class="pre">test_smash_intact</span></code>, setup the chain and contract with the helper function, and update the contract by calling the <code class="docutils literal notranslate"><span class="pre">smash</span></code> entrypoint.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>
<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact</span><span class="p">(){</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_update</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.smash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Owner is allowed to smash intact piggy bank&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that you must use the <code class="docutils literal notranslate"><span class="pre">ACC_ADDR_OWNER</span></code> for the <code class="docutils literal notranslate"><span class="pre">sender</span></code> argument, since it is only the owner who can smash the piggy bank.</p>
<p>To check the <code class="docutils literal notranslate"><span class="pre">PiggyBankState</span></code>, you must invoke the <code class="docutils literal notranslate"><span class="pre">view</span></code> with the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_invoke"><code class="docutils literal notranslate"><span class="pre">contract_invoke</span></code></a> method.
You could also use <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_update"><code class="docutils literal notranslate"><span class="pre">contract_update</span></code></a> for this purpose, as you are just interested in the return value, but the benefit of <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.contract_invoke"><code class="docutils literal notranslate"><span class="pre">contract_invoke</span></code></a> is that it <em>isn’t</em> a transaction.
So it does not charge the account for calling it, and it does not save changes to contracts.
For seasoned Rust programmers, that is easily seen by its function signature, which takes an immutable reference to the chain (<code class="docutils literal notranslate"><span class="pre">&amp;self</span></code>), as opposed to the mutable reference (<code class="docutils literal notranslate"><span class="pre">&amp;mut</span> <span class="pre">self</span></code>) used in the update method.
Also note that the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Signer.html"><code class="docutils literal notranslate"><span class="pre">Signer</span></code></a> parameter is not needed for the invoke method, as the signer is only needed for transactions.</p>
<p>Invoke the <code class="docutils literal notranslate"><span class="pre">view</span></code> function below the update:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>
<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact</span><span class="p">(){</span>

<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_invoke</span><span class="p">(</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.view&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Invoking `view` should always succeed&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The next step is to use the return value from (<code class="docutils literal notranslate"><span class="pre">invoke.return_value</span></code>), which is a byte array representing a tuple of <code class="docutils literal notranslate"><span class="pre">PiggyBankState</span></code> and <code class="docutils literal notranslate"><span class="pre">Amount</span></code>.
While it is possible to make assertions about the bytes directly, it is preferable to deserialize the bytes into structured Rust types.
There is a helper method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/fn.from_bytes.html"><code class="docutils literal notranslate"><span class="pre">from_bytes</span></code></a> for this exact purpose:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>
<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact</span><span class="p">(){</span>

<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">PiggyBankState</span><span class="p">,</span><span class="w"> </span><span class="n">Amount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">from_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">invoke</span><span class="p">.</span><span class="n">return_value</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;View should always return a valid result&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Since deserialization might fail, <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/fn.from_bytes.html"><code class="docutils literal notranslate"><span class="pre">from_bytes</span></code></a> returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code> that is unwrapped here.
If you run the tests at this point, the compiler will complain about <code class="docutils literal notranslate"><span class="pre">PiggyBankState</span></code> being undeclared.
This is because types and functions in Rust are private by default.
To make the <code class="docutils literal notranslate"><span class="pre">PiggyBankState</span></code> public, edit the <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code> file and add the <code class="docutils literal notranslate"><span class="pre">pub</span></code> keyword.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">PiggyBankState</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">   </span><span class="n">Intact</span><span class="p">,</span>
<span class="w">   </span><span class="n">Smashed</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The change you just made does not affect the functionality of the contract, but when you make changes that do, it is essential to build the Wasm module again.
Otherwise, you will continue using the old Wasm module.
Recompiling the module occurs automatically when using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span> <span class="pre">--out</span> <span class="pre">piggy_bank_part2.wasm.v1</span></code> and the command overwrites the old module in the same location due to the <code class="docutils literal notranslate"><span class="pre">--out</span></code> parameter.</p>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">state</span></code> and <code class="docutils literal notranslate"><span class="pre">balance</span></code> available, you can make assertions.
The contract should be smashed and have a balance of zero:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>
<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact</span><span class="p">(){</span>

<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span><span class="p">::</span><span class="n">Smashed</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Piggy bank is not smashed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Piggy bank has non-zero balance after being smashed&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also check that the contract transferred all of its funds to the owner during the <code class="docutils literal notranslate"><span class="pre">update</span></code>.
The helper method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractInvokeSuccess.html#method.account_transfers"><code class="docutils literal notranslate"><span class="pre">account_transfers</span></code></a> returns an iterator over <code class="docutils literal notranslate"><span class="pre">(ContractAddress,</span> <span class="pre">Amount,</span> <span class="pre">AccountAddress)</span></code>, representing transfers from contracts to accounts.
Use the <code class="docutils literal notranslate"><span class="pre">collect</span></code> method to turn the iterator into a <code class="docutils literal notranslate"><span class="pre">Vec</span></code> to compare it.
Since you did not insert any CCD in this test case, the piggy bank should have made a transfer of zero CCD:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// .. Imports, constants, and other functions omitted for brevity.</span>
<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact</span><span class="p">(){</span>

<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="n">account_transfers</span><span class="p">().</span><span class="n">collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">(),</span>
<span class="w">        </span><span class="p">[(</span>
<span class="w">            </span><span class="n">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">            </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span>
<span class="w">        </span><span class="p">)],</span>
<span class="w">        </span><span class="s">&quot;The piggy bank made incorrect transfers when smashed&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The complete third test thus becomes:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_update</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.smash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Owner is allowed to smash intact piggy bank&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_invoke</span><span class="p">(</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OWNER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.view&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Invoking `view` should always succeed&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">PiggyBankState</span><span class="p">,</span><span class="w"> </span><span class="n">Amount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">from_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">invoke</span><span class="p">.</span><span class="n">return_value</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;View should always return a valid result&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span><span class="p">::</span><span class="n">Smashed</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Piggy bank is not smashed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Piggy bank has non-zero balance after being smashed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="n">account_transfers</span><span class="p">().</span><span class="n">collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">(),</span>
<span class="w">        </span><span class="p">[(</span>
<span class="w">            </span><span class="n">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">            </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OWNER</span>
<span class="w">        </span><span class="p">)],</span>
<span class="w">        </span><span class="s">&quot;The piggy bank made incorrect transfers when smashed&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ensure everything compiles and the test succeeds using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span> <span class="pre">--out</span> <span class="pre">piggy_bank_part2.wasm.v1</span></code>.</p>
</section>
<section id="testing-cause-of-rejection">
<h2>Testing cause of rejection<a class="headerlink" href="#testing-cause-of-rejection" title="Link to this heading">#</a></h2>
<p>You want to test that the piggy bank rejects in certain contexts, for example
when someone besides the owner of the smart contract tries to smash it.</p>
<p>The test should:</p>
<ul class="simple">
<li><p>Setup the chain and contract.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code> with the <code class="docutils literal notranslate"><span class="pre">ACC_ADDR_OTHER</span></code> account.</p></li>
<li><p>Check that the result is an error with <code class="docutils literal notranslate"><span class="pre">expect_err</span></code>.</p></li>
</ul>
<p>The test could look like this:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>

<span class="w">    </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_update</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OTHER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OTHER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.smash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect_err</span><span class="p">(</span><span class="s">&quot;Smashing should only succeed for the owner&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>One thing to notice is that the test is not ensuring <em>why</em> the contract
rejected; your piggy bank might reject for a wrong reason and this would be a
bug.
This is probably fine for a simple smart contract like your piggy bank, but for a
smart contract with more complex logic and many reasons for rejecting, it would
be better if you tested this as well.</p>
<p id="piggy-bank-smash-error">To solve this, introduce a <em>public</em> <code class="docutils literal notranslate"><span class="pre">SmashError</span></code> enum  to represent the different
reasons for rejection:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(Debug, PartialEq, Eq, Serialize, Reject)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">SmashError</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">NotOwner</span><span class="p">,</span>
<span class="w">    </span><span class="n">AlreadySmashed</span><span class="p">,</span>
<span class="w">    </span><span class="n">TransferError</span><span class="p">,</span><span class="w"> </span><span class="c1">// Should never occur, see details below.</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more information about custom errors and deriving <code class="docutils literal notranslate"><span class="pre">Reject</span></code>, see <a class="reference internal" href="../../docs/smart-contracts/guides/custom-errors.html#custom-errors"><span class="std std-ref">Custom errors</span></a>.</p>
</div>
<p>To use this error type, the function <code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code> should return <code class="docutils literal notranslate"><span class="pre">Result&lt;A,</span>
<span class="pre">SmashError&gt;</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ReceiveResult&lt;A&gt;</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(contract = </span><span class="s">&quot;PiggyBank&quot;</span><span class="cp">, name = </span><span class="s">&quot;smash&quot;</span><span class="cp">, mutable)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">piggy_smash</span><span class="p">(</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ReceiveContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Host</span><span class="o">&lt;</span><span class="n">PiggyBankState</span><span class="o">&gt;</span><span class="p">,</span>
<span class="hll"><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">   </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and you also have to supply the <code class="docutils literal notranslate"><span class="pre">ensure!</span></code> macros with a second argument, which is
the error to produce:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(contract = </span><span class="s">&quot;PiggyBank&quot;</span><span class="cp">, name = </span><span class="s">&quot;smash&quot;</span><span class="cp">, mutable)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">piggy_smash</span><span class="p">(</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ReceiveContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Host</span><span class="o">&lt;</span><span class="n">PiggyBankState</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">owner</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sender</span><span class="p">();</span>

<span class="hll"><span class="w">    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="n">sender</span><span class="p">.</span><span class="n">matches_account</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">),</span><span class="w"> </span><span class="n">SmashError</span><span class="p">::</span><span class="n">NotOwner</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PiggyBankState</span><span class="p">::</span><span class="n">Intact</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="p">::</span><span class="n">AlreadySmashed</span><span class="p">);</span>
</span>
<span class="w">    </span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state_mut</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span><span class="p">::</span><span class="n">Smashed</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">self_balance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">transfer_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">invoke_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">);</span>
<span class="hll"><span class="w">    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="n">transfer_result</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="n">SmashError</span><span class="p">::</span><span class="n">TransferError</span><span class="p">);</span>
</span><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">invoke_transfer</span></code> fails if the account does not exist, or if the contract
has insufficient funds. Neither case can occur in the contract since contracts
always have a valid owner and the amount it sends is the <code class="docutils literal notranslate"><span class="pre">self_balance</span></code>. But
you should still be able to represent this error and distinguish it from the two
other error types.</p>
<p>When updates and invokes fail, they return a <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractInvokeError.html"><code class="docutils literal notranslate"><span class="pre">ContractInvokeError</span></code></a> struct, which has information about the transaction fee, energy usage, and also the <em>reason</em> why a contract call failed.
Some of the reasons include running out of energy, calling a contract that doesn’t exist, etc., but only one variant, which is when the contract <em>rejects</em> on its own, contains the bytes returned by the contract.
The helper method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.ContractInvokeError.html#method.return_value"><code class="docutils literal notranslate"><span class="pre">return_value</span></code></a> tries to extract the bytes from the contract rejection and returns an <code class="docutils literal notranslate"><span class="pre">Option&lt;Vec&lt;u8&gt;&gt;</span></code>.
With the bytes available, you can use the <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/fn.from_bytes.html"><code class="docutils literal notranslate"><span class="pre">from_bytes</span></code></a> method and assert why the update failed:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_err</span>
<span class="w">        </span><span class="p">.</span><span class="n">return_value</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Contract should reject and thus return bytes&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">SmashError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">return_value</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Contract should return a `SmashError` in serialized form&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">error</span><span class="p">,</span>
<span class="w">        </span><span class="n">SmashError</span><span class="p">::</span><span class="n">NotOwner</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Contract did not fail due to a NotOwner error&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, you can also check whether the <code class="docutils literal notranslate"><span class="pre">ACC_ADDR_OTHER</span></code> account was charged correctly for the transaction.
Use the method <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.account_balance_available"><code class="docutils literal notranslate"><span class="pre">account_balance_available</span></code></a> and check that it has the original balance minus the transaction fee for the update transaction.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// .. Lines omitted for brevity.</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="n">account_balance_available</span><span class="p">(</span><span class="n">ACC_ADDR_OTHER</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">ACC_INITIAL_BALANCE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">update_err</span><span class="p">.</span><span class="n">transaction_fee</span><span class="p">),</span>
<span class="w">        </span><span class="s">&quot;The invoker account was incorrectly charged&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that <a class="reference external" href="https://docs.rs/concordium-smart-contract-testing/latest/concordium_smart_contract_testing/struct.Chain.html#method.account_balance_available"><code class="docutils literal notranslate"><span class="pre">account_balance_available</span></code></a> returns an <code class="docutils literal notranslate"><span class="pre">Option&lt;Amount&gt;</span></code> as the queried account might not exist.</p>
<p>The final test thus becomes:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="n">initialization</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_chain_and_contract</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">update_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span>
<span class="w">        </span><span class="p">.</span><span class="n">contract_update</span><span class="p">(</span>
<span class="w">            </span><span class="n">Signer</span><span class="p">::</span><span class="n">with_one_key</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ACC_ADDR_OTHER</span><span class="p">,</span>
<span class="w">            </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">ACC_ADDR_OTHER</span><span class="p">),</span>
<span class="w">            </span><span class="n">Energy</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
<span class="w">            </span><span class="n">UpdateContractPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">(),</span>
<span class="w">                </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">initialization</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">                </span><span class="n">receive_name</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedReceiveName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;PiggyBank.smash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedParameter</span><span class="p">::</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect_err</span><span class="p">(</span><span class="s">&quot;Smashing should only succeed for the owner&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_err</span>
<span class="w">        </span><span class="p">.</span><span class="n">return_value</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Contract should reject and thus return bytes&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">SmashError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">return_value</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Contract should return a `SmashError` in serialized form&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">error</span><span class="p">,</span>
<span class="w">        </span><span class="n">SmashError</span><span class="p">::</span><span class="n">NotOwner</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Contract did not fail due to a NotOwner error&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="n">account_balance_available</span><span class="p">(</span><span class="n">ACC_ADDR_OTHER</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">ACC_INITIAL_BALANCE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">update_err</span><span class="p">.</span><span class="n">transaction_fee</span><span class="p">),</span>
<span class="w">        </span><span class="s">&quot;The invoker account was incorrectly charged&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This concludes the testing part of this tutorial.</p>
<p>But if you are eager to test all scenarios for the piggy bank, you can try to write the following extra tests using the techniques you just learned:</p>
<ul class="simple">
<li><p>Test that inserting into a piggy bank with state <code class="docutils literal notranslate"><span class="pre">Smashed</span></code> results in an error.</p></li>
<li><p>Test that smashing a piggy bank with state <code class="docutils literal notranslate"><span class="pre">Smashed</span></code> results in an <code class="docutils literal notranslate"><span class="pre">AlreadySmashed</span></code> error.</p></li>
<li><p>Test that the <code class="docutils literal notranslate"><span class="pre">ACC_ADDR_OWNER</span></code> account pays for <em>all</em> transaction fees and amounts inserted in a given test.</p>
<ul>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">test_insert_intact</span></code> test case, this means that transaction fees for deploying, initializing, and updating the contract, plus the amount inserted.</p></li>
<li><p>To test the deployment cost, the <code class="docutils literal notranslate"><span class="pre">setup_chain_and_contract</span></code> function method must return some additional data.
Can you figure out which?</p></li>
</ul>
</li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more information on testing, see <a class="reference internal" href="../../docs/smart-contracts/guides/integration-test-contract.html#integration-test-contract"><span class="std std-ref">Integration tests</span></a>.</p>
</div>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><style>
  legend {
    font-size: 12px;
    font-weight:bold ;
  }

  label {
    font-size: 12px;
  }
</style>

<fieldset>
  <legend>Was this article helpful?</legend>
  <input type="radio" id="Yes" name="rating" value="Yes" onclick="_paq.push(['trackEvent', 'Rating', 'ClickYes', 'Yes']);">
  <label for="Yes">Yes</label>
  <input type="radio" id="No" name="rating" value="No" onclick="_paq.push(['trackEvent', 'Rating', 'ClickNo', 'No']);">
  <label for="No">No</label>
</fieldset>

<!-- Matomo Tag Manager -->
<script>
  var _mtm = window._mtm = window._mtm || [];
  _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
  (function() {
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src='https://cdn.matomo.cloud/concordium.matomo.cloud/container_8ZIoCz8b.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Tag Manager --></div>
  
</div>
                </footer>
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="writing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Writing the piggy bank smart contract</p>
      </div>
    </a>
    <a class="right-next"
       href="deploying.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Deploying the piggy bank smart contract</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparation">Preparation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-the-testing-library">Adding the testing library</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-a-test-module">Add a test module</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-instantiation-of-a-piggy-bank">Testing instantiation of a piggy bank</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-inserting-ccd-into-a-piggy-bank">Test inserting CCD into a piggy bank</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-smashing-a-piggy-bank">Test smashing a piggy bank</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-cause-of-rejection">Testing cause of rejection</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/Concordium/concordium.github.io/edit/main/source/mainnet/tutorials/piggy-bank/testing.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  

  <p class="copyright">
    
      © Copyright 2021 - 2026, Concordium Software ApS.
      <br/>
    
  </p>

  <style>
    .cc {
      position: relative;
      bottom: 0%;
      left: 0%;
    }

    .cc a {
      display: inline-block;
      text-align: left;
      padding-left: 16px;
      padding-bottom: 8px;
      color: black;
      font-size: 8px;
    }
</style>

<div class="cc">
  <a text-decoration=none href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img src="../../_static/cc-sa-by.png" />
  </a>
  <a text-decoration=none href="../../net/guides/legal.html" >
    Legal information
  </a>
</div>
  <div id="cookie-consent" class="consent">     
    <p>This website only aggregates and analyzes the actions you take here if you allow cookies. If you do not allow cookies, it protects your privacy, but also prevents the owner from learning from your actions and creating a better experience for you and other users.</p><p>Note that if you opt in and you clear your cookies, delete the opt-in cookie, or if you change computers or Web browsers, you will need to perform the opt-in procedure again.</p>
    <button onclick="consentGranted()">Allow</button>     
    <button onclick="consentDenied()">Decline</button>     
    <a href="https://concordium.com/privacy-policy/">Privacy policy</a> 
</div>  

<!-- Matomo --> 
<script>   
var _paq = window._paq = window._paq || [];  

// Save the choice in a cookie with proper attributes
function storeChoice(granted) {   
    // Set cookie with 1 year expiration, path, and secure attributes
    const expires = new Date();
    expires.setFullYear(expires.getFullYear() + 1);
    document.cookie = "cookie-consent=" + granted + "; expires=" + expires.toUTCString() + "; path=/; SameSite=Lax";
}  

// Look for a cookie storing the previous choice of the user. 
// Returns null if no choice was stored, true if granted, false if denied
function loadChoice() {   
    if (!document.cookie.includes("cookie-consent=")) {       
        return null;   
    }   
    return document.cookie.includes("cookie-consent=true");
}  

// Removes the cookie consent banner safely
function removeCookieConsentBanner() {   
    const banner = document.getElementById("cookie-consent");
    if (banner) {
        banner.remove();
    }
}  

// Called by the cookie consent banner if granted permission
function consentGranted() {   
    storeChoice(true);
    _paq.push(['setCookieConsentGiven']);   
    removeCookieConsentBanner();
}  

// Called by the cookie consent banner if denied permission
function consentDenied() {   
    storeChoice(false);  // FIXED: Now correctly stores false
    removeCookieConsentBanner();
}  

// Check for stored consent and act accordingly
const stored = loadChoice(); 
if (stored === true) {
    // User previously granted consent
    _paq.push(['setCookieConsentGiven']);
    removeCookieConsentBanner();
} else if (stored === false) {
    // User previously denied consent
    removeCookieConsentBanner();
}
// If stored === null, show the banner (do nothing)

_paq.push(['requireCookieConsent']); 
/* tracker methods like "setCustomDimension" should be called before "trackPageView" */ 
_paq.push(['trackPageView']); 
_paq.push(['enableLinkTracking']);  

(function() {     
    var u="https://concordium.matomo.cloud/";     
    _paq.push(['setTrackerUrl', u+'matomo.php']);     
    _paq.push(['setSiteId', '2']);     
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];     
    g.async=true; g.src='//cdn.matomo.cloud/concordium.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);   
})();    

// Only remember consent if it was actually granted
if (stored === true) {
    _paq.push(['rememberCookieConsentGiven']);
}
</script>   

<!-- Start of HubSpot Embed Code --> 
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/4771748.js"></script> 
<!-- End of HubSpot Embed Code -->

  </body>
</html>
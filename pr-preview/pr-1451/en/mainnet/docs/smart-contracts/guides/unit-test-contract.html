


<!DOCTYPE html>


<html lang="en" data-content_root="../../../" data-theme="auto">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Unit testing &#8212; Concordium  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "auto";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "auto";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=19c83c19" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/tippy.css?v=124524c4" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=716d1818"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script defer="defer" src="https://unpkg.com/@popperjs/core@2"></script>
    <script defer="defer" src="https://unpkg.com/tippy.js@6"></script>
    <script defer="defer" src="../../../_static/tippy/docs/smart-contracts/guides/unit-test-contract.96120b60-5d9e-4411-8a33-a08184f7bc0e.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/smart-contracts/guides/unit-test-contract';</script>
    <link rel="canonical" href="https://docs.concordium.com/en/mainnet/docs/smart-contracts/guides/unit-test-contract.html" />
    <link rel="icon" href="../../../_static/concordium-logo-no-text.svg"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Integration tests" href="integration-test-contract.html" />
    <link rel="prev" title="Factory pattern" href="factory-pattern.html" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" />

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="auto">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">Learn how to build with Protocol Level Tokens (PLTs). Read more about PLTs on the <a href="https://www.concordium.com/article/smart-money-starts-here-concordiums-protocol-level-tokens" target="_blank">Concordium website</a> or dive into our <a href="https://docs.concordium.com/en/mainnet/docs/plt/index.html">developer documentation</a>.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item"><style>
.navbar-brand img {
    max-height: 200px;
    width: auto;
}
</style>

<div>
    <a href="https://developer.concordium.software/">
        <img class="logo light-logo" src="../../../_static/concordium-logo-dark.svg" />
        <img class="logo dark-logo" src="../../../_static/concordium-logo.svg" />
    </a>
</div></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../index.html">
    Docs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tools/index.html">
    Tools
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../community/index.html">
    Community
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://github.com/Concordium" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="mailto:support@concordium.software" title="Support" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Support</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://developer.concordium.software/en/mainnet/net/guides/developer-page.html#block-explorers" title="Monitor" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-chart-line fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Monitor</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://support.concordium.software/latest" title="Discourse" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://discord.com/invite/GpKGE2hCFx" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/channel/UCPZc2CuB2jGbZjD_5zX7-1A" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://medium.com/@concordium" title="Medium" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-medium fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Medium</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../index.html">
    Docs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tools/index.html">
    Tools
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../community/index.html">
    Community
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://github.com/Concordium" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="mailto:support@concordium.software" title="Support" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Support</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://developer.concordium.software/en/mainnet/net/guides/developer-page.html#block-explorers" title="Monitor" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-chart-line fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Monitor</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://support.concordium.software/latest" title="Discourse" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://discord.com/invite/GpKGE2hCFx" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://www.youtube.com/channel/UCPZc2CuB2jGbZjD_5zX7-1A" title="YouTube" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-youtube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">YouTube</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://medium.com/@concordium" title="Medium" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-medium fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Medium</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Concordium Protocol</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../protocol/concordium-protocol.html">What is the Concordium Protocol</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../protocol/identity.html">Identity</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/principles-of-privacy.html">Principles of privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/user-processes.html">User processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/identity-disclosure-processes.html">Identity disclosure processes</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../protocol/manage-accounts.html">Accounts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/account-concepts.html">Account concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/account-aliases.html">Account aliases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/key-derivation-and-usage.html">Key derivation and usage</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../protocol/transactions.html">Transactions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/transaction%20lifecycle.html">Transaction lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/transaction-fees.html">Transaction fees</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../protocol/consensus-mechanisms.html">Consensus mechanisms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/concepts-baker.html">Block production and validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/time-concepts.html">Time concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/validator-suspension.html">Validator suspension</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocol/tokenomics.html">Tokenomics</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../protocol/staking.html">Staking</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/how-to-become-a-validator.html">How to become a validator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../protocol/concepts-delegation.html">How to become a delegator</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocol Level Tokens</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../plt/index.html">What are Protocol-Level Tokens (PLTs)?</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../plt/setup-guide/index.html">Get started with PLTs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../plt/setup-guide/request-ccd.html">Request test CCD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plt/setup-guide/request-plt.html">Request PLT issuance</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../plt/operations/index.html">Operations</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../plt/examples/index.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../plt/examples/concordium-client.html">Concordium Client CLI Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plt/examples/web-sdk.html">Web SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plt/examples/rust-sdk.html">Rust SDK</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Smart Contracts</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="quick-start.html">QuickStart</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction.html">What is a smart contract?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contract-lifecycle.html">Life cycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contract-module.html">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contract-instances.html">Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contract-schema.html">Contract schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../develop-contracts.html">Using Rust</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="build-contract.html">Build</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup-contract.html">Set up a project</a></li>
<li class="toctree-l2"><a class="reference internal" href="compile-module.html">Module Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom-errors.html">Custom errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-schema.html">Build a contract schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="no-std.html">Using <code class="docutils literal notranslate"><span class="pre">no_std</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="fallback-entrypoints.html">Fallback entrypoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgradeable-contract.html">Upgradeability Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="json-params.html">JSON parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrate-contracts.html">Migrate contracts for <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> 8.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory-pattern.html">Factory pattern</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Unit testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="integration-test-contract.html">Integration tests</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="deploy-module.html">Deploy</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="initialize-contract.html">Initialize</a></li>
<li class="toctree-l2"><a class="reference internal" href="interact-instance.html">Interact</a></li>
<li class="toctree-l2"><a class="reference internal" href="inspect-instance.html">Inspect</a></li>
<li class="toctree-l2"><a class="reference internal" href="invoke-instance.html">Invoke</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../best-practices/index.html">Best practices</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../best-practices/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../best-practices/costs.html">Cost reduction</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../references/index.html">References</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../references/crypto-primitives.html">Cryptographic primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/host-fns.html">Contract host functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/local-settings.html">Local settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/references-on-chain.html">References on-chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/schema-json.html">Schema JSON representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/simulate-context.html">Simulation contexts</a></li>
<li class="toctree-l2"><a class="reference external" href="https://github.com/Concordium/concordium-rust-smart-contracts">Rust contract examples (repo)</a></li>
<li class="toctree-l2"><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/">concordium-std</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Network</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../network/baker-pool.html">Validator Management</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/validation-with-wallets.html">Validation with Concordium wallets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/become-validator.html">Validation with the Concordium Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/add-baker-mw.html">Add a validator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/import-validator-keys.html">Import validator keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/update-baker-mw.html">Change validator options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/suspend-unsuspend-validator.html">Suspend/Unsuspend a validator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/stop-validator.html">Stop a validator</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../network/nodes/node-requirements.html">Run a Concordium Node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../network/nodes/run-node-ubuntu/index.html">Run a node on Ubuntu</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-ubuntu/run-node-ubuntu.html">Install and manage a node on Ubuntu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-ubuntu/advanced-node-configuration-on-ubuntu.html">Advanced node configuration on Ubuntu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-ubuntu/troubleshoot-node-ubuntu.html">Troubleshoot a node on Ubuntu</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../network/nodes/run-node-macos/index.html">Run a Node on macOS</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-macos/run-node-macos.html">Install and manage a node on macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-macos/advanced-node-configuration-on-macos.html">Advanced node configuration on macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-macos/troubleshoot-macos.html">Troubleshoot a node on macOS</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../network/nodes/run-node-windows/index.html">Run a node on Windows</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-windows/run-node-windows.html">Install and manage a node on Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-windows/advanced-node-configuration-on-windows.html">Advanced node configuration on Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-windows/node-runner-service-configuration.html">Concordium Windows node runner service configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-windows/troubleshoot-windows.html">Troubleshoot a node on Windows</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../network/nodes/run-node-docker/index.html">Run a node using Docker</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-docker/run-node-docker.html">Install and manage a node on Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-docker/advanced-node-configuration-on-docker.html">Advanced node configuration on Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-docker/troubleshoot-docker.html">Troubleshoot a node in Docker</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../network/nodes/run-node-aws/index.html">Run a node on AWS</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../network/nodes/run-node-aws/run-node-aws.html">Run a node on Amazon Web Services (AWS)</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../network/web3-id/index.html">Use Concordium's ID layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../network/web3-id/issuer.html">Web3 ID issuers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/web3-id/identity-provider-interfaces.html">Wallet identity provider interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/guides/create-proofs.html">Create proofs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/web3-id/id-attributes-reference.html">ID attributes reference</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/guides/run-local-chain.html">Run a local chain</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../network/indexers/intro.html">Indexers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../network/indexers/subquery.html">SubQuery</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Help &amp; FAQ</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../installation/downloads.html">Downloads</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation/verification-instructions.html">Verification instructions</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/release-notes-lp.html">Release notes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../guides/wallets-lp.html">Concordium wallets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../guides/wallet-faqs.html">Wallet FAQs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guides/deciding-wallet.html">Deciding between the wallets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/concordium-wallet-faq.html">Concordium Wallet FAQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../browser-wallet/browser-wallet-faq.html">Concordium Wallet for Web FAQ</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../guides/setup-wallets-lp.html">Set up a wallet</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guides/setup-concordium-wallet.html">Set up the Concordium Wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../browser-wallet/setup-browser-wallet.html">Set up the Concordium Wallet for Web</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/overview-desktop.html">Set up the Desktop Wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/ledger-tutorial.html">Use your Ledger Device with Concordium Desktop Wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../desktop-wallet/install-ledger-app.html">Set up Concordium Governance Ledger App</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../guides/manage-wallets-lp.html">Wallet activities</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../guides/create-identity.html">Create an identity</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../guides/change-identity-name.html">Change identity name</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../guides/create-account.html">Create an account</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../guides/change-account-name.html">Change account name</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/recovery.html">Backup and recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mobile-wallet/change-passcode-mw.html">Update your passcode and biometric settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/address-book.html">Manage address book</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/transaction-report.html">Create a transaction report</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/show-seed-phrase.html">Show seed phrase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/show-wallet-private-key.html">Show wallet private key</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/import-export-file.html">Import/export file wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/wallet.html">Web3 ID in the Concordium Wallet for Web</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../guides/account-activities-lp.html">Account activities</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guides/send-ccd-wallets.html">Send CCD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mobile-wallet/share-address-mw.html">Find and share your account address</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../browser-wallet/connect-app.html">Connect dApps to wallets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../guides/proofs.html">Proofs and revealing information</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/tokens.html">Tokens in the wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/shield-ccd-wallets.html">Unshield CCD on an account</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../guides/scheduled-release.html">Scheduled releases</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../desktop-wallet/single-sign-schedule.html">Transfer CCD with a schedule in Desktop Wallet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../mobile-wallet/inspect-release-schedule-mw.html">Inspect a release schedule</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/export-account-private-key.html">Export account private key</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/export-transaction-logs.html">Export transaction logs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/add-delegation.html">Delegate to a staking pool or passive delegation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/remove-delegation.html">Remove delegation to a staking pool or passive delegation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guides/update-delegation.html">Update delegation to a staking pool or passive delegation</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../desktop-wallet/dw-lp.html">Desktop Wallet</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../desktop-wallet/single-sign-schedule.html">Transfer CCD with a schedule in Desktop Wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../desktop-wallet/transaction-log-filter.html">Apply a transaction log filter in the Desktop Wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../desktop-wallet/update-application.html">Update the Desktop Wallet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../desktop-wallet/accounts-desktop.html">Desktop Wallet navigation and settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../desktop-wallet/reset-data.html">Reset desktop wallet data</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../guides/overview-shared-accounts.html">Shared accounts with multiple credentials in Desktop Wallet</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../desktop-wallet/create-credentials-file.html">Create a credentials file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../guides/multi-credentials.html">Add credentials to an account</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../desktop-wallet/multisig-simple-transfer.html">Create a multi-signature CCD transfer in the Desktop Wallet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../guides/multisig-transfer.html">Create a scheduled transfer in the Desktop Wallet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../desktop-wallet/sign-transaction.html">Sign a transaction proposal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../desktop-wallet/proposed-transactions.html">View transaction proposals</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../guides/cryptox-terms.html">End User License Terms for CryptoX Concordium Wallet</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../help-and-faq/faqs.html">FAQs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../help-and-faq/delegation-faq.html">Delegation and validation FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help-and-faq/onboarding-guide-ethereum-developers/faq.html">FAQ for Ethereum developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help-and-faq/onboarding-guide-solana-developers/faq.html">FAQ for Solana developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help-and-faq/onboarding-guide-solana-developers/overview.html">Onboarding for Solana developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help-and-faq/set-up-doc-env.html">Set up Concordium documentation environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help-and-faq/style-guide.html">Concordium documentation style guide</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference external" href="https://proposals.concordium.software/index.html">Concordium Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/glossary.html">Glossary of Concordium terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/exchangeOnBoarding.html">Exchange Onboarding Guide</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Governance Committee Voting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../voting/gc-voting.html">Concordium Governance Committee elections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voting/coordinator.html">Election coordinator tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voting/voting.html">How to vote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voting/guardians.html">Guardians</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voting/verify-election-result.html">Verify election result</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none"></div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="unit-testing">
<span id="unit-test-contract"></span><h1>Unit testing<a class="headerlink" href="#unit-testing" title="Link to this heading">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Unit testing your contracts with the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> has been deprecated in favor of <a class="reference external" href="https://docs.rs/concordium-std-derive/latest/concordium_smart-contract-testing"><code class="docutils literal notranslate"><span class="pre">concordium-smart-contract-testing</span></code></a>.
To migrate your contracts and tests see <a class="reference internal" href="migrate-contracts.html#migrate-contracts-for-std-8-1"><span class="std std-ref">Migrate contracts for concordium-std 8.1</span></a> and <a class="reference internal" href="integration-test-contract.html#integration-test-contract"><span class="std std-ref">Integration tests</span></a>.</p>
<p>If you are not ready to migrate your contracts, you can still use the guide below.
Just make sure to add an <code class="docutils literal notranslate"><span class="pre">#[allow(deprecated)]</span></code> attribute above your test module to avoid warnings:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[allow(deprecated)]</span>
<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span><span class="p">::</span><span class="n">test_infrastructure</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>This guide describes how to write unit tests for a smart contract written in
Rust.</p>
<p>A smart contract in Rust is written as a library and you can unit test it like a
library by annotating functions with a <code class="docutils literal notranslate"><span class="pre">#[test]</span></code> attribute.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// contract code</span>
<span class="o">..</span><span class="p">.</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">test</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">some_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">another_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">cargo</span></code> to run the test:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>By default, this command compiles the contract and tests to machine code for
your local target (most likely <code class="docutils literal notranslate"><span class="pre">x86_64</span></code>), and runs them.
This kind of testing can be useful in initial development and for testing
functional correctness.
For comprehensive testing, it is important to involve the target platform, i.e.,
<cite>Wasm32</cite>.</p>
<section id="running-tests-in-wasm">
<span id="tests-in-wasm"></span><h2>Running tests in Wasm<a class="headerlink" href="#running-tests-in-wasm" title="Link to this heading">#</a></h2>
<p>Compiling the tests to native machine code is sufficient for most cases, but it
is also possible to compile the tests to Wasm and run them using the exact
interpreter that is used by the nodes.
This makes the test environment closer to the run environment on-chain and could,
in some cases, catch more bugs.
One notable difference between different environments is regarding the size of
pointers, where <cite>Wasm32</cite> uses four bytes as opposed to eight, which is common
for most platforms.</p>
<p>The development tool <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code> includes a test runner for Wasm, which
uses the same Wasm-interpreter as the one shipped in the Concordium nodes.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For instructions about how to install <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>, see <a class="reference internal" href="build-contract.html#build-contract"><span class="std std-ref">Build a smart contract</span></a>.</p>
</div>
<p>The unit test has to be annotated with <code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">#[test]</span></code>, and <code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code> is used instead of <code class="docutils literal notranslate"><span class="pre">#[cfg(test)]</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// contract code</span>
<span class="o">..</span><span class="p">.</span>

<span class="cp">#[concordium_cfg_test]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">test</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cp">#[concordium_test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">some_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[concordium_test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">another_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code> macro sets up your tests to be run in Wasm when
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> is compiled with the <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> feature. Otherwise, it
falls back to behave just like <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>, meaning it is still possible to run
unit tests targeting native code using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>.</p>
<p>Similarly, the macro <code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code> includes your module when build
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> with <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> otherwise behaves like <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>,
allowing you to control when to include tests in the build.</p>
<p>Tests can now be built and run using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>This command compiles the tests for Wasm with the <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> feature enabled
for <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> and uses the test runner from <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Error messages from <code class="docutils literal notranslate"><span class="pre">panic!</span></code>, and therefore also the different variations
of <code class="docutils literal notranslate"><span class="pre">assert!</span></code>, are <em>not</em> shown when compiling to Wasm.</p>
<p>Instead, use <code class="docutils literal notranslate"><span class="pre">fail!</span></code> and the <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants to do assertions when
testing, as these reports back the error messages to the test runner <em>before</em>
failing the test.
Both are part of <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code>.</p>
<p>The remainder of this guide will use the <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants for assertions.</p>
</div>
</section>
<section id="writing-unit-tests">
<h2>Writing unit tests<a class="headerlink" href="#writing-unit-tests" title="Link to this heading">#</a></h2>
<p>Unit tests typically follow a three-part structure in which you: set up some
state, run some unit of code, and make assertions about the state and output of
the code.</p>
<p>If the contract functions are written using <code class="docutils literal notranslate"><span class="pre">#[init(..)]</span></code> or
<code class="docutils literal notranslate"><span class="pre">#[receive(..)]</span></code>, you can test these functions directly in the unit test.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="cp">#[init(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">contract_init</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span><span class="w"> </span><span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">   </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasInitContext</span><span class="p">,</span>
<span class="w">   </span><span class="n">state_builder</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">StateBuilder</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">InitResult</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;my_receive&quot;</span><span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">contract_receive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span><span class="w"> </span><span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">   </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">   </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">MyReturnValue</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span><span class="p">::</span><span class="n">test_infrastructure</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">some_init_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create a test context.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestInitContext</span><span class="p">::</span><span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Set the fields that your init method accesses.</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_init_origin</span><span class="p">(</span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]));</span>
<span class="w">        </span><span class="c1">// Create a test state builder.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Call the init method.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contract_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state_builder</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert properties.</span>
<span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">State</span><span class="p">::</span><span class="n">new</span><span class="p">()));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">some_receive_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create a test context.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span><span class="p">::</span><span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Set the fields that your receive method accesses.</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_address</span><span class="p">(</span><span class="n">ContractAddress</span><span class="p">{</span><span class="w"> </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">subindex</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="c1">// Create a test host with state.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">State</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// Call the receive method.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contract_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">host</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Make assertions.</span>
<span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">MyReturnValue</span><span class="p">::</span><span class="n">new</span><span class="p">()));</span>
<span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">get_transfers</span><span class="p">(),</span><span class="w"> </span><span class="p">[]);</span><span class="w"> </span><span class="c1">// No transfers occured.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The submodule <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> of <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std"><code class="docutils literal notranslate"><span class="pre">concordium_std</span></code></a> contains a number of
test stubs, including the ones shown in the example, e.g., <code class="docutils literal notranslate"><span class="pre">TestHost</span></code> and <code class="docutils literal notranslate"><span class="pre">TestInitContext</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more information and examples, see the crate documentation of
<a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std"><code class="docutils literal notranslate"><span class="pre">concordium_std</span></code></a>.</p>
</div>
</section>
<section id="testing-contract-invocations-with-mocks">
<span id="testing-contract-invocations"></span><h2>Testing contract invocations with mocks<a class="headerlink" href="#testing-contract-invocations-with-mocks" title="Link to this heading">#</a></h2>
<p>To test receive methods that invoke contracts with
<code class="docutils literal notranslate"><span class="pre">host.invoke_contract(...)</span></code>, you should set up mocking functions that act as
the invoked contract. The <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> has a number of helpers for
mocking contracts.</p>
<p>To set up a mock entrypoint, use the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.setup_mock_entrypoint"><code class="docutils literal notranslate"><span class="pre">setup_mock_entrypoint</span></code></a> method from <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html"><code class="docutils literal notranslate"><span class="pre">TestHost</span></code></a>.
It expects a <code class="docutils literal notranslate"><span class="pre">ContractAddress</span></code> and an <code class="docutils literal notranslate"><span class="pre">OwnedEntrypointName</span></code> to specify which
entrypoint on which contract you are mocking.
It also expects a <code class="docutils literal notranslate"><span class="pre">MockFn</span></code>, which you can create in several different ways.</p>
<p>The simplest way to create a <code class="docutils literal notranslate"><span class="pre">MockFn</span></code> is with <code class="docutils literal notranslate"><span class="pre">returning_ok</span></code>, which creates
a mock function that returns the same <code class="docutils literal notranslate"><span class="pre">Ok(..)</span></code> value every time:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// Contract code + general test setup</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">mock_test_return_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">State</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>

<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span><span class="p">::</span><span class="n">returning_ok</span><span class="p">(</span><span class="mi">42</span><span class="k">u8</span><span class="p">),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For returning the same error every time, use the <code class="docutils literal notranslate"><span class="pre">returning_err</span></code>.
Use this to test missing contracts or entrypoints, as invoking
entrypoints for which no mock has been set up results in a runtime error:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span><span class="p">::</span><span class="n">returning_err</span><span class="p">::</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallContractError</span><span class="p">::</span><span class="n">MissingContract</span><span class="p">),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">returning_err</span></code> method is generic because
<code class="docutils literal notranslate"><span class="pre">CallContractError&lt;ReturnValueType&gt;</span></code> is generic and can return a value
with its logic error:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span><span class="p">::</span><span class="n">returning_err</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallContractError</span><span class="p">::</span><span class="n">LogicReject</span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">reason</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">return_value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Something went wrong!&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()}),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
</div>
<p>For more advanced types of mocks, use the functions <code class="docutils literal notranslate"><span class="pre">MockFn::new_v1</span></code>, <code class="docutils literal notranslate"><span class="pre">MockFn::new_v0</span></code>, or
<code class="docutils literal notranslate"><span class="pre">MockFn::new</span></code>.
Each of these functions takes a closure that has access to the parameter and amount
used in <code class="docutils literal notranslate"><span class="pre">invoke_contract(parameter,</span> <span class="pre">amount,</span> <span class="pre">..)</span></code>, but also the balance and
state of the contract you are testing.
The methods differ in what the closure should return.
V0 contracts do not have a return value, whereas V1 contracts always do.</p>
<p>Here is an example of a mocked entrypoint that only uses the parameter
and amount. For simplicity, it just traps if the input is not as expected:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">State</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>

<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">index</span><span class="p">:</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">subindex</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;some_receive_method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="hll"><span class="w">        </span><span class="n">MockFn</span><span class="p">::</span><span class="n">new_v1</span><span class="p">(</span><span class="o">|</span><span class="n">parameter</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">_balance</span><span class="p">,</span><span class="w"> </span><span class="n">_state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">from_bytes</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                 </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">n</span><span class="p">,</span>
</span><span class="hll"><span class="w">                 </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">CallContractError</span><span class="p">::</span><span class="n">Trap</span><span class="p">),</span>
</span><span class="hll"><span class="w">            </span><span class="p">};</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">amount</span><span class="p">.</span><span class="n">micro_ccd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">CallContractError</span><span class="p">::</span><span class="n">Trap</span><span class="p">),</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">state_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mock did not modify the state.</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="nb">Ok</span><span class="p">((</span><span class="n">state_modified</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
</span><span class="hll"><span class="w">        </span><span class="p">}),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<p>To test a contract that invokes itself, either directly or indirectly (e.g., <code class="docutils literal notranslate"><span class="pre">A</span></code> calls
<code class="docutils literal notranslate"><span class="pre">B</span></code> which then calls <code class="docutils literal notranslate"><span class="pre">A</span></code>, or with even more indirections), use the
state and balance fields:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span><span class="p">::</span><span class="n">empty</span><span class="p">();</span>
</span><span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">self_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContractAddress</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">index</span><span class="p">:</span><span class="w">    </span><span class="mi">0</span><span class="p">,</span>
</span><span class="hll"><span class="w">        </span><span class="n">subindex</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="p">};</span>
</span><span class="hll"><span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_address</span><span class="p">(</span><span class="n">self_address</span><span class="p">);</span>
</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">State</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">TestStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>

<span class="hll"><span class="w">    </span><span class="c1">// Meant to mock calls to the contract itself, where amounts sent</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// don&#39;t leave the contract and each call increments a counter.</span>
</span><span class="hll"><span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
</span><span class="hll"><span class="w">        </span><span class="n">self_address</span><span class="p">,</span>
</span><span class="hll"><span class="w">        </span><span class="n">OwnedEntrypointName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;self_receive&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
</span><span class="hll"><span class="w">        </span><span class="n">MockFn</span><span class="p">::</span><span class="n">new_v1</span><span class="p">(</span><span class="o">|</span><span class="n">_parameter</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="o">*</span><span class="n">balance</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="n">counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">state_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mock _did_ modify the state.</span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="nb">Ok</span><span class="p">((</span><span class="n">state_modified</span><span class="p">,</span><span class="w"> </span><span class="p">()))</span>
</span><span class="hll"><span class="w">        </span><span class="p">}),</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<section id="reentrancy">
<span id="reentracny-unit-testing"></span><h3>Reentrancy<a class="headerlink" href="#reentrancy" title="Link to this heading">#</a></h3>
<p>When invoking another smart contract, you give away control to that contract in the middle of execution.
The external contract can, for example, call back entrypoints of your contract.
This behavior is called <em>reentrancy</em> and is well-known from concurrency: a procedure can be interrupted in the middle of its execution, called again, and then resume execution.
See the details about handling external calls and ways of protecting against reentrancy-related issues in the <a class="reference internal" href="../best-practices/development.html#best-practices-external-calls"><span class="std std-ref">development best practices</span></a>.</p>
<p>The state of your contract might not be the same before and after <code class="docutils literal notranslate"><span class="pre">invoke_contract</span></code>, since the contract you call can invoke any entrypoint of your own contract.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">state_copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">();</span>
<span class="n">host</span><span class="p">.</span><span class="n">invoke_contract</span><span class="p">(</span><span class="o">..</span><span class="p">.);</span>

<span class="c1">// *host.state() and state_copy might not be equal any more due to reentrancy.</span>
<span class="n">do_something_with</span><span class="p">(</span><span class="n">state_copy</span><span class="p">);</span>
</pre></div>
</div>
<p>Consider a concrete example of reentrancy when the state is <em>not</em> updated properly before making an external call.
This can lead to reentrant calls that pass some validation that is based on the current state, even though these calls should fail.
The classic example of such a security issue is <a class="reference external" href="https://en.wikipedia.org/wiki/The_DAO_(organization)">the DAO</a> Ethereum smart contract that was drained of funds due to the reentrancy vulnerability.
Below is a code snippet that implements a small part similar to the DAO contract that stores balances for arbitrary addresses in a map <code class="docutils literal notranslate"><span class="pre">StateMap&lt;Address,</span> <span class="pre">Amount,</span> <span class="pre">S&gt;</span></code>.
The users can request their funds back; if a user is a smart contract, the funds are sent to a specified entrypoint.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(</span>
<span class="cp">    contract = </span><span class="s">&quot;reentrancy&quot;</span><span class="cp">,</span>
<span class="cp">    name = </span><span class="s">&quot;withdraw_reentrancy&quot;</span><span class="cp">,</span>
<span class="cp">    parameter = </span><span class="s">&quot;OwnedEntrypointName&quot;</span><span class="cp">,</span>
<span class="cp">    error = </span><span class="s">&quot;Error&quot;</span><span class="cp">,</span>
<span class="cp">    mutable</span>
<span class="cp">)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">withdraw_reentrancy</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span><span class="w"> </span><span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sender</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Get balance for the sender, or reject if the sender is not found or the</span>
<span class="w">    </span><span class="c1">// balance is zero.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">().</span><span class="n">balances</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">bal</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">bal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">bal</span><span class="p">,</span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="p">::</span><span class="n">WithdrawWithoutFunds</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Address</span><span class="p">::</span><span class="n">Account</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">invoke_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">sender_balance</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="n">Address</span><span class="p">::</span><span class="n">Contract</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="nc">OwnedEntrypointName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">parameter_cursor</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// At this point we are handing out the control out to an unknown</span>
<span class="w">            </span><span class="c1">// smart contract. This contract can call this entry point</span>
<span class="w">            </span><span class="c1">// again multiple times before the rest of the code is reached.</span>
<span class="w">            </span><span class="n">host</span><span class="p">.</span><span class="n">invoke_contract</span><span class="p">(</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">Parameter</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]),</span>
<span class="w">                </span><span class="n">entrypoint</span><span class="p">.</span><span class="n">as_entrypoint_name</span><span class="p">(),</span>
<span class="w">                </span><span class="n">sender_balance</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Reset the sender&#39;s balance to zero.</span>
<span class="w">    </span><span class="c1">// This code is reached only after transfering CCD back/calling an</span>
<span class="w">    </span><span class="c1">// external contract.</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">().</span><span class="n">balances</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">();</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The problem in the code above is that resetting the senders balance to zero happens <em>after</em> the call to an external contract is completed.
The senders balance in the <em>contract state</em> is used to determine how much funds should be transferred to the sender.
Since it is not updated, the external contract can make a call back to <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> and pass the balance validation.
Testing this behavior with mocks require some insights.
In particular, the example below mimics the original <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> code in the mock entrypoint.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[concordium_test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_withdraw_reentrancy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>

<span class="w">    </span><span class="c1">// Assume that `CONTRACT_ADDRESS` has 1 micro CCD</span>
<span class="w">    </span><span class="c1">// Set the contract balance to 2 micro CCD</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">Amount</span><span class="p">::</span><span class="n">from_micro_ccd</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Set up a mock entrypoint that calls back to our contract.</span>
<span class="w">    </span><span class="c1">// The mock emulates the `withdraw_reentrancy` logic to model</span>
<span class="w">    </span><span class="c1">// a reentrancy attack that will withdraw the sender&#39;s balance twice.</span>
<span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="n">setup_mock_entrypoint</span><span class="p">(</span>
<span class="w">        </span><span class="n">CONTRACT_ADDRESS</span><span class="p">,</span>
<span class="w">        </span><span class="n">OwnedEntrypointName</span><span class="p">::</span><span class="n">new_unchecked</span><span class="p">(</span><span class="s">&quot;withdraw_reentrancy&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">        </span><span class="n">MockFn</span><span class="p">::</span><span class="n">new_v1</span><span class="p">(</span><span class="o">|</span><span class="n">_parameter</span><span class="p">,</span><span class="w"> </span><span class="n">_amount</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// `invoke_contract` cannot be called inside this mock, but</span>
<span class="w">            </span><span class="c1">// `balance` gives access to the balance of the contract making</span>
<span class="w">            </span><span class="c1">// this invocation. The `withdraw_reentrancy` invocation can be</span>
<span class="w">            </span><span class="c1">// simulated by subtracting the sender&#39;s amount stored in the</span>
<span class="w">            </span><span class="c1">// contract state from `balance`.</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Address</span><span class="p">::</span><span class="n">Contract</span><span class="p">(</span><span class="n">CONTRACT_ADDRESS</span><span class="p">));</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sender_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">bal</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">bal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bal</span><span class="p">,</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">fail</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Insufficent funds&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="c1">// Emulate withdraw by subtracting the sender&#39;s balance.</span>
<span class="w">            </span><span class="o">*</span><span class="n">balance</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="o">*</span><span class="n">sender_balance</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Reset the sender&#39;s balance to zero.</span>
<span class="w">            </span><span class="o">*</span><span class="n">sender_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">zero</span><span class="p">();</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">state_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">((</span><span class="n">state_modified</span><span class="p">,</span><span class="w"> </span><span class="p">()))</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Withdraw 1 micro CCD</span>
<span class="w">    </span><span class="n">withdraw_reentrancy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="p">).</span><span class="n">expect_report</span><span class="p">(</span><span class="s">&quot;Withdraw call failed&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">resulting_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">self_balance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">expected_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">resulting_balance</span><span class="p">,</span>
<span class="w">        </span><span class="n">expected_balance</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Balance is not updated correctly: expected {:?}, found: {:?}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">expected_balance</span><span class="p">,</span>
<span class="w">        </span><span class="n">resulting_balance</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The test fails with the following message:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Incorrect balance: expected Amount { micro_ccd: 1 }, found: Amount { micro_ccd: 0 }
</pre></div>
</div>
<p>That means that the contract called has stolen funds through a reentrant call.
A simple fix to this behavior is to place the highlighted line in <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> <em>before</em> making a call to an external contract.
In this case, the <code class="docutils literal notranslate"><span class="pre">withdraw_reentrancy</span></code> call will fail because the non-zero balance condition is no longer satisfied in the mock entrypoint.</p>
</section>
</section>
<section id="testing-with-state-rollbacks">
<h2>Testing with state rollbacks<a class="headerlink" href="#testing-with-state-rollbacks" title="Link to this heading">#</a></h2>
<p>Invocations of smart contracts on the chain are transactional. This means that
if a contract changes its state and then fails, the state is rolled back to how
it was before the invocation.</p>
<p>If you want the same behavior when testing, it is necessary to use a helper
method on the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html"><code class="docutils literal notranslate"><span class="pre">TestHost</span></code></a>, namely <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.with_rollback"><code class="docutils literal notranslate"><span class="pre">with_rollback</span></code></a>.
To illustrate, here is an example in which the receive function increments the
state and then immediately fails:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">type</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>

<span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;increment&quot;</span><span class="cp">, mutable)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">receive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span><span class="w"> </span><span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">_ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state_mut</span><span class="p">()</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mutate state.</span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">Reject</span><span class="p">::</span><span class="n">default</span><span class="p">())</span><span class="w">  </span><span class="c1">// Then fail.</span>
<span class="p">}</span>

<span class="cp">#[concordium_cfg_test]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span><span class="p">::</span><span class="n">test_infrastructure</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_without_rollback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span><span class="p">::</span><span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">StateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>

<span class="hll"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
</span>
<span class="hll"><span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// FAILS! State wasn&#39;t rolled back.</span>
</span><span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_with_rollback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestReceiveContext</span><span class="p">::</span><span class="n">empty</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestHost</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">StateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// Use the `with_rollback` method.</span>
<span class="hll"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">with_rollback</span><span class="p">(</span><span class="o">|</span><span class="n">host</span><span class="o">|</span><span class="w"> </span><span class="n">receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">));</span>
</span>
<span class="hll"><span class="w">        </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">.</span><span class="n">state</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Success!</span>
</span><span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.with_rollback"><code class="docutils literal notranslate"><span class="pre">with_rollback</span></code></a> works by creating a clone of the <code class="docutils literal notranslate"><span class="pre">State</span></code>, invoking the
receive function and, if it failed, rolling back the state.
This means that <code class="docutils literal notranslate"><span class="pre">State</span></code> must implement the trait <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a>, which
fortunately is implemented for all <a class="reference external" href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="docutils literal notranslate"><span class="pre">Clone</span></code></a> types.
However, it is not possible to implement <a class="reference external" href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="docutils literal notranslate"><span class="pre">Clone</span></code></a> correctly for your state if it
includes one of the special state types.</p>
<p>This is how to handle the two scenarios:</p>
<ul class="simple">
<li><p>Derive <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a> for your state (see example below) if it has one or more fields comprised
of <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.StateBox.html"><code class="docutils literal notranslate"><span class="pre">StateBox</span></code></a>, <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.StateSet.html"><code class="docutils literal notranslate"><span class="pre">StateSet</span></code></a>, or <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.StateMap.html"><code class="docutils literal notranslate"><span class="pre">StateMap</span></code></a>.</p></li>
<li><p>Otherwise, derive <a class="reference external" href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="docutils literal notranslate"><span class="pre">Clone</span></code></a> for your <code class="docutils literal notranslate"><span class="pre">State</span></code>.</p></li>
</ul>
<p>Here is an example of how to derive <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(StateClone)]</span>
<span class="cp">#[concordium(state_parameter = </span><span class="s">&quot;S&quot;</span><span class="cp">)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">my_state_map</span><span class="p">:</span><span class="w"> </span><span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="p">,</span><span class="w"> </span><span class="n">SomeOtherType</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can read more about deriving <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.StateClone.html"><code class="docutils literal notranslate"><span class="pre">StateClone</span></code></a> on <a class="reference external" href="https://docs.rs/concordium-std-derive/latest/concordium_std_derive/derive.StateClone.html">docs.rs</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The state also needs to be rolled back on errors occuring in mock
entrypoints as described in
<a class="reference internal" href="#testing-contract-invocations"><span class="std std-ref">Testing contract invocations with mocks</span></a>, but that is handled by the test
framework itself. This means that mock entrypoints are handled
transactionally, even without the use of <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html#method.with_rollback"><code class="docutils literal notranslate"><span class="pre">with_rollback</span></code></a>.</p>
</div>
</section>
<section id="testing-transfers">
<h2>Testing transfers<a class="headerlink" href="#testing-transfers" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/struct.TestHost.html"><code class="docutils literal notranslate"><span class="pre">TestHost</span></code></a> has three helper methods that are useful when testing that the correct <code class="docutils literal notranslate"><span class="pre">invoke_transfer</span></code> s have occurred.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">transfer_occurred</span></code> to check for specific transfers:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// Contract code + general test setup</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_transfer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="hll"><span class="w">    </span><span class="n">claim</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">transfer_occurred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">));</span>
</span><span class="p">}</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">get_transfers</span></code> to get a sorted list of all transfers that occurred:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">1</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="hll"><span class="w">     </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">get_transfers</span><span class="p">(),</span><span class="w"> </span><span class="p">[(</span><span class="n">receiver0</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">receiver1</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)]);</span>
</span></pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">get_transfers_to</span></code> to get a sorted list of all transfers to a specific
account:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">receiver0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="mi">32</span><span class="p">]);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">amount0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">amount1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span><span class="p">::</span><span class="n">from_ccd</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="hll"><span class="w">     </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="n">get_transfers_to</span><span class="p">(</span><span class="n">receiver0</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">amount0</span><span class="p">,</span><span class="w"> </span><span class="n">amount1</span><span class="p">]);</span>
</span></pre></div>
</div>
</section>
<section id="writing-property-based-tests">
<span id="id1"></span><h2>Writing property-based tests<a class="headerlink" href="#writing-property-based-tests" title="Link to this heading">#</a></h2>
<p>The property-based testing technique allows for testing statements about your code that are expected to be true for any input parameters, possibly satisfying some precondition.
You can think of a precondition and a property as functions returning a boolean.
That is, for a function <code class="docutils literal notranslate"><span class="pre">fun</span></code>, a property looks as the following: for any input <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code>, such that <code class="docutils literal notranslate"><span class="pre">precondition(x,</span> <span class="pre">y,</span> <span class="pre">z)</span> <span class="pre">=</span> <span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">property(x,</span> <span class="pre">y,</span> <span class="pre">z,</span> <span class="pre">fun(x,y,z))</span> <span class="pre">=</span> <span class="pre">true</span></code>.
The input to such tests is generated randomly.
An example of a property is for any integers <code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">m</span></code>, such that <code class="docutils literal notranslate"><span class="pre">even(n)</span> <span class="pre">=</span> <span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">even(m)</span> <span class="pre">=</span> <span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">even(n</span> <span class="pre">+</span> <span class="pre">m)</span> <span class="pre">=</span> <span class="pre">true</span></code>.</p>
<p>Property-based testing is supported using the <a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck"><code class="docutils literal notranslate"><span class="pre">QuickCheck</span></code></a> crate.
The tests should be placed in the same module as regular unit tests and annotated with the <code class="docutils literal notranslate"><span class="pre">#[concordium_quickcheck]</span></code> macro.
The return value of the function should be a boolean corresponding to whether the property holds.</p>
<p>To get started, add the <code class="docutils literal notranslate"><span class="pre">concordium-quickcheck</span></code> feature to <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> as a <code class="docutils literal notranslate"><span class="pre">dev</span></code>-dependency in <code class="docutils literal notranslate"><span class="pre">Cargo.toml</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="o">..</span><span class="p">.</span>

<span class="p">[</span><span class="n">dev</span><span class="o">-</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">concordium</span><span class="o">-</span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;5.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;concordium-quickcheck&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="o">..</span><span class="p">.</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">concordium_quickcheck</span></code> macro takes the <code class="docutils literal notranslate"><span class="pre">num_tests</span></code> attribute for specifying the number of random tests to run.
In the code snippet below, the parameters <code class="docutils literal notranslate"><span class="pre">address</span></code> and <code class="docutils literal notranslate"><span class="pre">amount</span></code> are generated randomly.
The process of generating random input and running the test is repeated 500 times because you set <code class="docutils literal notranslate"><span class="pre">num_tests</span> <span class="pre">=</span> <span class="pre">500</span></code>.
If you omit the <code class="docutils literal notranslate"><span class="pre">num_tests</span></code> attribute, it defaults to a 100 tests.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[concordium_cfg_test]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">test</span><span class="w"> </span><span class="p">{</span>

<span class="w">   </span><span class="cp">#[concordium_quickcheck(num_tests = 500)]</span>
<span class="w">   </span><span class="k">fn</span><span class="w"> </span><span class="nf">some_property_test</span><span class="p">(</span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="nc">Address</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nc">Amount</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="c1">// Instantiate custom struct with random parameters, if necessary.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyParameters</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sender</span><span class="p">:</span><span class="w"> </span><span class="nc">address</span><span class="p">,</span><span class="w"> </span><span class="n">payment</span><span class="p">:</span><span class="w"> </span><span class="nc">amount</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The types <code class="docutils literal notranslate"><span class="pre">Address</span></code> and <code class="docutils literal notranslate"><span class="pre">Amount</span></code> in the example have <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> trait implementations, which are used to obtain random values.
Read more about available <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> instances for Concordium-specific types in <a class="reference external" href="https://docs.rs/concordium-contracts-common/latest/concordium_contracts_common"><code class="docutils literal notranslate"><span class="pre">concordium_contracts_common</span></code></a> documentation.
<a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck"><code class="docutils literal notranslate"><span class="pre">QuickCheck</span></code></a> defines <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> instances for standard data types, like numbers and collections (<code class="docutils literal notranslate"><span class="pre">Vec</span></code>, <code class="docutils literal notranslate"><span class="pre">BTreeMap</span></code>, etc.).
These instances are available by default when writing tests.
Custom user data type instances, like <code class="docutils literal notranslate"><span class="pre">MyParameters</span></code> above, can be created directly in tests using the random input parameters or by defining <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> instances.
See more details on QuickChecks <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> <a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck/trait.Arbitrary.html">here</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The fact that many random tests passed successfully does not automatically mean that the property holds for <strong>all</strong> inputs.
Often the input space is quite large to be covered fully.
In this case, it is important to think carefully about what an implementation of the <code class="docutils literal notranslate"><span class="pre">Arbitrary</span></code> trait is doing to generate random input for your specific data.
In order to cover corner cases, you can bias the generated data to produce values that are deemed as potentially problematic.</p>
</div>
<p>The same command is used for running Wasm QuickCheck tests as in <a class="reference internal" href="#tests-in-wasm"><span class="std std-ref">Running tests in Wasm</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>When a test fails, it reports the random seed used to produce the input values.
The random numbers are generated using a deterministic pseudo-random number generator from this seed.
After making the required fixes to the code, you can use the same seed to see whether the previously failed tests work on the same generated values.
The seed is a <code class="docutils literal notranslate"><span class="pre">u64</span></code> number, which can be provided along with the test command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span>concordium<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--seed<span class="w"> </span><span class="m">1234567890</span>
</pre></div>
</div>
<p>Concordium QuickCheck tests can also be run with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>By default, this command compiles the contract, unit tests, and QuickCheck tests to machine code for your local target (most likely x86_64) and runs them.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Printing and supplying a seed is only possible using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span></code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Avoid using <code class="docutils literal notranslate"><span class="pre">fail!</span></code> and <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants in <code class="docutils literal notranslate"><span class="pre">#[concordium_quickcheck]</span></code> tests.
In Wasm unit tests (see <a class="reference internal" href="#tests-in-wasm"><span class="std std-ref">Running tests in Wasm</span></a>) these commands report an error.
However, using them in QuickCheck tests makes the tests fail without providing a counterexample when running with <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">concordium</span> <span class="pre">test</span></code>.
Also avoid using <code class="docutils literal notranslate"><span class="pre">assert_eq!</span></code>, <code class="docutils literal notranslate"><span class="pre">panic!</span></code>, or any other command that panics.
Return a boolean value instead.</p>
</div>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Link to this heading">#</a></h3>
<p>Consider a counter with a threshold: if the count is less than the threshold, it gets incremented; otherwise, it stays unchanged.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w"> </span><span class="cp">#[derive(Serialize)]</span>
<span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">threshold</span><span class="p">:</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span>
<span class="w">     </span><span class="n">count</span><span class="p">:</span><span class="w">     </span><span class="kt">u16</span><span class="p">,</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">threshold</span><span class="p">:</span><span class="w"> </span><span class="kt">u16</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">             </span><span class="n">threshold</span><span class="p">,</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="c1">// Increment only if the current count is below the threshold.</span>
<span class="w">     </span><span class="k">fn</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">         </span><span class="c1">// Can you see a problem here?</span>
</span><span class="hll"><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">threshold</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">             </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span class="hll"><span class="w">         </span><span class="p">}</span>
</span><span class="w">     </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="cp">#[init(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">)]</span>
<span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">contract_init</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span><span class="w"> </span><span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">     </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasInitContext</span><span class="p">,</span>
<span class="w">     </span><span class="n">state_builder</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">StateBuilder</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">InitResult</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;my_receive&quot;</span><span class="cp">, mutable)]</span>
<span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">contract_update_counter</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span><span class="w"> </span><span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">     </span><span class="n">_ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span>
<span class="w">     </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="cp">#[concordium_cfg_test]</span>
<span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">     </span><span class="c1">// Property: counter stays below the threshold for any number of calls `n`.</span>
<span class="w">     </span><span class="c1">// Run 500 tests with random `n` and `threshold` values.</span>
<span class="w">     </span><span class="cp">#[concordium_quickcheck(num_tests = 500)]</span>
<span class="w">     </span><span class="k">fn</span><span class="w"> </span><span class="nf">prop_counter_always_below_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">:</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="kt">u16</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">threshold</span><span class="p">);</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">state</span><span class="p">.</span><span class="n">increment</span><span class="p">()</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="n">state</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span>
<span class="w">     </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>The test fails with a counterexample, i.e., an input that breaks the property:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">TestResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="nc">Fail</span><span class="p">,</span>
<span class="w">    </span><span class="n">arguments</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="n">err</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">arguments</span></code> part shows the values that caused the test to fail.
In this case, if the threshold is <code class="docutils literal notranslate"><span class="pre">0</span></code> and the number of calls is <code class="docutils literal notranslate"><span class="pre">1</span></code>, then the counter becomes <code class="docutils literal notranslate"><span class="pre">1</span></code> after calling <code class="docutils literal notranslate"><span class="pre">state.increment()</span></code>, breaking the property.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://docs.rs/quickcheck/latest/quickcheck"><code class="docutils literal notranslate"><span class="pre">QuickCheck</span></code></a> implements a special mechanism called shrinking to find the simplest counterexample.
For the example above, <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">1</span></code> is the simplest input on which the test failed.</p>
</div>
<p>The issue is the comparison operator.
It should be <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> instead of <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>.
If you change the highlighted lines in the code above to:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">threshold</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>then all <code class="docutils literal notranslate"><span class="pre">500</span></code> tests pass successfully.</p>
</section>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><style>
  legend {
    font-size: 12px;
    font-weight:bold ;
  }

  label {
    font-size: 12px;
  }
</style>

<fieldset>
  <legend>Was this article helpful?</legend>
  <input type="radio" id="Yes" name="rating" value="Yes" onclick="_paq.push(['trackEvent', 'Rating', 'ClickYes', 'Yes']);">
  <label for="Yes">Yes</label>
  <input type="radio" id="No" name="rating" value="No" onclick="_paq.push(['trackEvent', 'Rating', 'ClickNo', 'No']);">
  <label for="No">No</label>
</fieldset>

<!-- Matomo Tag Manager -->
<script>
  var _mtm = window._mtm = window._mtm || [];
  _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
  (function() {
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src='https://cdn.matomo.cloud/concordium.matomo.cloud/container_8ZIoCz8b.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Tag Manager --></div>
  
</div>
                </footer>
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="factory-pattern.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Factory pattern</p>
      </div>
    </a>
    <a class="right-next"
       href="integration-test-contract.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Integration tests</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-tests-in-wasm">Running tests in Wasm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-unit-tests">Writing unit tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-contract-invocations-with-mocks">Testing contract invocations with mocks</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reentrancy">Reentrancy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-with-state-rollbacks">Testing with state rollbacks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-transfers">Testing transfers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-property-based-tests">Writing property-based tests</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">Example</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/Concordium/concordium.github.io/edit/main/source/mainnet/docs/smart-contracts/guides/unit-test-contract.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  

  <p class="copyright">
    
       Copyright 2021 - 2025, Concordium Software ApS.
      <br/>
    
  </p>

  <style>
    .cc {
      position: relative;
      bottom: 0%;
      left: 0%;
    }

    .cc a {
      display: inline-block;
      text-align: left;
      padding-left: 16px;
      padding-bottom: 8px;
      color: black;
      font-size: 8px;
    }
</style>

<div class="cc">
  <a text-decoration=none href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img src="../../../_static/cc-sa-by.png" />
  </a>
  <a text-decoration=none href="../../../net/guides/legal.html" >
    Legal information
  </a>
</div>
  <div id="cookie-consent" class="consent">     
    <p>This website only aggregates and analyzes the actions you take here if you allow cookies. If you do not allow cookies, it protects your privacy, but also prevents the owner from learning from your actions and creating a better experience for you and other users.</p><p>Note that if you opt in and you clear your cookies, delete the opt-in cookie, or if you change computers or Web browsers, you will need to perform the opt-in procedure again.</p>
    <button onclick="consentGranted()">Allow</button>     
    <button onclick="consentDenied()">Decline</button>     
    <a href="https://concordium.com/privacy-policy/">Privacy policy</a> 
</div>  

<!-- Matomo --> 
<script>   
var _paq = window._paq = window._paq || [];  

// Save the choice in a cookie with proper attributes
function storeChoice(granted) {   
    // Set cookie with 1 year expiration, path, and secure attributes
    const expires = new Date();
    expires.setFullYear(expires.getFullYear() + 1);
    document.cookie = "cookie-consent=" + granted + "; expires=" + expires.toUTCString() + "; path=/; SameSite=Lax";
}  

// Look for a cookie storing the previous choice of the user. 
// Returns null if no choice was stored, true if granted, false if denied
function loadChoice() {   
    if (!document.cookie.includes("cookie-consent=")) {       
        return null;   
    }   
    return document.cookie.includes("cookie-consent=true");
}  

// Removes the cookie consent banner safely
function removeCookieConsentBanner() {   
    const banner = document.getElementById("cookie-consent");
    if (banner) {
        banner.remove();
    }
}  

// Called by the cookie consent banner if granted permission
function consentGranted() {   
    storeChoice(true);
    _paq.push(['setCookieConsentGiven']);   
    removeCookieConsentBanner();
}  

// Called by the cookie consent banner if denied permission
function consentDenied() {   
    storeChoice(false);  // FIXED: Now correctly stores false
    removeCookieConsentBanner();
}  

// Check for stored consent and act accordingly
const stored = loadChoice(); 
if (stored === true) {
    // User previously granted consent
    _paq.push(['setCookieConsentGiven']);
    removeCookieConsentBanner();
} else if (stored === false) {
    // User previously denied consent
    removeCookieConsentBanner();
}
// If stored === null, show the banner (do nothing)

_paq.push(['requireCookieConsent']); 
/* tracker methods like "setCustomDimension" should be called before "trackPageView" */ 
_paq.push(['trackPageView']); 
_paq.push(['enableLinkTracking']);  

(function() {     
    var u="https://concordium.matomo.cloud/";     
    _paq.push(['setTrackerUrl', u+'matomo.php']);     
    _paq.push(['setSiteId', '2']);     
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];     
    g.async=true; g.src='//cdn.matomo.cloud/concordium.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);   
})();    

// Only remember consent if it was actually granted
if (stored === true) {
    _paq.push(['rememberCookieConsentGiven']);
}
</script>   

<!-- Start of HubSpot Embed Code --> 
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/4771748.js"></script> 
<!-- End of HubSpot Embed Code -->

  </body>
</html>
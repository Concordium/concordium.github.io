



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>2. Testing the piggy bank smart contract &mdash; Concordium  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/concordium-logo-no-text.svg"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Install tools for development" href="../../guides/setup-tools.html" />
    <link rel="prev" title="1. Writing the piggy bank smart contract" href="writing.html" />
<link href="../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          


          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/concordium-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
<nav class="sidebar-top-menu">
    <a href="../../../net/index.html" class="" ><i class="icon fa fa-connectdevelop"></i> Mainnet</a>
    <a href="../../index.html" class="active"> <i class="icon fa fa-file-o"></i> Smart Contracts </a>
</nav>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/introduction.html">Introduction to smart contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/contract-module.html">Smart contract modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/contract-instances.html">Smart contract instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/contract-schema.html">Smart contract schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/resource-accounting.html">Resource accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/develop-contracts.html">Developing smart contracts in Rust</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The piggy bank smart contract</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="writing.html">1. Writing the piggy bank smart contract</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2. Testing the piggy bank smart contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#support-feedback">Support &amp; Feedback</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Contract development guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setup-tools.html">Install tools for development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setup-contract.html">Setting up a smart contract project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/compile-module.html">Compile a Rust smart contract module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/unit-test-contract.html">Unit test a contract in Rust</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/custom-errors.html">Return custom errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/local-simulate.html">Locally simulate contract functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/build-schema.html">Build a contract schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/no-std.html">Build using <code class="docutils literal notranslate"><span class="pre">no_std</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">On-chain guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/deploy-module.html">Deploy a smart contract module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/initialize-contract.html">Initialize a smart contract instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/interact-instance.html">Interact with a smart contract instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/inspect-instance.html">Inspect a smart contract instance</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../references/schema-json.html">Schema JSON representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references/simulate-context.html">Simulation contexts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references/host-fns.html">Contract host functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references/references-on-chain.html">References on-chain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references/local-settings.html">Local settings</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Concordium/concordium-rust-smart-contracts">Rust contract examples (repo)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/">concordium-std</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Concordium</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Concordium Smart Contract Documentation</a> &raquo;</li>
        
          <li><a href="index.html">The piggy bank smart contract</a> &raquo;</li>
        
      <li><span class="section-number">2. </span>Testing the piggy bank smart contract</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/Concordium/concordium.github.io/blob/mainnet/source/smart-contracts/tutorials/piggy-bank/testing.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing-the-piggy-bank-smart-contract">
<span id="piggy-bank-testing"></span><h1><span class="section-number">2. </span>Testing the piggy bank smart contract<a class="headerlink" href="#testing-the-piggy-bank-smart-contract" title="Permalink to this headline">Â¶</a></h1>
<p>This is the second <a class="reference internal" href="index.html#piggy-bank"><span class="std std-ref">part of a tutorial</span></a> on smart contract
development.
So far we have written a piggy bank smart contract in the <a class="reference external" href="https://www.rust-lang.org/">Rust</a> programming
language.
This part will focus on how we can write unit test for our piggy bank smart
contract and how to setup and locally simulate an invocation of a smart
contract.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The reader is assumed to have basic knowledge of what a blockchain and smart
contract is, and some experience with <a class="reference external" href="https://www.rust-lang.org/">Rust</a>.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#preparation" id="id3">Preparation</a></p></li>
<li><p><a class="reference internal" href="#adding-a-test-module" id="id4">Adding a test module</a></p></li>
<li><p><a class="reference internal" href="#testing-instantiation-of-a-piggy-bank" id="id5">Testing instantiation of a piggy bank</a></p></li>
<li><p><a class="reference internal" href="#test-inserting-gtu-into-a-piggy-bank" id="id6">Test inserting GTU into a piggy bank</a></p></li>
<li><p><a class="reference internal" href="#test-smashing-a-piggy-bank" id="id7">Test smashing a piggy bank</a></p></li>
<li><p><a class="reference internal" href="#testing-cause-of-rejection" id="id8">Testing cause of rejection</a></p></li>
<li><p><a class="reference internal" href="#compiling-and-running-tests-in-wasm" id="id9">Compiling and running tests in Wasm</a></p></li>
<li><p><a class="reference internal" href="#simulating-the-piggy-bank" id="id10">Simulating the piggy bank</a></p></li>
<li><p><a class="reference internal" href="#support-feedback" id="id11">Support &amp; Feedback</a></p></li>
</ul>
</div>
<div class="section" id="preparation">
<h2><span class="section-number">2.1. </span>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">Â¶</a></h2>
<p>Before we start, make sure to have the necessary tooling for building Rust
contracts.
The guide <a class="reference internal" href="../../guides/setup-tools.html#setup-tools"><span class="std std-ref">Install tools for development</span></a> will show you how to do this.
Also, make sure to have a text editor setup for writing Rust.</p>
<p>Since we are going to extend the smart contract code written in the previous
part, either follow the previous part or copy the resulting code from there.</p>
<p>We are now ready for writing unit tests for our smart contract!</p>
</div>
<div class="section" id="adding-a-test-module">
<h2><span class="section-number">2.2. </span>Adding a test module<a class="headerlink" href="#adding-a-test-module" title="Permalink to this headline">Â¶</a></h2>
<p>Since a smart contract module is written as a Rust library, we can test it as
one would test any library and write unit-tests as part of the Rust module.</p>
<p>At the bottom of the <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code> file containing our code, make sure you have the
following starting point:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// PiggyBank contract code up here</span>

<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This is our test module, which is a common pattern for writing unit tests in
Rust, so we will not spend time on explaining any of the above code.</p>
<p>We test the contract functions just as if they were regular functions, by
calling the functions we have annotated with <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/attr.init.html"><code class="docutils literal notranslate"><span class="pre">#[init]</span></code></a> and <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/attr.receive.html"><code class="docutils literal notranslate"><span class="pre">#[receive]</span></code></a>.</p>
<p>But in order to call them, we will need to first construct the arguments.
Luckily <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/index.html"><code class="docutils literal notranslate"><span class="pre">concordium-std</span></code></a> contains a submodule <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/index.html"><code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code></a> with
stubs for this, so let us first bring everything from the submodule into scope.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Now we can start adding tests to this module.</p>
</div>
<div class="section" id="testing-instantiation-of-a-piggy-bank">
<h2><span class="section-number">2.3. </span>Testing instantiation of a piggy bank<a class="headerlink" href="#testing-instantiation-of-a-piggy-bank" title="Permalink to this headline">Â¶</a></h2>
<p>The first test we add is to verify a piggy bank is set up with the correct
state.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="fm">todo!</span><span class="p">(</span><span class="s">&quot;Implement&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As mentioned above, we test the initialization by calling the function
<code class="docutils literal notranslate"><span class="pre">piggy_init</span></code> directly.
To construct its argument for, we use <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/type.InitContextTest.html"><code class="docutils literal notranslate"><span class="pre">InitContextTest</span></code></a>, which provides a
placeholder for the context.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InitContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Just as the name suggests, the test context is empty and if any of the getter
functions are called, it will make sure to fail the test, which should be fine
for now, since our piggy bank is not reading anything from the context.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As we will see later with the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/type.ReceiveContextTest.html"><code class="docutils literal notranslate"><span class="pre">ReceiveContextTest</span></code></a>, these placeholders have
setter functions, allowing us to partially specify the context.</p>
</div>
<p>Now we can call <code class="docutils literal notranslate"><span class="pre">piggy_init</span></code> and get a result containing the initial state.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">state_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>First of all we want the test to fail, if our contract did not result in an
initial state:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_result</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Contract initialization results in error.&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Next we assert the state is correctly set to <code class="docutils literal notranslate"><span class="pre">Intact</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">state</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s">&quot;Piggy bank state should be intact after initialization.&quot;</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Putting it all together we end up with the following test for initializing a
piggy bank:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// PiggyBank contract code up here</span>

<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InitContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_result</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Contract initialization results in error.&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;Piggy bank state should be intact after initialization.&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Run the test to check that it compiles and succeeds.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo <span class="nb">test</span>
</pre></div>
</div>
</div>
<div class="section" id="test-inserting-gtu-into-a-piggy-bank">
<h2><span class="section-number">2.4. </span>Test inserting GTU into a piggy bank<a class="headerlink" href="#test-inserting-gtu-into-a-piggy-bank" title="Permalink to this headline">Â¶</a></h2>
<p>Next we should test the different functions for interacting with a piggy bank.
This is done in the same way as initializing, except we use <code class="docutils literal notranslate"><span class="pre">ReceiveContextTest</span></code>
to construct the context.</p>
<p>To test <code class="docutils literal notranslate"><span class="pre">piggy_insert</span></code> we also need some amount of GTU and the current state
of our smart contract instance:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>When calling <code class="docutils literal notranslate"><span class="pre">piggy_insert</span></code> we get back a result with actions, instead of an
initial state as with <code class="docutils literal notranslate"><span class="pre">piggy_init</span></code>. But we will need to help the compiler
infer which type to use for the generic <code class="docutils literal notranslate"><span class="pre">A</span></code> implementing <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.HasActions.html"><code class="docutils literal notranslate"><span class="pre">HasActions</span></code></a>, so
we add the result type <code class="docutils literal notranslate"><span class="pre">ReceiveResult&lt;ActionsTree&gt;</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>For testing we can represent the actions as a simple tree structure
<a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/enum.ActionsTree.html"><code class="docutils literal notranslate"><span class="pre">ActionsTree</span></code></a>, making it easy to inspect.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">#[receive]</span></code> macro uses another representation of the actions, when building
the smart contract module. This representation depends on functions supplied
by the host environment and is therefore not suitable for unit tests.</p>
</div>
<p>Now we need to check if the function succeeded and verify the resulting state and actions.
In our case the state should remain intact and the function produce only the action for accepting the GTU.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Inserting GTU results in error.&quot;</span><span class="p">);</span><span class="w"></span>

<span class="fm">assert_eq!</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span><span class="w"> </span><span class="n">ActionsTree</span>::<span class="n">accept</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;No action should be produced.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Piggy bank state should still be intact.&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The second test becomes:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Inserting GTU results in error.&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span><span class="w"> </span><span class="n">ActionsTree</span>::<span class="n">accept</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;No action should be produced.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Piggy bank state should still be intact.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Again we should verify everything compiles and the tests succeeds using <code class="docutils literal notranslate"><span class="pre">cargo</span>
<span class="pre">test</span></code>.</p>
<p>Next we could add a test, checking that inserting into a piggy bank with state
<code class="docutils literal notranslate"><span class="pre">Smashed</span></code> results in an error, but we have been through everything needed to
do this, and we therefore leave as an exercise for the reader.</p>
</div>
<div class="section" id="test-smashing-a-piggy-bank">
<h2><span class="section-number">2.5. </span>Test smashing a piggy bank<a class="headerlink" href="#test-smashing-a-piggy-bank" title="Permalink to this headline">Â¶</a></h2>
<p>Testing <code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code> will follow the same pattern, but this time we will need
to populate the context, since this function uses the context for getting the
contract owner, the sender of the message triggering the function and the
balance of contract.</p>
<p>If we just supply the function with an empty context it will fail, so instead we
define the context as mutable:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>We create an <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/struct.AccountAddress.html"><code class="docutils literal notranslate"><span class="pre">AccountAddress</span></code></a> to represent the owner and use the setter
<code class="docutils literal notranslate"><span class="pre">set_owner</span></code> implemented on <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/type.ReceiveContextTest.html"><code class="docutils literal notranslate"><span class="pre">ReceiveContextTest</span></code></a>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span><span class="w"></span>
<span class="n">ctx</span><span class="p">.</span><span class="n">set_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice we created the account address using an array of 32 bytes, which is
how account addresses are represented on the Concordium blockchain.
These byte arrays can also be represented as a base58check encoding, but for
testing it is usually more convenient to specify addresses directly in bytes.</p>
</div>
<p>Next we set the sender to be the same address as the owner using <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/type.ReceiveContextTest.html#method.set_sender"><code class="docutils literal notranslate"><span class="pre">set_sender</span></code></a>.
Since the sender can be a contract instance as well, we must wrap the owner
address in the <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/enum.Address.html"><code class="docutils literal notranslate"><span class="pre">Address</span></code></a> type:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="n">ctx</span><span class="p">.</span><span class="n">set_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Lastly we will need to set the current balance of the piggy bank instance, using
<a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/test_infrastructure/type.ReceiveContextTest.html#method.set_self_balance"><code class="docutils literal notranslate"><span class="pre">set_self_balance</span></code></a>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="n">ctx</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Now that we have the test context setup, we call the contract function
<code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code> and inspect the resulting action tree and state just like we did
in the previous tests:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_smash_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Inserting GTU results in error.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span><span class="w"> </span><span class="n">ActionsTree</span>::<span class="n">simple_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Smashed</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Ensure everything compiles and the tests succeeds using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>.</p>
</div>
<div class="section" id="testing-cause-of-rejection">
<h2><span class="section-number">2.6. </span>Testing cause of rejection<a class="headerlink" href="#testing-cause-of-rejection" title="Permalink to this headline">Â¶</a></h2>
<p>We want to test that our piggy bank rejects in certain contexts, for example
when someone besides the owner of the smart contract tries to smash it.</p>
<p>The test should:</p>
<ul class="simple">
<li><p>Make a context where the sender and owner are two different accounts.</p></li>
<li><p>Set the state to be intact.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code>.</p></li>
<li><p>Check that the result is an error.</p></li>
</ul>
<p>The test could look like this:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]));</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">actions_result</span><span class="p">.</span><span class="n">is_err</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Contract is expected to fail.&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>One thing to notice is that the test is not ensuring <em>why</em> the contract
rejected, our piggy bank might reject for a wrong reason, and this would be a
bug.
This is probably fine for a simple smart contract like our piggy bank, but for a
smart contract with more complex logic and many reasons for rejecting, it would
be better if we tested this as well.</p>
<p>To solve this we introduce a <code class="docutils literal notranslate"><span class="pre">SmashError</span></code> enum , to represent the different
reasons for rejection:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(Debug, PartialEq, Eq, Reject)]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">SmashError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">NotOwner</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AlreadySmashed</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more information about custom errors and deriving <code class="docutils literal notranslate"><span class="pre">Reject</span></code>, see <a class="reference internal" href="../../guides/custom-errors.html#custom-errors"><span class="std std-ref">Return custom errors</span></a>.</p>
</div>
<p>To use this error type; the function <code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code> should return <code class="docutils literal notranslate"><span class="pre">Result&lt;A,</span>
<span class="pre">SmashError&gt;</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ReceiveResult&lt;A&gt;</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(contract = </span><span class="s">&quot;PiggyBank&quot;</span><span class="cp">, name = </span><span class="s">&quot;smash&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">piggy_smash</span><span class="o">&lt;</span><span class="n">A</span>: <span class="nc">HasActions</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">PiggyBankState</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="w">   </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>and we also have to supply the <code class="docutils literal notranslate"><span class="pre">ensure!</span></code> macros with a second argument, which is
the error to produce:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(contract = </span><span class="s">&quot;PiggyBank&quot;</span><span class="cp">, name = </span><span class="s">&quot;smash&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">piggy_smash</span><span class="o">&lt;</span><span class="n">A</span>: <span class="nc">HasActions</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">PiggyBankState</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">owner</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sender</span><span class="p">();</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="n">sender</span><span class="p">.</span><span class="n">matches_account</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">),</span><span class="w"> </span><span class="n">SmashError</span>::<span class="n">NotOwner</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span>::<span class="n">AlreadySmashed</span><span class="p">);</span><span class="w"></span>
</span>
<span class="w">    </span><span class="o">*</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Smashed</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">self_balance</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">A</span>::<span class="n">simple_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Since the return type have changed for the <code class="docutils literal notranslate"><span class="pre">piggy_smash</span></code> function, we have to
change the type in the tests as well:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_smash_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>We can now check which error was produced in the test:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]));</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect_err</span><span class="p">(</span><span class="s">&quot;Contract is expected to fail.&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span>::<span class="n">NotOwner</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Expected to fail with error NotOwner&quot;</span><span class="p">)</span><span class="w"></span>
</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>We leave it up to the reader to test, whether smashing a piggy bank, that have
already been smashed results in the correct error.</p>
</div>
<div class="section" id="compiling-and-running-tests-in-wasm">
<h2><span class="section-number">2.7. </span>Compiling and running tests in Wasm<a class="headerlink" href="#compiling-and-running-tests-in-wasm" title="Permalink to this headline">Â¶</a></h2>
<p>When running <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code> our contract module and tests are compiled targeting
your native platform, but on the Concordium blockchain a smart contract module
is in Wasm.
Therefore it is preferable to compile the tests targeting Wasm and run the tests
using a Wasm interpreter instead.
Lucky for us, the <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code> tool contains such an interpreter, and
it is the same interpreter shipped with the official nodes on the Concordium
blockchain.</p>
<p>Before we can run our tests in Wasm, we have to replace <code class="docutils literal notranslate"><span class="pre">#[cfg(test)]</span></code> at the
top of our test module with <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/attr.concordium_cfg_test.html"><code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code></a> and all the <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>
macros with <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/attr.concordium_test.html"><code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code></a>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// PiggyBank contract code up here</span>

<span class="hll"><span class="cp">#[concordium_cfg_test]</span><span class="w"></span>
</span><span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="cp">#[concordium_test]</span><span class="w"></span>
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="cp">#[concordium_test]</span><span class="w"></span>
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="cp">#[concordium_test]</span><span class="w"></span>
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">test_smash_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="cp">#[concordium_test]</span><span class="w"></span>
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>We will also need to modify our tests a bit. Usually a test in <a class="reference external" href="https://www.rust-lang.org/">Rust</a> is failed
by panicking with an error message, but when compiling to Wasm this error
message is lost.
Instead we need generate code reporting the error back to the host, who is
running the Wasm, and to do so, <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> provides replacements:</p>
<ul class="simple">
<li><p>A call to <code class="docutils literal notranslate"><span class="pre">panic!</span></code> should be replace with <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/macro.fail.html"><code class="docutils literal notranslate"><span class="pre">fail!</span></code></a>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">expect</span></code> and <code class="docutils literal notranslate"><span class="pre">expect_err</span></code> function should be replaced with
<a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.ExpectReport.html#tymethod.expect_report"><code class="docutils literal notranslate"><span class="pre">expect_report</span></code></a> and <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/trait.ExpectErrReport.html#tymethod.expect_err_report"><code class="docutils literal notranslate"><span class="pre">expect_err_report</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assert</span></code> and <code class="docutils literal notranslate"><span class="pre">assert_eq</span></code> should be replace with <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/macro.claim.html"><code class="docutils literal notranslate"><span class="pre">claim!</span></code></a> and <a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/macro.claim_eq.html"><code class="docutils literal notranslate"><span class="pre">claim_eq!</span></code></a>
respectively.</p></li>
</ul>
<p>All of these macros are wrappers, which behaves the same as their counterpart
except when we build our smart contract for testing in Wasm using
<code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>. This means we can still run tests for targeting native
using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// PiggyBank contract code up here</span>

<span class="cp">#[concordium_cfg_test]</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">use</span><span class="w"> </span><span class="n">test_infrastructure</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#[concordium_test]</span><span class="w"></span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">test_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InitContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">state_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>

<span class="hll"><span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_result</span><span class="p">.</span><span class="n">expect_report</span><span class="p">(</span><span class="s">&quot;Contract initialization failed.&quot;</span><span class="p">);</span><span class="w"></span>
</span>
<span class="hll"><span class="w">       </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
</span><span class="w">             </span><span class="n">state</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="s">&quot;Piggy bank state should be intact after initialization.&quot;</span><span class="w"></span>
<span class="w">       </span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="cp">#[concordium_test]</span><span class="w"></span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">test_insert_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="hll"><span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect_report</span><span class="p">(</span><span class="s">&quot;Inserting GTU results in error.&quot;</span><span class="p">);</span><span class="w"></span>
</span>
<span class="hll"><span class="w">       </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span><span class="w"> </span><span class="n">ActionsTree</span>::<span class="n">accept</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;No action should be produced.&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">       </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Piggy bank state should still be intact.&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="cp">#[concordium_test]</span><span class="w"></span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">test_smash_intact</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span><span class="w"></span>
<span class="w">       </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span><span class="w"></span>

<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="hll"><span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect_report</span><span class="p">(</span><span class="s">&quot;Inserting GTU results in error.&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">       </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span><span class="w"> </span><span class="n">ActionsTree</span>::<span class="n">simple_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">));</span><span class="w"></span>
</span><span class="hll"><span class="w">       </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Smashed</span><span class="p">);</span><span class="w"></span>
</span><span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="cp">#[concordium_test]</span><span class="w"></span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">test_smash_intact_not_owner</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReceiveContextTest</span>::<span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]);</span><span class="w"></span>
<span class="w">       </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">AccountAddress</span><span class="p">([</span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]));</span><span class="w"></span>
<span class="w">       </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Amount</span>::<span class="n">from_micro_gtu</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="n">ctx</span><span class="p">.</span><span class="n">set_self_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">);</span><span class="w"></span>

<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PiggyBankState</span>::<span class="n">Intact</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">actions_result</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ActionsTree</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">piggy_smash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="hll"><span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions_result</span><span class="p">.</span><span class="n">expect_err_report</span><span class="p">(</span><span class="s">&quot;Contract is expected to fail.&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">       </span><span class="n">claim_eq</span><span class="o">!</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">SmashError</span>::<span class="n">NotOwner</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Expected to fail with error NotOwner&quot;</span><span class="p">)</span><span class="w"></span>
</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Compiling and running the tests in Wasm can be done using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo concordium <span class="nb">test</span>
</pre></div>
</div>
<p>This will make a special test build of our smart contract module exporting all
of our tests as functions and it will then run each of these functions catching
the reported errors.</p>
</div>
<div class="section" id="simulating-the-piggy-bank">
<h2><span class="section-number">2.8. </span>Simulating the piggy bank<a class="headerlink" href="#simulating-the-piggy-bank" title="Permalink to this headline">Â¶</a></h2>
<p>So far the tests we have written are in <a class="reference external" href="https://www.rust-lang.org/">Rust</a> and have to be compiled alongside
the smart contract module in a test build, which is fine for unit testing, but
this test build is not the actual module that we intend to deploy on the
Concordium blockchain.</p>
<p>We should also test the smart contract wasm module meant for deployment, and we
can use the simulate feature of <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>. It takes a smart contract
wasm module and uses the Wasm interpreter to run a smart contract function in a
given context.</p>
<p>For more on how to do this: check out the guide <a class="reference internal" href="../../guides/local-simulate.html#local-simulate"><span class="std std-ref">Locally simulate contract functions</span></a>.</p>
</div>
<div class="section" id="support-feedback">
<h2><span class="section-number">2.9. </span>Support &amp; Feedback<a class="headerlink" href="#support-feedback" title="Permalink to this headline">Â¶</a></h2>
<p>If you have questions or feedback, join us on <a class="reference external" href="https://support.concordium.software/">Discourse</a>, or contact us at <a class="reference external" href="mailto:support&#37;&#52;&#48;concordium&#46;software">support<span>&#64;</span>concordium<span>&#46;</span>software</a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
<a href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img style="margin-bottom: 0.5em" src="../../../_static/cc-sa-by.png" />
</a>

    <p>
        &#169; Copyright 2021, Concordium Software ApS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: mainnet
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      <dd><a href="/en/testnet4/">testnet4</a></dd>
      <dd><a href="/en/mainnet/">mainnet</a></dd>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
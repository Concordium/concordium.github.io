



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Unit test a contract in Rust &mdash; Concordium  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/concordium-logo-no-text.svg"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Return custom errors" href="custom-errors.html" />
    <link rel="prev" title="Compile a Rust smart contract module" href="compile-module.html" />
<link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #34838C" >
          


          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/concordium-logo-testnet.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
<nav class="sidebar-top-menu">
    <a href="../../net/index.html" class="" ><i class="icon fa fa-connectdevelop"></i> Testnet</a>
    <a href="../index.html" class="active"> <i class="icon fa fa-file-o"></i> Smart Contracts </a>
</nav>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/introduction.html">Introduction to smart contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/contract-module.html">Smart contract modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/contract-instances.html">Smart contract instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/contract-schema.html">Smart contract schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/resource-accounting.html">Resource accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/develop-contracts.html">Developing smart contracts in Rust</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/piggy-bank/index.html">The piggy bank smart contract</a></li>
</ul>
<p class="caption"><span class="caption-text">Contract development guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup-tools.html">Install tools for development</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup-contract.html">Setting up a smart contract project</a></li>
<li class="toctree-l1"><a class="reference internal" href="compile-module.html">Compile a Rust smart contract module</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Unit test a contract in Rust</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#writing-unit-tests">Writing unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-tests-in-wasm">Running tests in Wasm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#support-feedback">Support &amp; Feedback</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="custom-errors.html">Return custom errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="local-simulate.html">Locally simulate contract functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-schema.html">Build a contract schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="no-std.html">Build using <code class="docutils literal notranslate"><span class="pre">no_std</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">On-chain guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="deploy-module.html">Deploy a smart contract module</a></li>
<li class="toctree-l1"><a class="reference internal" href="initialize-contract.html">Initialize a smart contract instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="interact-instance.html">Interact with a smart contract instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="inspect-instance.html">Inspect a smart contract instance</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references/schema-json.html">Schema JSON representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/simulate-context.html">Simulation contexts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/host-fns.html">Contract host functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/references-on-chain.html">References on-chain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/local-settings.html">Local settings</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Concordium/concordium-rust-smart-contracts">Rust contract examples (repo)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.rs/concordium-std/latest/concordium_std/">concordium-std</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Concordium</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Concordium Smart Contract Documentation</a> &raquo;</li>
        
      <li>Unit test a contract in Rust</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/Concordium/concordium.github.io/blob/testnet/source/smart-contracts/guides/unit-test-contract.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="unit-test-a-contract-in-rust">
<span id="unit-test-contract"></span><h1>Unit test a contract in Rust<a class="headerlink" href="#unit-test-a-contract-in-rust" title="Permalink to this headline">¶</a></h1>
<p>This guide will show you how to write unit tests for a smart contract written in
Rust.
For testing a smart contract Wasm module, see <a class="reference internal" href="local-simulate.html#local-simulate"><span class="std std-ref">Locally simulate contract functions</span></a>.</p>
<p>A smart contract in Rust is written as a library and we can unit test it like a
library by annotating functions with a <code class="docutils literal notranslate"><span class="pre">#[test]</span></code> attribute.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// contract code</span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">another_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Running the test can be done using <code class="docutils literal notranslate"><span class="pre">cargo</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo <span class="nb">test</span>
</pre></div>
</div>
<p>By default, this command compiles the contract and tests to machine code for
your local target (most likely <code class="docutils literal notranslate"><span class="pre">x86_64</span></code>), and runs them.
This kind of testing can be useful in initial development and for testing
functional correctness.
For comprehensive testing, it is important to involve the target platform, i.e.,
<cite>Wasm32</cite>.
There are a number of subtle differences between platforms, which can change the
behaviour of a contract.
One difference is regarding the size of pointers, where <cite>Wasm32</cite> uses four bytes
as opposed to eight, which is common for most platforms.</p>
<div class="section" id="writing-unit-tests">
<h2>Writing unit tests<a class="headerlink" href="#writing-unit-tests" title="Permalink to this headline">¶</a></h2>
<p>Unit tests typically follow a three-part structure in which you: set up some
state, run some unit of code, and make assertions about the state and output of
the code.</p>
<p>If the contract functions are written using <code class="docutils literal notranslate"><span class="pre">#[init(..)]</span></code> or
<code class="docutils literal notranslate"><span class="pre">#[receive(..)]</span></code>, we can test these functions directly in the unit test.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[init(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, payable, enable_logger)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">contract_init</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasInitContext</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">amount</span>: <span class="nc">Amount</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">logger</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasLogger</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">InitResult</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[receive(contract = </span><span class="s">&quot;my_contract&quot;</span><span class="cp">, name = </span><span class="s">&quot;my_receive&quot;</span><span class="cp">, payable, enable_logger)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">contract_receive</span><span class="o">&lt;</span><span class="n">A</span>: <span class="nc">HasActions</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">amount</span>: <span class="nc">Amount</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">logger</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasLogger</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReceiveResult</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Testing stubs for the function arguments can be found in a submodule of
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> called <code class="docutils literal notranslate"><span class="pre">test_infrastructure</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more information and examples see the crate documentation of
concordium-std.</p>
</div>
</div>
<div class="section" id="running-tests-in-wasm">
<h2>Running tests in Wasm<a class="headerlink" href="#running-tests-in-wasm" title="Permalink to this headline">¶</a></h2>
<p>Compiling the tests to native machine code is sufficient for most cases, but it
is also possible to compile the tests to Wasm and run them using the exact
interpreter that is used by the nodes.
This makes the test environment closer to the run environment on-chain and could
in some cases catch more bugs.</p>
<p>The development tool <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code> includes a test runner for Wasm, which
uses the same Wasm-interpreter as the one shipped in the Concordium nodes.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For a guide of how to install <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>, see <a class="reference internal" href="setup-tools.html#setup-tools"><span class="std std-ref">Install tools for development</span></a>.</p>
</div>
<p>The unit test have to be annotated with <code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">#[test]</span></code>, and we use <code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code> instead of <code class="docutils literal notranslate"><span class="pre">#[cfg(test)]</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// contract code</span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="cp">#[concordium_cfg_test]</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[concordium_test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[concordium_test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">another_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">#[concordium_test]</span></code> macro sets up our tests to be run in Wasm, when
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> is compiled with the <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> feature, and otherwise
falls back to behave just like <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>, meaning it is still possible to run
unit tests targeting native code using <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>.</p>
<p>Similarly the macro <code class="docutils literal notranslate"><span class="pre">#[concordium_cfg_test]</span></code> includes our module when build
<code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> with <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> otherwise behaves like <code class="docutils literal notranslate"><span class="pre">#[test]</span></code>,
allowing us to control when to include tests in the build.</p>
<p>Tests can now be build and run using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>cargo concordium <span class="nb">test</span>
</pre></div>
</div>
<p>This command compiles the tests for Wasm with the <code class="docutils literal notranslate"><span class="pre">wasm-test</span></code> feature enabled
for <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code> and uses the test runner from <code class="docutils literal notranslate"><span class="pre">cargo-concordium</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Error messages from <code class="docutils literal notranslate"><span class="pre">panic!</span></code>, and therefore also the different variations
of <code class="docutils literal notranslate"><span class="pre">assert!</span></code>, are <em>not</em> shown when compiling to Wasm.</p>
<p>Instead use <code class="docutils literal notranslate"><span class="pre">fail!</span></code> and the <code class="docutils literal notranslate"><span class="pre">claim!</span></code> variants to do assertions when
testing, as these reports back the error messages to the test runner <em>before</em>
failing the test.
Both are part of <code class="docutils literal notranslate"><span class="pre">concordium-std</span></code>.</p>
</div>
</div>
<div class="section" id="support-feedback">
<h2>Support &amp; Feedback<a class="headerlink" href="#support-feedback" title="Permalink to this headline">¶</a></h2>
<p>If you have questions or feedback, join us on <a class="reference external" href="https://support.concordium.software/">Discourse</a>, or contact us at <a class="reference external" href="mailto:support&#37;&#52;&#48;concordium&#46;software">support<span>&#64;</span>concordium<span>&#46;</span>software</a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
<a href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img style="margin-bottom: 0.5em" src="../../_static/cc-sa-by.png" />
</a>

    <p>
        &#169; Copyright 2021, Concordium Software ApS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: testnet
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      <dd><a href="/en/mainnet/">mainnet</a></dd>
      <dd><a href="/en/testnet/">testnet</a></dd>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TE81YY48VB"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

gtag('consent', 'default', { 'ad_storage': 'denied', 'analytics_storage': loadChoice() ? 'granted' : 'denied' });
gtag('js', new Date());
gtag('config', 'G-TE81YY48VB', {'anonymize_ip': true});

// Save the choice in a cookie
function storeChoice(granted) {
    document.cookie = "cookie-consent=" + granted
}

// Look for a cookie storing the previous choice of the user.
// Returns undefined if no choice was stored, otherwise a boolean for whether the
// user gave consent.
function loadChoice() {
    if (!document.cookie.includes("cookie-consent=")) {
        return undefined;
    }
    return document.cookie.includes("cookie-consent=true")
}

// Removes the cookie consent banner
function removeCookieConsentBanner() {
    document.getElementById("cookie-consent").remove()
}

// Called by the cookie consent banner if granted permission
function consentGranted() {
    storeChoice(true)
    gtag('consent', 'update', { 'ad_storage': 'denied', 'analytics_storage': 'granted' });
    removeCookieConsentBanner()
}

// Called by the cookie consent banner if denied permission
function consentDenied() {
    storeChoice(false)
    removeCookieConsentBanner()
}


</script>
<div id="cookie-consent" class="consent">
    <p>We use cookies to ensure that we give you the best experience on our website, but only if you grant us the permission</p>
    <button onclick="consentGranted()">Allow</button>
    <button onclick="consentDenied()">Disallow</button>
    <a href="https://concordium.com/privacy-policy/">Privacy policy</a>
</div>
<script>
    const stored = loadChoice();
    if (stored !== undefined) {
        removeCookieConsentBanner()
    }
</script>


</body>
</html>



<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fractionalized NFT smart contract &#8212; Concordium  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/tippy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="shortcut icon" href="../../_static/concordium-logo-no-text.svg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Build, deploy, and initialize the fractionalizer smart contract" href="sc-actions.html" />
    <link rel="prev" title="Fractionalized NFT tutorial" href="index.html" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" />

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    <style>
.navbar-brand img {
    max-height: 200px;
    width: auto;
}
</style>

<div>
    <a href="https://academy.concordium.software/">
        <img class="logo" src="../../_static/concordium-logo-dark.svg" />
    </a>
</div>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class=" collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <style>
  body {margin:0;}
  
  .navbar-menu {
    position: relative;
    margin-left: 190px;
    background: none;
  }
  
  .navbar-light {
      background: #ededed!important;
      box-shadow: none;
  }
  
  .navbar-menu a {
    float: left;
    display: inline;
    text-align: center;
    color: var(--font-color);
    font-size: 15px;
    font-family: 'IBM Plex Sans', 'Helvetica Neue', Arial, sans-serif;
  }
  
  /* Dropdown Button */
  .dropbtn {
    background: none;
    color: black;
    font-size: 16px;
    font-weight: 600;
    padding-left: 20px;
    padding-right: 20px;
    border: none;
    font-family: inherit; /* Important for vertical align on mobile phones */
    margin: 0; /* Important for vertical align on mobile phones */
  }
  
  /* The dropdown container */
  .dropdown {
      float: left;
    }
  
    /* Dropdown content (hidden by default) */
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
    }
  
    /* Links inside the dropdown */
    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
    }
  
    /* Show the dropdown menu on hover */
    .dropdown:hover .dropdown-content {
      display: block;
    }
  
  /* Large devices (laptops/desktops, 992px to 768px ) */
  @media only screen and (max-width: 1178px) {
    .navbar-menu {
      display: none;}
  
  }
  </style>
<div class="navbar-menu w3-hide-medium w3-hide-small">
  <div class="dropdown">
    <button class="dropbtn"><a href="../../intro.html">Introduction</a></button>
    <div class="dropdown-content">
      
    </div>
  </div>
  <div class="dropdown">
    <button class="dropbtn"><a href="../../beg-tutorials.html">Beginner</a></button>
  </div>
  <div class="dropdown">
    <button class="dropbtn"><a href="../../mid-tutorials.html">Intermediate</a></button>
  </div>
  <div class="dropdown">
    <button class="dropbtn"><a href="../../adv-tutorials.html">Advanced</a></button>
  </div>
  <div class="dropdown">
    <button class="dropbtn"><a href="https://docs.google.com/forms/d/1ks_oWIxbRoW6NGHHjwOGfaO4pVvZAD92me0ChbvzDZc/edit">Claim badge</a></button>
  </div>
  </div>
</div>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/Concordium" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="mailto:support@concordium.software" rel="noopener" target="_blank" title="Support"><span><i class="fas fa-envelope"></i></span>
            <label class="sr-only">Support</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://developer.concordium.software/en/mainnet/net/guides/developer-page.html#block-explorers" rel="noopener" target="_blank" title="Monitor"><span><i class="fas fa-chart-line"></i></span>
            <label class="sr-only">Monitor</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://support.concordium.software/latest" rel="noopener" target="_blank" title="Discourse"><span><i class="fab fa-discourse"></i></span>
            <label class="sr-only">Discourse</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://www.youtube.com/channel/UCPZc2CuB2jGbZjD_5zX7-1A" rel="noopener" target="_blank" title="YouTube"><span><i class="fab fa-youtube"></i></span>
            <label class="sr-only">YouTube</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://medium.com/concordium" rel="noopener" target="_blank" title="Medium"><span><i class="fab fa-medium"></i></span>
            <label class="sr-only">Medium</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://developer.concordium.software/en/mainnet/index.html" rel="noopener" target="_blank" title="Documentation"><span><i class="fas fa-book"></i></span>
            <label class="sr-only">Documentation</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Fractionalized NFT tutorial
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Fractionalized NFT smart contract
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sc-actions.html">
     Build, deploy, and initialize the fractionalizer smart contract
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mint.html">
     Mint fractionalized NFTs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="burn.html">
     Burn and unlock fractionalized NFTs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../nft-minting/index.html">
   NFT minting tutorial with Rust-SDK
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../nft-minting/smart-contract-template.html">
     Generate a smart contract with the Concordium VSCode extension
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../nft-minting/contract-interactions.html">
     Contract interactions with Concordium-Rust-SDK
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assignment-2/dapp-using-walletconnect.html">
   Assignment 2: dApp using WalletConnect
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#state-rs">
   State.rs
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#token-supply-helpers">
     Token supply helpers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#state-mint-function">
     State mint function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#state-burn-function">
     State burn function
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#params-rs">
   Params.rs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#error-rs">
   Error.rs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cis2-client-rs">
   cis2_client.rs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contract-rs">
   Contract.rs
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mint-function">
     Mint Function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#transfer-function">
     Transfer function
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/Concordium/concordium.github.io/edit/main/source/academy/tutorials/fractionalized-nft/smart-contract.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="fractionalized-nft-smart-contract">
<span id="fractionalized-nft-sc"></span><h1>Fractionalized NFT smart contract<a class="headerlink" href="#fractionalized-nft-smart-contract" title="Permalink to this headline">#</a></h1>
<p>The smart contract is organized slightly differently than usual for this tutorial. First, there will be a <strong>lib.rs</strong> which is basically the main function of your contract like the other programming languages. The compiler starts from this file to compile it. The second file will be the <strong>contract.rs</strong> which will be your primary CIS-2 contract that includes all the logic provided for the requirements. The <strong>State.rs</strong>, <strong>Params.rs</strong>, and <strong>Error.rs</strong> files have been kept separate just for demonstration purposes, meaning you can keep them all in your <strong>lib.rs</strong> file. Finally, you will have a <strong>cis2_client.rs</strong> file which will enable the master contract to do some operations on the CIS-2 token contract. One little reminder: there will be some additions to the CIS2-multi contract. You can check the particular contract <a class="reference external" href="https://github.com/Concordium/concordium-rust-smart-contracts/tree/main/examples/cis2-multi">in this link</a>.</p>
<div class="section" id="state-rs">
<h2>State.rs<a class="headerlink" href="#state-rs" title="Permalink to this headline">#</a></h2>
<p>Start with the <strong>state.rs</strong> file. As you already know from the previous tutorials, the state will keep the asset’s latest state. The contract has to have an initialization function to create an empty state in the beginning, which includes four maps such as <strong>state, tokens, token_supply, implementors, and collaterals</strong>. There is one addition which is the <strong>collaterals</strong>; practically, the tokens to be locked will be stored in this <code class="docutils literal notranslate"><span class="pre">StateMap&lt;CollateralKey,</span> <span class="pre">CollateralState,</span> <span class="pre">S&gt;</span></code>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="sd">/// The contract state,</span>
<span class="sd">///</span>
<span class="sd">/// Note: The specification does not specify how to structure the contract state</span>
<span class="sd">/// and this could be structured in a more space-efficient way.</span>
<span class="cp">#[derive(Serial, DeserialWithState, StateClone)]</span><span class="w"></span>
<span class="cp">#[concordium(state_parameter = </span><span class="s">&quot;S&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The state of addresses.</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">state</span>: <span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">AddressState</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// All of the token IDs</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">tokens</span>: <span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">MetadataUrl</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Map with tokenId and token amount for the supply</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">token_supply</span>: <span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">ContractTokenAmount</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">implementors</span>: <span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">StandardIdentifierOwned</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ContractAddress</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">collaterals</span>: <span class="nc">StateMap</span><span class="o">&lt;</span><span class="n">CollateralKey</span><span class="p">,</span><span class="w"> </span><span class="n">CollateralState</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>You need to create a new state variable for your collateralized token, in other words, the tokens to be locked. You will need to keep the token’s contract address, its ID, and who locked it which all are provided in the <code class="docutils literal notranslate"><span class="pre">CollateralKey</span></code> struct below. Then you need the token amounts for the total number of fractions and the new token IDs.</p>
<p>Basically, when someone sends the fraction token to this contract, you will assume that they want to burn that asset and you will burn it and the <code class="docutils literal notranslate"><span class="pre">new()</span></code> function will be invoked when someone wants to add new collateral to mint its fractions.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(Serial, Deserial, Clone, SchemaType, Copy)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CollateralKey</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">contract</span>: <span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nc">AccountAddress</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serial, Deserial, Clone, Copy, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CollateralState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">received_token_amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">minted_token_id</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">CollateralState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CollateralState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">received_token_amount</span>: <span class="nc">ContractTokenAmount</span>::<span class="n">from</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">minted_token_id</span>: <span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>There are five additions to the <strong>cis2-multi</strong> contract state functions for handling the collateral state. The first one is the <code class="docutils literal notranslate"><span class="pre">add_collateral()</span></code> function. It expects the <strong>token contract address</strong>, <strong>token_id</strong>, <strong>owner address</strong>, and the <strong>token amount</strong> to be locked.</p>
<p>The second one is <code class="docutils literal notranslate"><span class="pre">has_collateral()</span></code>, which similarly takes the <strong>token contract address</strong>, <strong>token_id</strong>, and <strong>owner address</strong> as input to create a key in the form of a <code class="docutils literal notranslate"><span class="pre">CollateralKey</span></code> struct to look into the <strong>StateMap</strong>. If someone has already collateralized the token, this will return <strong>true</strong> and you will use this to make sure that they will not be able to do it again.</p>
<p>The third one is <code class="docutils literal notranslate"><span class="pre">find_collateral()</span></code> which takes <strong>token_id (fraction)</strong> as a parameter and checks its existence in the minted tokens. If a token with that ID exists, it returns a clone of it.</p>
<p>The fourth one is <code class="docutils literal notranslate"><span class="pre">has_fractions()</span></code>. You will use this to check whether a token is already fractionalized into new ones. You don’t want to allow people to create more and more fractions when they lock their assets once.</p>
<p>The last one is <code class="docutils literal notranslate"><span class="pre">update_collateral_token()</span></code>. You will use this when you have locked the tokens while minting new fractions. Based on the amount of fractions, it will update the state with the new tokens.</p>
<p>One important note here is that you can lock a semi-fungible token technically with this example. If you would like to limit it you can adjust it simply by checking the amount.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_collateral</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">contract</span>: <span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">owner</span>: <span class="nc">AccountAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">received_token_amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollateralKey</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">collaterals</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CollateralState</span>::<span class="n">new</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">cs</span><span class="p">.</span><span class="n">received_token_amount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">received_token_amount</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">collaterals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">cs</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">has_collateral</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">contract</span>: <span class="kp">&amp;</span><span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">owner</span>: <span class="kp">&amp;</span><span class="nc">AccountAddress</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollateralKey</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract</span>: <span class="o">*</span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">token_id</span>: <span class="o">*</span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">owner</span>: <span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">collaterals</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">).</span><span class="n">is_some</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">find_collateral</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="p">(</span><span class="n">CollateralKey</span><span class="p">,</span><span class="w"> </span><span class="n">ContractTokenAmount</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">collaterals</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="mf">1.</span><span class="n">minted_token_id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">eq</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="mf">0.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="mf">1.</span><span class="n">received_token_amount</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">continue</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">None</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">has_fraction</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">contract</span>: <span class="kp">&amp;</span><span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">owner</span>: <span class="kp">&amp;</span><span class="nc">AccountAddress</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollateralKey</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract</span>: <span class="o">*</span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">token_id</span>: <span class="o">*</span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">owner</span>: <span class="o">*</span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">collaterals</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">minted_token_id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_collateral_token</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">contract</span>: <span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">owner</span>: <span class="nc">AccountAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">minted_token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ContractResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollateralKey</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">collaterals</span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Entry</span>::<span class="n">Vacant</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bail</span><span class="o">!</span><span class="p">(</span><span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">InvalidCollateral</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">Entry</span>::<span class="n">Occupied</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">minted_token_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">minted_token_id</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="token-supply-helpers">
<h3>Token supply helpers<a class="headerlink" href="#token-supply-helpers" title="Permalink to this headline">#</a></h3>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">increase_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">curr_supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="bp">self</span><span class="p">.</span><span class="n">token_supply</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">curr_supply</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">decrease_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">curr_supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">remaining_supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_supply</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">remaining_supply</span><span class="p">.</span><span class="n">cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ContractTokenAmount</span>::<span class="n">from</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="n">is_eq</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="bp">self</span><span class="p">.</span><span class="n">token_supply</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="bp">self</span><span class="p">.</span><span class="n">token_supply</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">curr_supply</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_supply</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="nc">ContractTokenId</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ContractTokenAmount</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">token_supply</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nb">Some</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ContractTokenAmount</span>::<span class="n">from</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="state-mint-function">
<h3>State mint function<a class="headerlink" href="#state-mint-function" title="Permalink to this headline">#</a></h3>
<p>There is only one addition to the existing <code class="docutils literal notranslate"><span class="pre">mint()</span></code> function in the cis2-multi contract, which is the <code class="docutils literal notranslate"><span class="pre">increase_supply()</span></code> when a token is minted.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="sd">/// Mints an amount of tokens with a given address as the owner.</span>
<span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mint</span><span class="p">(</span><span class="w"></span>
<span class="w">     </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">token_metadata</span>: <span class="kp">&amp;</span><span class="nc">TokenMetadata</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">owner</span>: <span class="kp">&amp;</span><span class="nc">Address</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">state_builder</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">StateBuilder</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">tokens</span><span class="w"></span>
<span class="w">             </span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">*</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">token_metadata</span><span class="p">.</span><span class="n">to_metadata_url</span><span class="p">());</span><span class="w"></span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">owner_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">             </span><span class="p">.</span><span class="n">state</span><span class="w"></span>
<span class="w">             </span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="o">*</span><span class="n">owner</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="p">.</span><span class="n">or_insert_with</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">AddressState</span>::<span class="n">empty</span><span class="p">(</span><span class="n">state_builder</span><span class="p">));</span><span class="w"></span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">owner_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">owner_state</span><span class="p">.</span><span class="n">balances</span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="o">*</span><span class="n">token_id</span><span class="p">).</span><span class="n">or_insert</span><span class="p">(</span><span class="mf">0.</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">         </span><span class="o">*</span><span class="n">owner_balance</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="bp">self</span><span class="p">.</span><span class="n">increase_supply</span><span class="p">(</span><span class="o">*</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="state-burn-function">
<h3>State burn function<a class="headerlink" href="#state-burn-function" title="Permalink to this headline">#</a></h3>
<p>You need to add a <code class="docutils literal notranslate"><span class="pre">burn()</span></code> function to the state so that you will be able to burn the fractions. An example is shown below. You will use the <code class="docutils literal notranslate"><span class="pre">decrease_supply()</span></code> function to update the state when you burn something.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">burn</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">owner</span>: <span class="kp">&amp;</span><span class="nc">Address</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ContractResult</span><span class="o">&lt;</span><span class="n">ContractTokenAmount</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">address_state</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">address_state</span><span class="p">.</span><span class="n">balances</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">b</span><span class="p">.</span><span class="n">cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amount</span><span class="p">).</span><span class="n">is_ge</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">NoBalanceToBurn</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">);</span><span class="w"></span>

<span class="w">                    </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nb">Ok</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">NoBalanceToBurn</span><span class="p">)),</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">NoBalanceToBurn</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">decrease_supply</span><span class="p">(</span><span class="o">*</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="params-rs">
<h2>Params.rs<a class="headerlink" href="#params-rs" title="Permalink to this headline">#</a></h2>
<p>In this file, you will keep the parameter structs and some implementation for them to mint, for metadata operations, and to view. They are almost identical to the <strong>cis2-multi</strong> parameters with some additions for collaterals.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">concordium_cis2</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">convert</span>::<span class="n">TryInto</span><span class="p">;</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span>::<span class="p">{</span><span class="n">CollateralKey</span><span class="p">,</span><span class="w"> </span><span class="n">CollateralState</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">ContractTokenAmount</span><span class="p">,</span><span class="w"> </span><span class="n">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cp">#[derive(Serial, Deserial, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenMintParams</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">metadata</span>: <span class="nc">TokenMetadata</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">amount</span>: <span class="nc">ContractTokenAmount</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">contract</span>: <span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_id</span>: <span class="nc">ContractTokenId</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// The parameter for the contract function `mint` which mints a number of</span>
<span class="sd">/// token types and/or amounts of tokens to a given address.</span>
<span class="cp">#[derive(Serial, Deserial, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MintParams</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Owner of the newly minted tokens.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nc">Address</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// A collection of tokens to mint.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tokens</span>: <span class="nc">collections</span>::<span class="n">BTreeMap</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">TokenMintParams</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// The parameter type for the contract function `setImplementors`.</span>
<span class="sd">/// Takes a standard identifier and a list of contract addresses providing</span>
<span class="sd">/// implementations of this standard.</span>
<span class="cp">#[derive(Debug, Serialize, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SetImplementorsParams</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The identifier for the standard.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">id</span>: <span class="nc">StandardIdentifierOwned</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The addresses of the implementors of the standard.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">implementors</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ContractAddress</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Debug, Serialize, Clone, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenMetadata</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The URL following the specification RFC1738.</span>
<span class="w">    </span><span class="cp">#[concordium(size_length = 2)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">url</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// A optional hash of the content.</span>
<span class="w">    </span><span class="cp">#[concordium(size_length = 2)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">hash</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">TokenMetadata</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_hash_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">hex</span>::<span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hash</span><span class="p">.</span><span class="n">to_owned</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">as_slice</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">slice</span><span class="p">.</span><span class="n">try_into</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">array</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">array</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">to_metadata_url</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">MetadataUrl</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">MetadataUrl</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">url</span>: <span class="nc">self</span><span class="p">.</span><span class="n">url</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">hash</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_hash_bytes</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ViewAddressState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">balances</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">ContractTokenAmount</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">operators</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ViewState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">ViewAddressState</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tokens</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">collaterals</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">CollateralKey</span><span class="p">,</span><span class="w"> </span><span class="n">CollateralState</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Parameter type for the CIS-2 function `balanceOf` specialized to the subset</span>
<span class="sd">/// of TokenIDs used by this contract.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">ContractBalanceOfQueryParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BalanceOfQueryParams</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="sd">/// Response type for the CIS-2 function `balanceOf` specialized to the subset</span>
<span class="sd">/// of TokenAmounts used by this contract.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">ContractBalanceOfQueryResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BalanceOfQueryResponse</span><span class="o">&lt;</span><span class="n">ContractTokenAmount</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">TransferParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransferParams</span><span class="o">&lt;</span><span class="n">ContractTokenId</span><span class="p">,</span><span class="w"> </span><span class="n">ContractTokenAmount</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="error-rs">
<h2>Error.rs<a class="headerlink" href="#error-rs" title="Permalink to this headline">#</a></h2>
<p>You will implement custom errors for this project like the ones below where the last six errors are custom errors. For more information about custom errors in Concordium smart contracts, see <a class="reference internal" href="../../custom-errors.html#custom-errors"><span class="std std-ref">Custom errors</span></a>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">CustomContractError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Failed parsing the parameter.</span>
<span class="w">    </span><span class="cp">#[from(ParseError)]</span><span class="w"></span>
<span class="w">    </span><span class="n">ParseParams</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Failed logging: Log is full.</span>
<span class="w">    </span><span class="n">LogFull</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Failed logging: Log is malformed.</span>
<span class="w">    </span><span class="n">LogMalformed</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Invalid contract name.</span>
<span class="w">    </span><span class="n">InvalidContractName</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Only a smart contract can call this function.</span>
<span class="w">    </span><span class="n">ContractOnly</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Failed to invoke a contract.</span>
<span class="w">    </span><span class="n">InvokeContractError</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Unique tokenID</span>
<span class="w">    </span><span class="n">TokenAlreadyMinted</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Cant be collateralized</span>
<span class="w">    </span><span class="n">InvalidCollateral</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Same collateral ID twice</span>
<span class="w">    </span><span class="n">AlreadyCollateralized</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Cant burn</span>
<span class="w">    </span><span class="n">NoBalanceToBurn</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Contracts are not allowed</span>
<span class="w">    </span><span class="n">AccountsOnly</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Cant call another CIS-2 contract</span>
<span class="w">    </span><span class="n">Cis2ClientError</span><span class="p">(</span><span class="n">Cis2ClientError</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="cis2-client-rs">
<h2>cis2_client.rs<a class="headerlink" href="#cis2-client-rs" title="Permalink to this headline">#</a></h2>
<p>In order to call a contract from another smart contract you need to implement a relay layer which is the <strong>cis2_client.rs</strong>. It implements the transfer function. You will transfer the asset back to the original owner when all fractions are burned. In order to do that, you need to implement this client that will allow you to call the <code class="docutils literal notranslate"><span class="pre">transfer()</span></code> function in the NFT contract. Please remember that you should transfer it using the contract that minted the original token in the first place.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="sd">//! CIS2 client is the intermediatory layer between fractionalizer contract and CIS2 contract.</span>
<span class="sd">//!</span>
<span class="sd">//! # Description</span>
<span class="sd">//! It allows Fractionalizer contract to abstract away logic of calling CIS2 contract for the following methods</span>
<span class="sd">//! - `transfer` : Calls [`transfer`](https://proposals.concordium.software/CIS/cis-2.html#transfer)</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">vec</span><span class="p">;</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">concordium_cis2</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">concordium_std</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">state</span>::<span class="n">State</span><span class="p">;</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TRANSFER_ENTRYPOINT_NAME</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;transfer&quot;</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Debug, PartialEq, Eq, Reject, SchemaType)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Cis2ClientError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">InvokeContractError</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ParseParams</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Cis2Client</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Cis2Client</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">transfer</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">        </span><span class="n">S</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">T</span>: <span class="nc">IsTokenId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Clone</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span>: <span class="nc">IsTokenAmount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Clone</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ops</span>::<span class="n">Sub</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">nft_contract_address</span>: <span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">amount</span>: <span class="nc">A</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">from</span>: <span class="nc">Address</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">to</span>: <span class="nc">Receiver</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Cis2ClientError</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span>: <span class="nc">IsTokenAmount</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransferParams</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Transfer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">from</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">data</span>: <span class="nc">AdditionalData</span>::<span class="n">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">to</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}]);</span><span class="w"></span>

<span class="w">        </span><span class="n">Cis2Client</span>::<span class="n">invoke_contract_read_only</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">host</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">nft_contract_address</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">TRANSFER_ENTRYPOINT_NAME</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">invoke_contract_read_only</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="p">,</span><span class="w"> </span><span class="n">R</span>: <span class="nc">Deserial</span><span class="p">,</span><span class="w"> </span><span class="n">P</span>: <span class="nc">Serial</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">contract_address</span>: <span class="kp">&amp;</span><span class="nc">ContractAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">entrypoint_name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">params</span>: <span class="kp">&amp;</span><span class="nc">P</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">Cis2ClientError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">invoke_contract_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">invoke_contract_read_only</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">contract_address</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">params</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">EntrypointName</span>::<span class="n">new</span><span class="p">(</span><span class="n">entrypoint_name</span><span class="p">).</span><span class="n">unwrap_abort</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">Amount</span>::<span class="n">from_ccd</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_e</span><span class="o">|</span><span class="w"> </span><span class="n">Cis2ClientError</span>::<span class="n">InvokeContractError</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">invoke_contract_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">invoke_contract_result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Result</span>::<span class="nb">Err</span><span class="p">(</span><span class="n">Cis2ClientError</span>::<span class="n">InvokeContractError</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">parsed_res</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">R</span>::<span class="n">deserial</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">invoke_contract_res</span><span class="p">).</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_e</span><span class="o">|</span><span class="w"> </span><span class="n">Cis2ClientError</span>::<span class="n">ParseParams</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">parsed_res</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="contract-rs">
<h2>Contract.rs<a class="headerlink" href="#contract-rs" title="Permalink to this headline">#</a></h2>
<p>Finally, you need modifications for the fractionalization of NFTs in the contract functions. There are two major changes in the <code class="docutils literal notranslate"><span class="pre">contract_mint()</span></code> and <code class="docutils literal notranslate"><span class="pre">contract_transfer()</span></code> functions, which are described below. The full code is shared at the end of the tutorial.</p>
<div class="section" id="mint-function">
<h3>Mint Function<a class="headerlink" href="#mint-function" title="Permalink to this headline">#</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">contract_mint()</span></code> function, there are three additions.</p>
<p>First, you want to make sure that only accounts can lock and fractionalize the NFTs. You can see the <code class="docutils literal notranslate"><span class="pre">match</span></code> statement below that performs this particular control.</p>
<p>Second, it should be impossible to mint new fractions if the collateral is not locked first. So, you need to ensure that the token exists in the collateral list. The <code class="docutils literal notranslate"><span class="pre">ensure!()</span></code> statement checks this, and if violated, throws an <code class="docutils literal notranslate"><span class="pre">InvalidCollateral</span></code> custom error.</p>
<p>As a final addition to the <code class="docutils literal notranslate"><span class="pre">mint()</span></code> function, you need to update the state when a token is minted. Basically, you are storing which token from which contract is locked, which token on this contract is minted, and who is the owner. See the usage of the <code class="docutils literal notranslate"><span class="pre">update_collateral_token()</span></code> function below.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(</span>
<span class="cp">    contract = </span><span class="s">&quot;CIS2-Fractionalizer&quot;</span><span class="cp">,</span>
<span class="cp">    name = </span><span class="s">&quot;mint&quot;</span><span class="cp">,</span>
<span class="cp">    parameter = </span><span class="s">&quot;MintParams&quot;</span><span class="cp">,</span>
<span class="cp">    error = </span><span class="s">&quot;ContractError&quot;</span><span class="cp">,</span>
<span class="cp">    enable_logger,</span>
<span class="cp">    mutable</span>
<span class="cp">)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">contract_mint</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">logger</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasLogger</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ContractResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sender</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Address</span>::<span class="n">Account</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Address</span>::<span class="n">Contract</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bail</span><span class="o">!</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">AccountsOnly</span><span class="p">.</span><span class="n">into</span><span class="p">()),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Parse the parameter.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span>: <span class="nc">MintParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">parameter_cursor</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">state_and_builder</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">token_info</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">tokens</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="n">contains_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">ContractError</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">TokenAlreadyMinted</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="n">has_collateral</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_info</span><span class="p">.</span><span class="n">contract</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">token_info</span><span class="p">.</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sender</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">concordium_cis2</span>::<span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">InvalidCollateral</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// create a fraction only for once for a token</span>
<span class="w">        </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">has_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_info</span><span class="p">.</span><span class="n">contract</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">token_info</span><span class="p">.</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sender</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">is_none</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">concordium_cis2</span>::<span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">AlreadyCollateralized</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Mint the token in the state.</span>
<span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">mint</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">token_info</span><span class="p">.</span><span class="n">metadata</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">token_info</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">params</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">builder</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">update_collateral_token</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">token_info</span><span class="p">.</span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">token_info</span><span class="p">.</span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">sender</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Event for minted token.</span>
<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Cis2Event</span>::<span class="n">Mint</span><span class="p">(</span><span class="n">MintEvent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span>: <span class="nc">token_info</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">owner</span>: <span class="nc">params</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Metadata URL for the token.</span>
<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Cis2Event</span>::<span class="n">TokenMetadata</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">ContractTokenAmount</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">TokenMetadataEvent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">metadata_url</span>: <span class="nc">token_info</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">to_metadata_url</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="transfer-function">
<h3>Transfer function<a class="headerlink" href="#transfer-function" title="Permalink to this headline">#</a></h3>
<p>You are about to finalize our contract development after one final step which is the <code class="docutils literal notranslate"><span class="pre">contract_transfer()</span></code> function. Basically, when you want to send your tokens to another address, you will invoke this function. In addition to that, you want to combine the burning process into this function.</p>
<p>According to this logic, when you transfer the fractions (tokens minted on this contract) back to the contract, it assumes you want to burn them. You need to be the owner of the asset when calling it. After you ensure that you are authorized (meaning have some tokens), then it checks that you want to send those tokens to the contract itself. The next step is calling the state’s <code class="docutils literal notranslate"><span class="pre">burn()</span></code> function which will reduce the token amount from your balance and the state’s total supply followed by emitting a <code class="docutils literal notranslate"><span class="pre">BurnEvent</span></code>. Note that when you call the <code class="docutils literal notranslate"><span class="pre">burn()</span></code> function, you need to emit the <code class="docutils literal notranslate"><span class="pre">BurnEvent</span></code>. For more detail, check the <a class="reference external" href="https://proposals.concordium.software/CIS/cis-2.html#cis-2-concordium-token-standard-2">CIS-2 standard documentation</a>.</p>
<p>The state’s <code class="docutils literal notranslate"><span class="pre">burn()</span></code> function will return the <code class="docutils literal notranslate"><span class="pre">remaining_amount</span></code>. If this amount is 0 then you can say that this should be unlocked now as there is no need for the collateral. At this point, you need a client to communicate with this CIS-2 token (the one that was locked as collateral in the beginning) smart contract to invoke the <code class="docutils literal notranslate"><span class="pre">transfer</span></code> function. Basically, your contract will be transferring the asset back to the owner by getting their address from the state’s <code class="docutils literal notranslate"><span class="pre">CollateralKey</span></code> struct using the <code class="docutils literal notranslate"><span class="pre">token_id</span></code>.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">else</span></code> statement, you are just transferring a token to someone else, so this part is identical to the cis2-multi contract’s <code class="docutils literal notranslate"><span class="pre">transfer()</span></code> function.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[receive(</span>
<span class="cp">    contract = </span><span class="s">&quot;CIS2-Fractionalizer&quot;</span><span class="cp">,</span>
<span class="cp">    name = </span><span class="s">&quot;transfer&quot;</span><span class="cp">,</span>
<span class="cp">    parameter = </span><span class="s">&quot;TransferParameter&quot;</span><span class="cp">,</span>
<span class="cp">    error = </span><span class="s">&quot;ContractError&quot;</span><span class="cp">,</span>
<span class="cp">    enable_logger,</span>
<span class="cp">    mutable</span>
<span class="cp">)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">contract_transfer</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">HasStateApi</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">HasReceiveContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">host</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasHost</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StateApiType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">logger</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">HasLogger</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ContractResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Parse the parameter.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">TransferParams</span><span class="p">(</span><span class="n">transfers</span><span class="p">)</span>: <span class="nc">TransferParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">parameter_cursor</span><span class="p">().</span><span class="n">get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Get the sender who invoked this contract function.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sender</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">Transfer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">from</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">to</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">data</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">transfers</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">state_and_builder</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Authenticate the sender for this transfer</span>
<span class="w">        </span><span class="n">ensure</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">from</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">is_operator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">from</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">ContractError</span>::<span class="n">Unauthorized</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">to</span><span class="p">.</span><span class="n">address</span><span class="p">().</span><span class="n">matches_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">self_address</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// tokens are being transferred to self</span>
<span class="w">            </span><span class="c1">// burn the tokens</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">remaining_amount</span>: <span class="nc">ContractTokenAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">burn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">from</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="c1">// log burn event</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Cis2Event</span>::<span class="n">Burn</span><span class="p">(</span><span class="n">BurnEvent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">owner</span>: <span class="nc">from</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">}))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Check of there is any remaining amount</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">remaining_amount</span><span class="p">.</span><span class="n">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ContractTokenAmount</span>::<span class="n">from</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Everything has been burned</span>
<span class="w">                </span><span class="c1">// Transfer collateral back to the original owner</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">collateral_key</span><span class="p">,</span><span class="w"> </span><span class="n">collateral_amount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">find_collateral</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="n">Cis2Error</span>::<span class="n">Custom</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">InvalidCollateral</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="c1">// Return back the collateral</span>
<span class="w">                </span><span class="n">Cis2Client</span>::<span class="n">transfer</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">host</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">collateral_key</span><span class="p">.</span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">collateral_key</span><span class="p">.</span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">collateral_amount</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">concordium_std</span>::<span class="n">Address</span>::<span class="n">Contract</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">self_address</span><span class="p">()),</span><span class="w"></span>
<span class="w">                    </span><span class="n">concordium_cis2</span>::<span class="n">Receiver</span>::<span class="n">Account</span><span class="p">(</span><span class="n">collateral_key</span><span class="p">.</span><span class="n">owner</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="n">CustomContractError</span>::<span class="n">Cis2ClientError</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">to_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">.</span><span class="n">address</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Tokens are being transferred to another address</span>
<span class="w">            </span><span class="c1">// Update the contract state</span>
<span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="n">transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to_address</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Log transfer event</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Cis2Event</span>::<span class="n">Transfer</span><span class="p">(</span><span class="n">TransferEvent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">from</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">to</span>: <span class="nc">to_address</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">}))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="c1">// If the receiver is a contract we invoke it.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Receiver</span>::<span class="n">Contract</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">entrypoint_name</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnReceivingCis2Params</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">token_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">from</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">data</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>
<span class="w">                </span><span class="n">host</span><span class="p">.</span><span class="n">invoke_contract</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">parameter</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">entrypoint_name</span><span class="p">.</span><span class="n">as_entrypoint_name</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">Amount</span>::<span class="n">zero</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Fractionalized NFT tutorial</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="sc-actions.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Build, deploy, and initialize the fractionalizer smart contract</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>

  <style>
    .cc {
      position: relative;
      bottom: 0%;
      left: 0%;
    }

    .cc a {
      display: inline-block;
      text-align: left;
      padding: 16px;
      color: black;
      font-size: 8px;
    }
</style>

<div class="cc">
  <a href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img src="../../_static/cc-sa-by.png" />  Copyright 2021 - 2023, Concordium Software ApS
  </a>
</div>
  <div id="cookie-consent" class="consent">
    <p>This website only aggregates and analyzes the actions you take here if you allow cookies. If you do not allow cookies, it protects your privacy, but also prevents the owner from learning from your actions and creating a better experience for you and other users.</p><p>Note that if you opt in and you clear your cookies, delete the opt-in cookie, or if you change computers or Web browsers, you will need to perform the opt-in procedure again.</p>
    <button onclick="consentGranted()">Allow</button>
    <button onclick="consentDenied()">Decline</button>
    <a href="https://concordium.com/privacy-policy/">Privacy policy</a>
</div>

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];

// Save the choice in a cookie
function storeChoice(granted) {
  document.cookie = "cookie-consent=" + granted
}

// Look for a cookie storing the previous choice of the user.
// Returns undefined if no choice was stored, otherwise a boolean for whether the
// user gave consent.
function loadChoice() {
  if (!document.cookie.includes("cookie-consent=")) {
      return undefined;
  }
  return document.cookie.includes("cookie-consent=true")
}

// Removes the cookie consent banner
function removeCookieConsentBanner() {
  document.getElementById("cookie-consent").remove()
}

// Called by the cookie consent banner if granted permission
function consentGranted() {
  storeChoice(true)
  _paq.push(['setCookieConsentGiven']);
  removeCookieConsentBanner()
}

// Called by the cookie consent banner if denied permission
function consentDenied() {
  storeChoice(true)
  removeCookieConsentBanner()
}

const stored = loadChoice();
if (stored) {
 consentGranted()
}

_paq.push(['requireCookieConsent']);
/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
_paq.push(['trackPageView']);
_paq.push(['enableLinkTracking']);

(function() {
    var u="https://concordium.matomo.cloud/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '2']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src='//cdn.matomo.cloud/concordium.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
  })();

  // remember tracking consent was given for all subsequent page views and visits
_paq.push(['rememberCookieConsentGiven']);

</script>

  </body>
</html>